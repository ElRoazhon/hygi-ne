<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>eHygiène - So'Chris</title>
    
    <!-- 1. IDENTITÉ DE L'APPLICATION ET LOGO (Solution "En Dur") -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEyMCIgZmlsbD0iIzE2YTM0YSIvPjxwYXRoIGQ9Ik0xNTAgMjYwIEwyMjAgMzMwIEwzNzAgMTgwIiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjYwIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz48L3N2Zz4=">
    <link rel="shortcut icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEyMCIgZmlsbD0iIzE2YTM0YSIvPjxwYXRoIGQ9Ik0xNTAgMjYwIEwyMjAgMzMwIEwzNzAgMTgwIiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjYwIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz48L3N2Zz4=">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEyMCIgZmlsbD0iIzE2YTM0YSIvPjxwYXRoIGQ9Ik0xNTAgMjYwIEwyMjAgMzMwIEwzNzAgMTgwIiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjYwIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz48L3N2Zz4=">

    <!-- MANIFESTE DIRECT -->
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiZUh5Z2nDqG5lIFNvJ0NocmlzIiwic2hvcnRfbmFtZSI6IlNvJ0NocmlzIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmMGZkZjQiLCJ0aGVtZV9jb2xvciI6IiMxNmEzNGEiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1M015NXZjbWN2TWpBd01DOXpZGGRpSUhabFpXZENiM2c5SWpBd01DQTFNVElnT1RFeUlqNDhjbVZqZENCM2FXUjBhRDBpTlRFeUlpQm9aV2xuYUhROUlqVXhNaUlnY25nOUlqRXlNQ0lnWm1sc2JEMGlJakUyYVRNMFlTSXZQang4Y0dGMGFDQmtQV0lrTVRVd01qWXdJRXd5TWpBZ016TXdJRXd6TnpBZ01UZ3dJaVdtYVd4c1BTSnViMjVsSWlCemRISnZhMlU5SW5kb2FYUmxJaUJ6ZEhKdmEyVXRkMmxrZEdoOUlqWXdJaUJ6ZEhKdmEyVXRiR2x1WldOaGVEMGljbTkxYm1RaUlITjBjbTlyWlMxc2FXNXFiaM0wSWlKeWIzVnVaQ0kvUGp3OEwzTjJaejQ9Iiwic2l6ZXMiOiI1MTJ4NTEyIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwiLCJwdXJwb3NlIjoiYW55IG1hc2thYmxlIn1dfQ==">

    <!-- MÉTADONNÉES -->
    <meta name="apple-mobile-web-app-title" content="So'Chris">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#16a34a">

    <!-- CHARGEMENT DES OUTILS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- OUTILS POUR ZIP (Export Photos) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <!-- FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, query, where, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- CONFIGURATION ---
        let firebaseConfig;
        let appId;
        let initialAuthToken = null;

        try {
            firebaseConfig = JSON.parse(__firebase_config);
            appId = __app_id;
            if (typeof __initial_auth_token !== 'undefined') {
                initialAuthToken = __initial_auth_token;
            }
        } catch (e) {
            console.log("Mode Production (Clés Utilisateur)");
            firebaseConfig = {
                apiKey: "AIzaSyCoMV_kNz-eI1JlLp33h0iJ4MZR7NnoI-w",
                authDomain: "epack-hygiene-99e64.firebaseapp.com",
                projectId: "epack-hygiene-99e64",
                storageBucket: "epack-hygiene-99e64.firebasestorage.app",
                messagingSenderId: "917463324646",
                appId: "1:917463324646:web:14856a7207be0353aca827"
            };
            appId = 'epack-prod-data'; 
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app); 

        window.db = db;
        window.auth = auth;
        window.storage = storage; 
        window.appId = appId;
        window.initialAuthToken = initialAuthToken; 
        
        window.collection = collection;
        window.addDoc = addDoc;
        window.onSnapshot = onSnapshot;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.setDoc = setDoc;
        
        window.signInAnonymously = signInAnonymously;
        window.signInWithCustomToken = signInWithCustomToken;
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged;

        window.ref = ref;
        window.uploadBytes = uploadBytes;
        window.getDownloadURL = getDownloadURL;
    </script>

    <style>
        body { -webkit-tap-highlight-color: transparent; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .fade-in-element { animation: fadeIn 0.3s ease-out; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .active-press:active { transform: scale(0.95); background-color: #f3f4f6; }
        @keyframes scan { 0% { top: 10%; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 90%; opacity: 0; } }
        .scan-line { position: absolute; left: 10%; right: 10%; height: 2px; background: #4ade80; box-shadow: 0 0 10px #4ade80; animation: scan 2s linear infinite; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
    </style>
</head>
<body class="bg-green-50 text-gray-900 h-screen w-screen overflow-hidden select-none font-sans">

    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const compressImage = (base64Str, maxWidth = 800, quality = 0.6) => {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = base64Str;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    if (width > height) { if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } } 
                    else { if (height > maxWidth) { width *= maxWidth / height; height = maxWidth; } }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.onerror = (err) => resolve(base64Str);
            });
        };

        const useSharedCollection = (restaurantId, category, sortField = 'createdAt') => {
            const [data, setData] = useState([]);
            
            useEffect(() => {
                if (!window.db || !restaurantId) return;
                let q;
                if (window.appId === 'epack-prod-data') {
                    q = window.collection(window.db, 'haccp_data', restaurantId, category); 
                } else {
                    q = window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'haccp_items');
                }
                
                const unsubscribe = window.onSnapshot(q, (snapshot) => {
                    let items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (window.appId !== 'epack-prod-data') {
                        items = items.filter(item => item.restaurantId === restaurantId && item.category === category);
                    }
                    items.sort((a, b) => (b[sortField] || 0) - (a[sortField] || 0));
                    setData(items);
                }, (error) => console.error("Sync error:", error));

                return () => unsubscribe();
            }, [restaurantId, category]);

            const addItem = async (item) => {
                if (!restaurantId) return;
                let itemToSave = { ...item };
                
                if (item.rawFile) {
                    try {
                        const fileName = `${restaurantId}/${category}/${Date.now()}_${Math.random().toString(36).substr(2, 9)}.jpg`;
                        const storageRef = window.ref(window.storage, fileName);
                        // Délai 45 secondes pour le cloud
                        const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout")), 45000));
                        await Promise.race([window.uploadBytes(storageRef, item.rawFile), timeoutPromise]);
                        const url = await window.getDownloadURL(storageRef);
                        itemToSave.photo = url;
                        delete itemToSave.rawFile;
                    } catch (e) {
                        console.warn("Mode compression locale", e);
                        if (item.photo && item.photo.startsWith('data:')) {
                            const compressed = await compressImage(item.photo, 600, 0.5);
                            itemToSave.photo = compressed;
                            delete itemToSave.rawFile;
                            alert("Connexion lente : Photo sauvegardée en qualité réduite.");
                        } else {
                            delete itemToSave.photo;
                            delete itemToSave.rawFile;
                            alert("Erreur photo : Enregistré sans image.");
                        }
                    }
                }

                try {
                    if (window.appId === 'epack-prod-data') {
                        await window.addDoc(window.collection(window.db, 'haccp_data', restaurantId, category), { createdAt: Date.now(), ...itemToSave });
                    } else {
                        await window.addDoc(window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'haccp_items'), { restaurantId, category, createdAt: Date.now(), ...itemToSave });
                    }
                } catch (e) {
                    alert("Erreur finale sauvegarde: " + e.message);
                }
            };

            const deleteItem = async (id) => {
                try {
                    if (window.appId === 'epack-prod-data') {
                        await window.deleteDoc(window.doc(window.db, 'haccp_data', restaurantId, category, id));
                    } else {
                        await window.deleteDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'haccp_items', id));
                    }
                } catch (e) { console.error("Delete error", e); }
            };

            return { data, addItem, deleteItem };
        };

        const useSharedLogs = (restaurantId, logCategory) => {
            const [logs, setLogs] = useState({});

            useEffect(() => {
                if (!window.db || !restaurantId) return;
                let q;
                if (window.appId === 'epack-prod-data') {
                     q = window.collection(window.db, 'haccp_logs', restaurantId, logCategory);
                } else {
                     q = window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'haccp_logs');
                }

                const unsubscribe = window.onSnapshot(q, (snapshot) => {
                    const loadedLogs = {};
                    snapshot.docs.forEach(doc => {
                        const d = doc.data();
                        if (window.appId === 'epack-prod-data') {
                             loadedLogs[doc.id] = d.data;
                        } else {
                             if (d.restaurantId === restaurantId && d.category === logCategory) {
                                loadedLogs[d.date] = d.data;
                            }
                        }
                    });
                    setLogs(loadedLogs);
                });
                return () => unsubscribe();
            }, [restaurantId, logCategory]);

            const updateLog = async (dateStr, dataToMerge) => {
                const existingData = logs[dateStr] || {};
                const newData = { ...existingData, ...dataToMerge };

                if (window.appId === 'epack-prod-data') {
                     const docRef = window.doc(window.db, 'haccp_logs', restaurantId, logCategory, dateStr);
                     await window.setDoc(docRef, { data: newData }, { merge: true });
                } else {
                    const docId = `${restaurantId}_${logCategory}_${dateStr}`.replace(/[^a-zA-Z0-9]/g, '_');
                    const docRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'haccp_logs', docId);
                    await window.setDoc(docRef, { restaurantId, category: logCategory, date: dateStr, data: newData }, { merge: true });
                }
            };
            return { logs, updateLog };
        };

        const Icon = ({ name, className }) => {
            const icons = {
                ScanBarcode: <><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></>,
                Thermometer: <path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z" />,
                ClipboardCheck: <><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M15 2H9a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1Z"/><path d="m9 14 2 2 4-4"/></>,
                Camera: <><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></>,
                ChevronRight: <path d="m9 18 6-6-6-6"/>,
                ChevronLeft: <path d="m15 18-6-6 6-6"/>,
                Trash2: <><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>,
                CheckCircle: <><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>,
                Menu: <><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></>,
                Save: <><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>,
                Plus: <><path d="M5 12h14"/><path d="M12 5v14"/></>,
                Calendar: <><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></>,
                Search: <><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></>,
                X: <><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>,
                Aperture: <><circle cx="12" cy="12" r="10"/><line x1="14.31" x2="20.05" y1="8" y2="17.94"/><line x1="9.69" x2="21.17" y1="8" y2="8"/><line x1="7.38" x2="13.12" y1="12" y2="2.06"/><line x1="9.69" x2="3.95" y1="16" y2="6.06"/><line x1="14.31" x2="2.83" y1="16" y2="16"/><line x1="16.62" x2="10.88" y1="12" y2="21.94"/></>,
                ZoomIn: <><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/><line x1="11" x2="11" y1="8" y2="14"/><line x1="8" x2="14" y1="11" y2="11"/></>,
                ZoomOut: <><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/><line x1="8" x2="14" y1="11" y2="11"/></>,
                Delete: <path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2zM18 13l-2.5-2.5L18 8"/>,
                Download: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></>,
                RotateCcw: <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>,
                Wifi: <><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></>,
                LogOut: <><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></>,
                Lock: <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || <circle cx="12" cy="12" r="10" />}
                    {name === 'Lock' && <path d="M7 11V7a5 5 0 0 1 10 0v4" />}
                </svg>
            );
        };

        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-xl shadow-sm border border-green-100 p-6 ${className}`}>{children}</div>
        );
        const Button = ({ children, onClick, variant = "primary", className = "", type="button", disabled=false }) => {
            const style = `px-6 py-3 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 active:scale-95 disabled:opacity-50 ${
                variant === "primary" ? "bg-green-600 text-white hover:bg-green-700 shadow-md shadow-green-200" :
                variant === "secondary" ? "bg-white text-green-700 border-2 border-green-600 hover:bg-green-50" :
                variant === "danger" ? "bg-red-500 text-white hover:bg-red-600 shadow-md" :
                "bg-transparent text-gray-600 hover:bg-gray-100"
            } ${className}`;
            return <button type={type} onClick={onClick} disabled={disabled} className={style}>{children}</button>;
        };
        const Input = ({ label, ...props }) => (
            <div className="mb-4">
                <label className="block text-sm font-semibold text-gray-700 mb-1">{label}</label>
                <input className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none" {...props} />
            </div>
        );

        // --- Modules (Traceability, Temperature, Cleaning) - Code inchangé ---
        const TraceabilityModule = ({ restaurantId }) => {
            const { data: products, addItem, deleteItem } = useSharedCollection(restaurantId, 'traceability', 'timestamp');
            const [newProduct, setNewProduct] = useState({ name: '', batch: '', photo: null, rawFile: null });
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [isWebcamOpen, setIsWebcamOpen] = useState(false);
            const [fullscreenPhoto, setFullscreenPhoto] = useState(null);
            const [isUploading, setIsUploading] = useState(false);
            const [zoomLevel, setZoomLevel] = useState(1);
            // --- État pour le panoramique (pan) ---
            const [pan, setPan] = useState({ x: 0, y: 0 });
            const [tempPhoto, setTempPhoto] = useState(null);

            // --- États pour l'export des photos ---
            const [exportModalOpen, setExportModalOpen] = useState(false);
            const [exportMonth, setExportMonth] = useState(new Date().toISOString().slice(0, 7));
            const [isZipping, setIsZipping] = useState(false);
            
            // --- NOUVEAU: État pour éviter le nettoyage en boucle ---
            const [hasAutoCleaned, setHasAutoCleaned] = useState(false);

            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const fileInputRef = useRef(null);
            const nativeCameraInputRef = useRef(null);

            // Refs pour le pinch-to-zoom et pan
            const touchStartDist = useRef(null);
            const startZoom = useRef(1);
            const panStart = useRef(null);
            const startPan = useRef({ x: 0, y: 0 });
            
            useEffect(() => { 
                if (fullscreenPhoto) { 
                    setZoomLevel(1); 
                    setPan({x:0, y:0}); 
                } 
            }, [fullscreenPhoto]);

            // --- NOUVEAU: Effect pour supprimer automatiquement les photos > 6 mois ---
            useEffect(() => {
                if (products.length > 0 && !hasAutoCleaned) {
                    // On attend 5 secondes après le chargement pour ne pas ralentir le démarrage
                    const timer = setTimeout(async () => {
                        const sixMonthsAgo = Date.now() - (180 * 24 * 60 * 60 * 1000); // 180 jours ~ 6 mois
                        
                        const oldItems = products.filter(p => {
                            // On privilégie createdAt (timestamp), sinon on tente de lire sortDate (YYYY-MM-DD)
                            const itemDate = p.createdAt || (p.sortDate ? new Date(p.sortDate).getTime() : null);
                            return itemDate && itemDate < sixMonthsAgo;
                        });

                        if (oldItems.length > 0) {
                            console.log(`[Auto-Clean] Suppression de ${oldItems.length} éléments de plus de 6 mois.`);
                            for (const item of oldItems) {
                                try {
                                    await deleteItem(item.id);
                                } catch (e) {
                                    console.warn("Erreur suppression auto", e);
                                }
                            }
                        }
                        setHasAutoCleaned(true);
                    }, 5000);
                    
                    return () => clearTimeout(timer);
                }
            }, [products, hasAutoCleaned]);

            const handleCameraClick = () => {
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                if (isMobile) { nativeCameraInputRef.current?.click(); } else { startWebcam(); }
            };

            const handleNativeCameraCapture = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => { setNewProduct(p => ({ ...p, photo: event.target.result, rawFile: file })); };
                    reader.readAsDataURL(file);
                }
            };

            const startWebcam = async () => {
                setTempPhoto(null);
                setIsWebcamOpen(true);
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    setTimeout(() => { if (videoRef.current) videoRef.current.srcObject = stream; }, 100);
                } catch (e) { alert("Impossible d'accéder à la webcam."); setIsWebcamOpen(false); }
            };

            const captureWebcam = () => {
                if (videoRef.current && canvasRef.current) {
                    const v = videoRef.current;
                    const c = canvasRef.current;
                    c.width = v.videoWidth;
                    c.height = v.videoHeight;
                    c.getContext('2d').drawImage(v, 0, 0);
                    c.toBlob((blob) => {
                         const previewUrl = c.toDataURL('image/jpeg', 0.8);
                         setTempPhoto({ preview: previewUrl, file: blob }); 
                    }, 'image/jpeg', 0.95);
                    v.pause(); 
                }
            };

            const retakePhoto = () => { setTempPhoto(null); if (videoRef.current) videoRef.current.play(); };
            const confirmPhoto = () => { 
                if (tempPhoto) { setNewProduct(p => ({ ...p, photo: tempPhoto.preview, rawFile: tempPhoto.file })); }
                if(videoRef.current?.srcObject) videoRef.current.srcObject.getTracks().forEach(t => t.stop()); 
                setIsWebcamOpen(false); setTempPhoto(null); 
            };

            const handleSubmit = async (e) => { 
                e.preventDefault(); 
                setIsUploading(true);
                try { await addItem({ ...newProduct, sortDate: new Date().toISOString().split('T')[0] }); } catch (error) { console.error(error); } 
                finally { setIsUploading(false); setNewProduct({ name: '', batch: '', photo: null, rawFile: null }); }
            };

            const filtered = products.filter(p => p.sortDate === selectedDate);
            const changeDate = (d) => { const date = new Date(selectedDate); date.setDate(date.getDate() + d); setSelectedDate(date.toISOString().split('T')[0]); };

            // --- Fonction de téléchargement des photos ---
            const downloadPhotos = async () => {
                setIsZipping(true);
                try {
                    const zip = new JSZip();
                    const folder = zip.folder(`Photos_${exportMonth}`);
                    
                    // Filtrer les produits du mois sélectionné qui ont une photo
                    const itemsToExport = products.filter(p => p.sortDate && p.sortDate.startsWith(exportMonth) && p.photo);
                    
                    if (itemsToExport.length === 0) {
                        alert("Aucune photo trouvée pour ce mois.");
                        setIsZipping(false);
                        return;
                    }

                    let count = 0;
                    for (const item of itemsToExport) {
                        try {
                            let blob;
                            // Gestion des images Base64 ou URL (Cloud)
                            if (item.photo.startsWith('data:')) {
                                blob = await (await fetch(item.photo)).blob();
                            } else {
                                blob = await (await fetch(item.photo)).blob();
                            }
                            // Nettoyage du nom de fichier
                            const safeName = (item.name || 'produit').replace(/[^a-z0-9]/gi, '_');
                            const filename = `${item.sortDate}_${safeName}_${item.id.substr(0,4)}.jpg`;
                            folder.file(filename, blob);
                            count++;
                        } catch (e) {
                            console.error("Erreur téléchargement image", item, e);
                        }
                    }

                    if (count > 0) {
                        const content = await zip.generateAsync({ type: "blob" });
                        saveAs(content, `Traceabilite_${restaurantId}_${exportMonth}.zip`);
                        setExportModalOpen(false);
                    } else {
                        alert("Erreur: Impossible de récupérer les images.");
                    }
                } catch (e) {
                    alert("Erreur ZIP: " + e.message);
                } finally {
                    setIsZipping(false);
                }
            };

            // Gestionnaires tactiles pour le zoom et le pan
            const onTouchStart = (e) => {
                if (e.touches.length === 2) {
                    const dist = Math.hypot(
                        e.touches[0].pageX - e.touches[1].pageX,
                        e.touches[0].pageY - e.touches[1].pageY
                    );
                    touchStartDist.current = dist;
                    startZoom.current = zoomLevel;
                } else if (e.touches.length === 1 && zoomLevel > 1) {
                    panStart.current = { x: e.touches[0].pageX, y: e.touches[0].pageY };
                    startPan.current = { ...pan };
                }
            };

            const onTouchMove = (e) => {
                if (e.touches.length === 2 && touchStartDist.current) {
                    const dist = Math.hypot(
                        e.touches[0].pageX - e.touches[1].pageX,
                        e.touches[0].pageY - e.touches[1].pageY
                    );
                    const ratio = dist / touchStartDist.current;
                    const newZoom = Math.min(Math.max(0.5, startZoom.current * ratio), 5); // Max zoom 5x
                    setZoomLevel(newZoom);
                    if (newZoom <= 1) setPan({x:0, y:0}); // Reset pan if zoomed out
                    e.stopPropagation();
                } else if (e.touches.length === 1 && panStart.current && zoomLevel > 1) {
                    const dx = e.touches[0].pageX - panStart.current.x;
                    const dy = e.touches[0].pageY - panStart.current.y;
                    setPan({
                        x: startPan.current.x + dx,
                        y: startPan.current.y + dy
                    });
                    e.stopPropagation();
                }
            };

            const onTouchEnd = () => {
                touchStartDist.current = null;
                panStart.current = null;
            };

            return (
                <div className="space-y-6 fade-in-element pb-24">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-green-800 flex items-center gap-2"><Icon name="ScanBarcode" className="w-8 h-8"/> Traçabilité</h2>
                        {/* --- Bouton Export --- */}
                        <button onClick={() => setExportModalOpen(true)} className="px-4 py-2 bg-green-100 text-green-700 rounded-lg font-bold flex items-center gap-2 hover:bg-green-200 transition-colors">
                            <Icon name="Download" className="w-5 h-5"/> Exporter
                        </button>
                    </div>
                    <div className="grid lg:grid-cols-12 gap-6">
                        <div className="lg:col-span-4">
                            <Card className="border-2 border-green-100">
                                <form onSubmit={handleSubmit}>
                                    <div className="mb-4">
                                        {isUploading ? (
                                            <div className="w-full py-8 bg-gray-50 rounded-xl flex flex-col items-center justify-center text-green-600 animate-pulse border-2 border-green-200"><Icon name="Wifi" className="mb-2 animate-bounce"/>Envoi vers le Cloud...</div>
                                        ) : newProduct.photo ? (
                                            <div onClick={() => setNewProduct({...newProduct, photo: null, rawFile: null})} className="relative cursor-pointer group"><img src={newProduct.photo} className="w-full rounded-lg" /><div className="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 rounded-lg text-white font-bold"><Icon name="Trash2" className="mr-2"/> Retirer</div></div>
                                        ) : (
                                            <div className="space-y-3">
                                                <button type="button" onClick={handleCameraClick} className="w-full py-8 bg-green-50 text-green-700 rounded-xl border-2 border-dashed border-green-300 flex flex-col items-center justify-center hover:bg-green-100 transition-colors"><Icon name="Aperture" className="w-8 h-8 mb-2"/> Scanner / Photo</button>
                                                <div onClick={() => fileInputRef.current?.click()} className="text-center text-sm text-gray-400 underline cursor-pointer">Importer fichier</div>
                                                <input type="file" ref={fileInputRef} onChange={handleNativeCameraCapture} accept="image/*" className="hidden"/>
                                                <input type="file" ref={nativeCameraInputRef} onChange={handleNativeCameraCapture} accept="image/*" capture="environment" className="hidden"/>
                                            </div>
                                        )}
                                    </div>
                                    <Input label="Produit" value={newProduct.name} onChange={e => setNewProduct({...newProduct, name: e.target.value})} required />
                                    <Input label="Lot / DLC" value={newProduct.batch} onChange={e => setNewProduct({...newProduct, batch: e.target.value})} />
                                    <Button type="submit" className="w-full" disabled={!newProduct.name || !newProduct.photo || isUploading}>{isUploading ? "Enregistrement..." : "Enregistrer (Cloud)"}</Button>
                                </form>
                            </Card>
                        </div>
                        <div className="lg:col-span-8">
                             <div className="bg-white p-4 rounded-xl border flex justify-between items-center mb-4"><div className="flex items-center gap-2"><button onClick={() => changeDate(-1)}><Icon name="ChevronLeft" className="w-6 h-6"/></button><div className="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded-lg border border-gray-200"><Icon name="Calendar" className="w-5 h-5 text-green-600"/><input type="date" value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)} className="bg-transparent font-bold text-gray-700 outline-none" /></div><button onClick={() => changeDate(1)}><Icon name="ChevronRight" className="w-6 h-6"/></button></div><span className="text-sm text-gray-500">{filtered.length} produit(s)</span></div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                {filtered.length === 0 && <div className="col-span-full text-center py-10 text-gray-400">Rien ce jour.</div>}
                                {filtered.map(item => (<div key={item.id} className="bg-white rounded-lg border p-3 flex justify-between items-start"><div className="flex gap-3 w-full" onClick={() => setFullscreenPhoto(item.photo)}><img src={item.photo} className="w-20 h-20 object-cover rounded-lg bg-gray-100 cursor-zoom-in" /><div><p className="font-bold">{item.name}</p><p className="text-sm text-green-600">{item.batch}</p></div></div><button onClick={() => deleteItem(item.id)} className="text-gray-300 hover:text-red-500"><Icon name="Trash2"/></button></div>))}
                            </div>
                        </div>
                    </div>
                    {/* --- Modale d'export --- */}
                    {exportModalOpen && (
                        <div className="fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => !isZipping && setExportModalOpen(false)}>
                            <div className="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl" onClick={e => e.stopPropagation()}>
                                <h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                                    <Icon name="Download" className="text-green-600"/> Exporter Photos
                                </h3>
                                <p className="text-gray-600 mb-4">Choisissez le mois à télécharger (ZIP) :</p>
                                <input 
                                    type="month" 
                                    value={exportMonth} 
                                    onChange={(e) => setExportMonth(e.target.value)} 
                                    className="w-full p-3 border border-gray-300 rounded-lg mb-6 text-lg"
                                    disabled={isZipping}
                                />
                                <div className="flex gap-3">
                                    <Button onClick={downloadPhotos} className="flex-1" disabled={isZipping}>
                                        {isZipping ? "Création ZIP..." : "Télécharger"}
                                    </Button>
                                    <Button variant="ghost" onClick={() => setExportModalOpen(false)} disabled={isZipping}>
                                        Annuler
                                    </Button>
                                </div>
                            </div>
                        </div>
                    )}

                    {isWebcamOpen && (
                        <div className="fixed inset-0 z-[100] bg-black flex flex-col">
                            <div className="relative flex-1 w-full h-full overflow-hidden">
                                <video ref={videoRef} autoPlay playsInline className={`absolute inset-0 w-full h-full object-cover ${tempPhoto ? 'hidden' : ''}`}></video>
                                {tempPhoto && <img src={tempPhoto.preview} className="absolute inset-0 w-full h-full object-cover" />}
                                {!tempPhoto ? (
                                    <><div className="absolute inset-0 flex items-center justify-center pointer-events-none"><div className="w-[80%] h-[60%] border-2 border-green-500/50 rounded-2xl relative"><div className="scan-line"></div></div></div><div className="absolute top-0 w-full p-4 flex justify-between items-center z-20 bg-gradient-to-b from-black/60 to-transparent"><span className="text-white font-bold tracking-wide drop-shadow-md">Scanner</span><button onClick={() => { if(videoRef.current?.srcObject) videoRef.current.srcObject.getTracks().forEach(t=>t.stop()); setIsWebcamOpen(false); }} className="p-3 bg-black/40 rounded-full text-white backdrop-blur-md border border-white/20"><Icon name="X" className="w-6 h-6"/></button></div><div className="absolute bottom-8 w-full flex justify-center z-20"><button onClick={captureWebcam} className="w-20 h-20 bg-white rounded-full border-4 border-gray-200/50 shadow-2xl active:scale-95 transition-transform flex items-center justify-center"><div className="w-16 h-16 bg-white rounded-full border-2 border-black"></div></button></div></>
                                ) : (
                                    <div className="absolute bottom-8 w-full flex justify-center gap-6 z-20 px-8"><button onClick={retakePhoto} className="flex-1 py-4 bg-red-500/90 backdrop-blur-md text-white rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg active:scale-95 border border-red-400"><Icon name="RotateCcw" className="w-6 h-6"/> Reprendre</button><button onClick={confirmPhoto} className="flex-1 py-4 bg-green-500 text-white rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg active:scale-95"><Icon name="CheckCircle" className="w-6 h-6"/> Valider</button></div>
                                )}
                            </div>
                            <canvas ref={canvasRef} className="hidden"></canvas>
                        </div>
                    )}
                    {fullscreenPhoto && (
                        <div 
                            className="fixed inset-0 z-[100] bg-black flex items-center justify-center overflow-hidden touch-none" 
                            onClick={() => setFullscreenPhoto(null)}
                            onTouchStart={onTouchStart}
                            onTouchMove={onTouchMove}
                            onTouchEnd={onTouchEnd}
                        >
                            <div className="absolute bottom-10 z-50 flex gap-4 pointer-events-auto" onClick={e => e.stopPropagation()}><button className="p-4 bg-white/20 backdrop-blur rounded-full text-white border border-white/30 active:scale-95" onClick={() => setZoomLevel(z => Math.max(0.5, z - 0.5))}><Icon name="ZoomOut"/></button><div className="px-4 py-2 bg-black/50 backdrop-blur rounded-full text-white font-mono flex items-center">{Math.round(zoomLevel * 100)}%</div><button className="p-4 bg-white/20 backdrop-blur rounded-full text-white border border-white/30 active:scale-95" onClick={() => setZoomLevel(z => Math.min(3, z + 0.5))}><Icon name="ZoomIn"/></button></div><button className="absolute top-4 right-4 p-3 bg-black/40 backdrop-blur rounded-full text-white border border-white/20 z-50 pointer-events-auto" onClick={() => setFullscreenPhoto(null)}><Icon name="X"/></button>
                            <div className="w-full h-full flex items-center justify-center overflow-hidden">
                                <img 
                                    src={fullscreenPhoto} 
                                    style={{ transform: `translate(${pan.x}px, ${pan.y}px) scale(${zoomLevel})`, transition: (touchStartDist.current || panStart.current) ? 'none' : 'transform 0.2s ease-out' }} 
                                    className="max-h-screen max-w-full object-contain pointer-events-auto" 
                                    onClick={e => e.stopPropagation()} 
                                />
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const TemperatureModule = ({ restaurantId }) => {
            const { data: equipments, addItem: addEquip, deleteItem: removeEquip } = useSharedCollection(restaurantId, 'equipments');
            const { logs: temps, updateLog } = useSharedLogs(restaurantId, 'temperatures');
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [showAdd, setShowAdd] = useState(false);
            const [newEquip, setNewEquip] = useState("");
            const [picker, setPicker] = useState({ open: false, id: null, name: '', period: '' });
            const [tempInput, setTempInput] = useState(''); 
            const [isSaved, setIsSaved] = useState(false);
            const [exportModalOpen, setExportModalOpen] = useState(false);
            const [exportMonth, setExportMonth] = useState(new Date().toISOString().slice(0, 7));

            const changeDate = (d) => { const date = new Date(selectedDate); date.setDate(date.getDate() + d); setSelectedDate(date.toISOString().split('T')[0]); setIsSaved(false); };
            const handleNumClick = (n) => setTempInput(prev => prev + n);
            const handleDot = () => setTempInput(prev => prev.includes('.') ? prev : prev + '.');
            const handleClear = () => setTempInput('');
            const handleBackspace = () => setTempInput(prev => prev.slice(0, -1));
            const handleValidate = () => { updateLog(selectedDate, { [picker.name]: { ...(temps[selectedDate]?.[picker.name]||{}), [picker.period]: tempInput } }); setPicker({...picker, open: false}); setTempInput(''); setIsSaved(false); };
            const openPad = (equipId, equipName, period) => { setPicker({ open: true, id: equipId, name: equipName, period: period }); setTempInput(temps[selectedDate]?.[equipName]?.[period] || ''); };
            const getVal = (name, p) => temps[selectedDate]?.[name]?.[p] || '';
            const handleSaveDay = () => { setIsSaved(true); setTimeout(() => setIsSaved(false), 2000); };
            const KeypadButton = ({ label, onClick, className = "" }) => (<button onClick={onClick} className={`h-16 text-xl font-bold rounded-xl active-press transition-colors shadow-sm border border-gray-200 bg-white hover:bg-gray-50 text-gray-700 ${className}`}>{label}</button>);

            const generateExcel = () => {
                const [year, month] = exportMonth.split('-');
                const daysInMonth = new Date(year, month, 0).getDate();
                let tableHTML = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="UTF-8"></head><body><h2 style="color:#166534; font-family:Arial;">Relevé de Températures - ${month}/${year}</h2><table border="1" style="border-collapse:collapse; font-family:Arial; width:100%;"><thead><tr style="background-color:#4ade80; color:white;"><th style="padding:10px;">Date</th><th style="padding:10px;">Matin (°C)</th><th style="padding:10px;">Soir (°C)</th></tr></thead><tbody>`;
                equipments.forEach(eq => {
                    tableHTML += `<tr><td colspan="3" style="background-color:#dcfce7; color:#166534; font-weight:bold; font-size:14px; padding:10px; text-align:left; border-top: 2px solid #166534;">Équipement : ${eq.name.toUpperCase()}</td></tr>`;
                    let hasData = false;
                    for(let i=1; i<=daysInMonth; i++) {
                        const day = i.toString().padStart(2, '0');
                        const dateStr = `${year}-${month}-${day}`;
                        const dayData = temps[dateStr] || {};
                        const m = dayData[eq.name]?.matin || '';
                        const s = dayData[eq.name]?.soir || '';
                        if (m || s) { hasData = true; tableHTML += `<tr><td style="padding:5px; text-align:center;">${day}/${month}/${year}</td><td style="padding:5px; text-align:center; ${m && (parseFloat(m) > 5 || parseFloat(m) < -25) ? 'color:red; font-weight:bold;' : ''}">${m}</td><td style="padding:5px; text-align:center; ${s && (parseFloat(s) > 5 || parseFloat(s) < -25) ? 'color:red; font-weight:bold;' : ''}">${s}</td></tr>`; }
                    }
                    if (!hasData) tableHTML += `<tr><td colspan="3" style="padding:5px; color:gray; font-style:italic; text-align:center;">Aucune donnée pour ce mois</td></tr>`;
                    tableHTML += `<tr><td colspan="3" style="height:20px; border:none;"></td></tr>`;
                });
                tableHTML += `</tbody></table></body></html>`;
                const blob = new Blob([tableHTML], { type: 'application/vnd.ms-excel' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Releve_Temperatures_${month}_${year}.xls`;
                a.click();
                setExportModalOpen(false);
            };

            return (
                <div className="space-y-6 fade-in-element pb-32">
                    <div className="flex flex-col md:flex-row justify-between items-center gap-4"><h2 className="text-2xl font-bold text-green-800 flex items-center gap-2"><Icon name="Thermometer" className="w-8 h-8"/> Températures</h2><div className="flex gap-2"><button onClick={() => setExportModalOpen(true)} className="px-4 py-2 bg-green-100 text-green-700 rounded-lg font-bold flex items-center gap-2 hover:bg-green-200 transition-colors"><Icon name="Download" className="w-5 h-5"/> Exporter</button><div className="flex items-center gap-4 bg-white p-2 rounded-lg border"><button onClick={() => changeDate(-1)}><Icon name="ChevronLeft"/></button><div className="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded-lg border border-gray-200"><Icon name="Calendar" className="w-5 h-5 text-green-600"/><input type="date" value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)} className="bg-transparent font-bold text-gray-700 outline-none" /></div><button onClick={() => changeDate(1)}><Icon name="ChevronRight"/></button></div></div></div>
                    <div className="grid gap-4">
                         {showAdd ? (
                            <Card className="bg-green-50 border-dashed border-2 border-green-300"><div className="flex gap-2"><input autoFocus placeholder="Nom..." className="flex-1 p-2 rounded" value={newEquip} onChange={e=>setNewEquip(e.target.value)} /><Button onClick={() => { if(newEquip) { addEquip({name: newEquip}); setNewEquip(""); setShowAdd(false); } }}>OK</Button><Button variant="ghost" onClick={() => setShowAdd(false)}>X</Button></div></Card>
                        ) : <button onClick={() => setShowAdd(true)} className="w-full py-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 font-bold hover:bg-green-50 flex items-center justify-center gap-2"><Icon name="Plus" className="w-5 h-5"/> Ajouter équipement</button>}
                        {equipments.map(eq => (
                            <Card key={eq.id} className="flex flex-col md:flex-row items-center gap-4 border-l-4 border-l-green-500">
                                <div className="w-full md:w-1/3 flex justify-between items-center"><div className="font-bold text-lg">{eq.name}</div><button onClick={() => removeEquip(eq.id)} className="text-red-300 hover:text-red-500"><Icon name="Trash2" className="w-4 h-4"/></button></div>
                                <div className="flex gap-4 flex-1 w-full">{['matin', 'soir'].map(p => (<div key={p} className="flex-1"><label className="text-xs uppercase text-gray-400 font-bold">{p}</label><button onClick={() => openPad(eq.id, eq.name, p)} className={`w-full p-3 rounded-lg border-2 font-bold flex justify-between items-center ${getVal(eq.name, p) ? 'bg-green-50 border-green-500 text-green-700' : 'bg-gray-50'}`}>{getVal(eq.name, p) ? getVal(eq.name, p) + '°C' : '--'} <Icon name="ChevronRight" className="w-4 h-4 rotate-90 opacity-50"/></button></div>))}</div>
                            </Card>
                        ))}
                    </div>
                    <div className="fixed bottom-24 md:bottom-6 right-6 z-30"><button onClick={handleSaveDay} className={`flex items-center gap-3 px-8 py-4 rounded-full font-bold text-lg shadow-xl transition-all transform hover:scale-105 active:scale-95 ${isSaved ? 'bg-green-500 text-white' : 'bg-green-600 text-white hover:bg-green-700'}`}>{isSaved ? <Icon name="CheckCircle" className="w-6 h-6"/> : <Icon name="Save" className="w-6 h-6"/>}{isSaved ? 'Enregistré !' : 'Enregistrer'}</button></div>
                    {picker.open && (<div className="fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 fade-in-element" onClick={() => setPicker({...picker, open: false})}><div className="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}><div className="p-4 bg-green-600 text-white flex justify-between items-center"><h3 className="font-bold text-lg">{picker.name} <span className="text-sm font-normal opacity-80">({picker.period})</span></h3><button onClick={() => setPicker({...picker, open: false})}><Icon name="X" className="w-6 h-6"/></button></div><div className="p-4 bg-gray-50 border-b flex items-center justify-between"><div className="text-3xl font-bold text-gray-800 tracking-widest h-10 min-w-[100px]">{tempInput || <span className="text-gray-300">--</span>} <span className="text-sm text-gray-400">°C</span></div><button onClick={handleBackspace} className="text-gray-400 hover:text-red-500 p-2"><Icon name="Delete" className="w-6 h-6"/></button></div><div className="p-4 bg-gray-100 grid grid-cols-3 gap-3">{[7, 8, 9, 4, 5, 6, 1, 2, 3].map(n => (<KeypadButton key={n} label={n} onClick={() => handleNumClick(n.toString())} />))}<KeypadButton label="-" onClick={() => !tempInput.includes('-') && setTempInput(prev => '-' + prev)} className="text-blue-600 bg-blue-50 border-blue-100" /><KeypadButton label="0" onClick={() => handleNumClick('0')} /><KeypadButton label="." onClick={handleDot} className="text-blue-600 bg-blue-50 border-blue-100" /><KeypadButton label="C" onClick={handleClear} className="bg-red-50 text-red-600 border-red-100" /><button onClick={handleValidate} className="col-span-2 h-16 bg-green-600 text-white rounded-xl font-bold text-lg shadow-md active:scale-95 transition-transform flex items-center justify-center gap-2"><Icon name="CheckCircle" className="w-6 h-6"/> Valider</button></div></div></div>)}
                    {exportModalOpen && (<div className="fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setExportModalOpen(false)}><div className="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl" onClick={e => e.stopPropagation()}><h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"><Icon name="Download" className="text-green-600"/> Exporter vers Excel</h3><p className="text-gray-600 mb-4">Choisissez le mois à exporter :</p><input type="month" value={exportMonth} onChange={(e) => setExportMonth(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg mb-6 text-lg" /><div className="flex gap-3"><Button onClick={generateExcel} className="flex-1">Télécharger</Button><Button variant="ghost" onClick={() => setExportModalOpen(false)}>Annuler</Button></div></div></div>)}
                </div>
            );
        };

        const CleaningModule = ({ restaurantId }) => {
            const { data: zones, addItem: addZone, deleteItem: removeZone } = useSharedCollection(restaurantId, 'cleaning');
            const { logs, updateLog } = useSharedLogs(restaurantId, 'cleaning_logs');
            const [showAdd, setShowAdd] = useState(false);
            const [newZone, setNewZone] = useState({ name: "", freq: "Journalier" });
            const today = new Date().toLocaleDateString('fr-FR').replace(/\//g, '-');
            const seed = async () => { for (const z of [{ name: "Sol Cuisine", freq: "Journalier" }, { name: "Hotte", freq: "Hebdo" }]) await addZone(z); };
            const toggle = (id) => updateLog(today, { [id]: !(logs[today]?.[id]) });
            const isDone = (id) => logs[today]?.[id];
            const progress = zones.length === 0 ? 0 : Math.round((zones.filter(z => isDone(z.id)).length / zones.length) * 100);

            return (
                <div className="space-y-6 fade-in-element pb-20">
                    <div className="flex justify-between items-end"><h2 className="text-2xl font-bold text-green-800 flex items-center gap-2"><Icon name="ClipboardCheck" className="w-8 h-8"/> Nettoyage</h2><div className="text-right"><span className="text-3xl font-bold text-green-600">{progress}%</span></div></div>
                    <div className="w-full bg-gray-200 rounded-full h-2"><div className="bg-green-600 h-2 rounded-full transition-all duration-500" style={{width: `${progress}%`}}></div></div>
                    <div className="grid gap-3">
                        {zones.length === 0 && <div className="text-center py-8"><Button onClick={seed} variant="secondary">Charger liste défaut</Button></div>}
                        {zones.map(z => (
                            <div key={z.id} onClick={() => toggle(z.id)} className={`p-4 rounded-xl border cursor-pointer flex justify-between items-center transition-all ${isDone(z.id) ? 'bg-green-600 text-white border-green-700 shadow-md transform scale-[1.02]' : 'bg-white border-gray-200'}`}>
                                <div><h4 className="font-bold text-lg">{z.name}</h4><span className={`text-xs px-2 py-0.5 rounded-full ${isDone(z.id) ? 'bg-green-500 text-green-50' : 'bg-gray-100 text-gray-500'}`}>{z.freq}</span></div>
                                <div className="flex gap-4 items-center"><div className={`w-8 h-8 rounded-full flex items-center justify-center ${isDone(z.id) ? 'bg-white text-green-600' : 'bg-gray-100 text-gray-300'}`}><Icon name="CheckCircle" /></div><button onClick={(e) => { e.stopPropagation(); removeZone(z.id); }} className="p-2 hover:bg-white/20 rounded-full"><Icon name="Trash2" className="w-5 h-5"/></button></div>
                            </div>
                        ))}
                        {showAdd ? (
                            <Card className="bg-green-50 border-dashed border-2 border-green-300"><div className="flex flex-col gap-2"><input autoFocus placeholder="Tâche..." className="p-2 rounded border border-gray-300" value={newZone.name} onChange={e=>setNewZone({...newZone, name: e.target.value})} /><div className="flex gap-2"><select className="p-2 rounded border border-gray-300 bg-white flex-1" value={newZone.freq} onChange={e=>setNewZone({...newZone, freq: e.target.value})}><option value="Journalier">Journalier</option><option value="Hebdomadaire">Hebdomadaire</option><option value="Mensuel">Mensuel</option></select><Button className="flex-1" onClick={() => { if(newZone.name) { addZone(newZone); setNewZone({name:"", freq:"Journalier"}); setShowAdd(false); } }}>Ajouter</Button></div><Button variant="ghost" onClick={() => setShowAdd(false)} className="w-full text-sm py-1">Annuler</Button></div></Card>
                        ) : <button onClick={() => setShowAdd(true)} className="w-full py-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 font-bold hover:bg-green-50">+ Nouvelle tâche</button>}
                    </div>
                </div>
            );
        };

        // --- Nouveau PinScreen avec login réel (6 chiffres) ---
        const PinScreen = ({ onLogin, isLoading }) => {
            const [code, setCode] = useState("");
            const [error, setError] = useState(false);
            
            const handleNum = (num) => {
                if (code.length < 6 && !isLoading) { // Modifié pour 6 chiffres
                    const newCode = code + num;
                    setCode(newCode);
                    setError(false);
                    if (newCode.length === 6) {
                        onLogin(newCode); // On envoie le code au parent pour login
                    }
                }
            };
            
            const handleBackspace = () => setCode(prev => prev.slice(0, -1));

            return (
                <div className="flex flex-col items-center justify-center h-full bg-green-50 p-6 fade-in-element">
                    <div className="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm text-center border border-green-100">
                        <div className="mb-6">
                            <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-green-600">
                                <Icon name="Lock" className="w-8 h-8"/>
                            </div>
                            <h2 className="text-2xl font-bold text-gray-800">Verrouillé</h2>
                            <p className="text-gray-500 text-sm mt-1">{isLoading ? "Connexion..." : "Entrez le code de sécurité (6 chiffres)"}</p>
                        </div>

                        <div className="flex justify-center gap-4 mb-8">
                            {[0, 1, 2, 3, 4, 5].map(i => ( // Boucle pour 6 points
                                <div key={i} className={`w-4 h-4 rounded-full transition-all duration-200 ${i < code.length ? (error ? 'bg-red-500' : 'bg-green-500') : 'bg-gray-200'}`}></div>
                            ))}
                        </div>

                        <div className="grid grid-cols-3 gap-4 mb-4">
                            {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(n => (
                                <button key={n} onClick={() => handleNum(n.toString())} disabled={isLoading} className="h-16 rounded-2xl bg-gray-50 text-2xl font-bold text-gray-700 active:bg-gray-200 active:scale-95 transition-all outline-none touch-manipulation disabled:opacity-50">{n}</button>
                            ))}
                            <div className="h-16"></div>
                            <button onClick={() => handleNum('0')} disabled={isLoading} className="h-16 rounded-2xl bg-gray-50 text-2xl font-bold text-gray-700 active:bg-gray-200 active:scale-95 transition-all outline-none touch-manipulation disabled:opacity-50">0</button>
                            <button onClick={handleBackspace} disabled={isLoading} className="h-16 rounded-2xl flex items-center justify-center text-gray-400 active:bg-red-50 active:text-red-500 active:scale-95 transition-all outline-none touch-manipulation disabled:opacity-50"><Icon name="Delete" className="w-8 h-8"/></button>
                        </div>
                        {error && <p className="text-red-500 font-bold text-sm animate-bounce">Code incorrect ou erreur connexion</p>}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [restaurantId, setRestaurantId] = useState(localStorage.getItem('haccp_restaurant_id') || 'mon-restaurant');
            const [tab, setTab] = useState('traceability');
            
            // MODIFICATION: On utilise localStorage (persistant) au lieu de sessionStorage (temporaire)
            // L'application restera déverrouillée tant qu'on ne clique pas sur "Verrouiller"
            const [isLocked, setIsLocked] = useState(!localStorage.getItem('haccp_app_unlocked'));
            
            const [isAuthLoading, setIsAuthLoading] = useState(true); // Chargement initial
            const [isLoginLoading, setIsLoginLoading] = useState(false); // Chargement pendant le login PIN

            useEffect(() => {
                const initAuth = async () => {
                    // On privilégie la connexion anonyme pour le backend "Data"
                    // pour éviter les erreurs "operation-not-allowed" si l'email n'est pas activé
                    if (window.initialAuthToken) {
                        await window.signInWithCustomToken(window.auth, window.initialAuthToken);
                    } else {
                        await window.signInAnonymously(window.auth);
                    }
                };
                initAuth();

                const unsubscribe = window.onAuthStateChanged(window.auth, (u) => {
                    setUser(u);
                    setIsAuthLoading(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                localStorage.setItem('haccp_restaurant_id', restaurantId);
            }, [restaurantId]);

            const handleLogin = async (code) => {
                // Simulation sécurisée pour éviter l'erreur "operation-not-allowed"
                // L'utilisateur est DÉJÀ connecté anonymement au backend (pour sauver les données)
                // Ce code sert de verrou UI (Interface Utilisateur)
                if (code === '030613') {
                    // MODIFICATION: On enregistre l'état déverrouillé de manière permanente
                    localStorage.setItem('haccp_app_unlocked', 'true');
                    setIsLocked(false);
                } else {
                    alert("Code incorrect");
                }
            };
            
            const handleLock = () => {
                // MODIFICATION: On supprime l'état persistant lors du verrouillage manuel
                localStorage.removeItem('haccp_app_unlocked');
                setIsLocked(true);
            };

            // Écran de chargement initial (vérification session)
            if (isAuthLoading) return <div className="flex items-center justify-center h-full text-green-700 font-bold animate-pulse">Chargement Cloud...</div>;

            // Si verrouillé, on affiche le PIN screen. 
            // Note: user est connecté en background (anonyme) mais l'écran est bloqué.
            if (isLocked) {
                return <PinScreen onLogin={handleLogin} isLoading={isLoginLoading} />;
            }
            
            const MenuBtn = ({ id, label, icon }) => (
                <button onClick={() => setTab(id)} className={`w-full flex items-center gap-4 px-4 py-4 rounded-xl transition-all ${tab === id ? 'bg-green-600 text-white shadow-lg' : 'text-gray-600 hover:bg-green-50'}`}>
                    <Icon name={icon} className="w-6 h-6"/> <span className="font-semibold text-lg hidden lg:inline">{label}</span>
                    <span className="lg:hidden"><Icon name={icon} className="w-8 h-8"/></span>
                </button>
            );

            return (
                <div className="flex h-[100dvh] bg-green-50/50 w-full overflow-hidden flex-col md:flex-row fade-in-element">
                    <div className="md:w-72 bg-white border-r border-gray-200 z-50 flex flex-col md:h-full shadow-xl order-2 md:order-1">
                        <div className="p-6 border-b hidden md:flex justify-start items-center gap-2">
                             <h1 className="text-2xl font-extrabold text-green-700">eHygiène<span className="text-green-400">.</span></h1>
                        </div>
                        <div className="p-4 bg-green-50 border-b hidden md:block">
                            <p className="text-xs text-green-600 font-bold uppercase tracking-wider">Restaurant</p>
                            <p className="font-bold text-gray-800 truncate">{restaurantId}</p>
                        </div>
                        <nav className="p-2 space-y-2 flex-1 overflow-y-auto hidden md:block">
                            <MenuBtn id="traceability" label="Traçabilité" icon="ScanBarcode"/>
                            <MenuBtn id="temperature" label="Températures" icon="Thermometer"/>
                            <MenuBtn id="cleaning" label="Nettoyage" icon="ClipboardCheck"/>
                        </nav>
                        <div className="p-4 border-t hidden md:block">
                             <button onClick={handleLock} className="w-full py-2 text-sm text-red-500 hover:bg-red-50 rounded flex items-center justify-center gap-2"><Icon name="LogOut" className="w-4 h-4"/> Verrouiller</button>
                        </div>
                        <div className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around p-3 z-50 pb-safe">
                            <button onClick={() => setTab('traceability')} className={`flex flex-col items-center ${tab === 'traceability' ? 'text-green-600' : 'text-green-600/50'}`}><Icon name="ScanBarcode" className="w-6 h-6"/><span className="text-xs">Traçabilité</span></button>
                            <button onClick={() => setTab('temperature')} className={`flex flex-col items-center ${tab === 'temperature' ? 'text-green-600' : 'text-green-600/50'}`}><Icon name="Thermometer" className="w-6 h-6"/><span className="text-xs">Températures</span></button>
                            <button onClick={() => setTab('cleaning')} className={`flex flex-col items-center ${tab === 'cleaning' ? 'text-green-600' : 'text-green-600/50'}`}><Icon name="ClipboardCheck" className="w-6 h-6"/><span className="text-xs">Nettoyage</span></button>
                        </div>
                    </div>
                    <main className="flex-1 flex flex-col h-full overflow-hidden relative w-full order-1 md:order-2 pb-16 md:pb-0">
                        <div className="md:hidden bg-white p-4 border-b flex justify-between items-center">
                            <h1 className="text-xl font-extrabold text-green-700">eHygiène<span className="text-green-400">.</span></h1>
                            <button onClick={handleLock} className="text-red-500"><Icon name="LogOut" className="w-6 h-6"/></button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 lg:p-10 w-full">
                            <div className="max-w-5xl mx-auto w-full">
                                {tab === 'traceability' && <TraceabilityModule restaurantId={restaurantId} />}
                                {tab === 'temperature' && <TemperatureModule restaurantId={restaurantId} />}
                                {tab === 'cleaning' && <CleaningModule restaurantId={restaurantId} />}
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
