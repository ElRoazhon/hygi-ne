<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>eHygiène - Premium</title>
    
    <!-- CHARGEMENT DES OUTILS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Styles de base */
        body { -webkit-tap-highlight-color: transparent; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.4s ease-out forwards; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* Effet bouton appuyé */
        .active-press:active { transform: scale(0.95); background-color: #f3f4f6; }
        
        /* Animation Scanner */
        @keyframes scan {
            0% { top: 10%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 90%; opacity: 0; }
        }
        .scan-line {
            position: absolute;
            left: 10%;
            right: 10%;
            height: 2px;
            background: #4ade80;
            box-shadow: 0 0 10px #4ade80;
            animation: scan 2s linear infinite;
        }
    </style>
</head>
<body class="bg-green-50 text-gray-900 h-screen w-screen overflow-hidden select-none font-sans">

    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 1. GESTION DES DONNÉES ---
        const useLocalCollection = (collectionName, sortField = 'createdAt') => {
            const [data, setData] = useState([]);
            useEffect(() => {
                try {
                    const localData = localStorage.getItem(`haccp_${collectionName}`);
                    if (localData) {
                        let parsed = JSON.parse(localData);
                        parsed.sort((a, b) => (b[sortField] || 0) - (a[sortField] || 0));
                        setData(parsed);
                    }
                } catch(e) {}
            }, [collectionName]);
            const save = (newData) => { setData(newData); localStorage.setItem(`haccp_${collectionName}`, JSON.stringify(newData)); };
            const addItem = (item) => { save([{ ...item, id: Date.now().toString(), createdAt: Date.now() }, ...data]); };
            const deleteItem = (id) => { save(data.filter(i => i.id !== id)); };
            return { data, addItem, deleteItem };
        };

        const useLocalLogs = (collectionName) => {
            const [logs, setLogs] = useState({});
            useEffect(() => {
                try {
                    const localData = localStorage.getItem(`haccp_${collectionName}`);
                    if (localData) setLogs(JSON.parse(localData));
                } catch(e) {}
            }, [collectionName]);
            const updateLog = (dateStr, dataToMerge) => {
                const newLogs = { ...logs, [dateStr]: { ...(logs[dateStr] || {}), ...dataToMerge } };
                setLogs(newLogs);
                localStorage.setItem(`haccp_${collectionName}`, JSON.stringify(newLogs));
            };
            return { logs, updateLog };
        };

        // --- 2. ICÔNES ---
        const Icon = ({ name, className }) => {
            const icons = {
                ScanBarcode: <><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></>,
                Thermometer: <path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z" />,
                ClipboardCheck: <><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M15 2H9a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1Z"/><path d="m9 14 2 2 4-4"/></>,
                Camera: <><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></>,
                ChevronRight: <path d="m9 18 6-6-6-6"/>,
                ChevronLeft: <path d="m15 18-6-6 6-6"/>,
                Trash2: <><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>,
                CheckCircle: <><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>,
                Menu: <><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></>,
                Save: <><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>,
                Plus: <><path d="M5 12h14"/><path d="M12 5v14"/></>,
                Calendar: <><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></>,
                Search: <><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></>,
                X: <><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>,
                Aperture: <><circle cx="12" cy="12" r="10"/><line x1="14.31" x2="20.05" y1="8" y2="17.94"/><line x1="9.69" x2="21.17" y1="8" y2="8"/><line x1="7.38" x2="13.12" y1="12" y2="2.06"/><line x1="9.69" x2="3.95" y1="16" y2="6.06"/><line x1="14.31" x2="2.83" y1="16" y2="16"/><line x1="16.62" x2="10.88" y1="12" y2="21.94"/></>,
                ZoomIn: <><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/><line x1="11" x2="11" y1="8" y2="14"/><line x1="8" x2="14" y1="11" y2="11"/></>,
                ZoomOut: <><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/><line x1="8" x2="14" y1="11" y2="11"/></>,
                Delete: <path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2zM18 13l-2.5-2.5L18 8"/>,
                Download: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></>,
                RotateCcw: <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || <circle cx="12" cy="12" r="10" />}
                </svg>
            );
        };

        // --- 3. COMPOSANTS UI ---
        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-xl shadow-sm border border-green-100 p-6 ${className}`}>{children}</div>
        );
        const Button = ({ children, onClick, variant = "primary", className = "", type="button", disabled=false }) => {
            const style = `px-6 py-3 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 active:scale-95 disabled:opacity-50 ${
                variant === "primary" ? "bg-green-600 text-white hover:bg-green-700 shadow-md shadow-green-200" :
                variant === "secondary" ? "bg-white text-green-700 border-2 border-green-600 hover:bg-green-50" :
                variant === "danger" ? "bg-red-500 text-white hover:bg-red-600 shadow-md" :
                "bg-transparent text-gray-600 hover:bg-gray-100"
            } ${className}`;
            return <button type={type} onClick={onClick} disabled={disabled} className={style}>{children}</button>;
        };
        const Input = ({ label, ...props }) => (
            <div className="mb-4">
                <label className="block text-sm font-semibold text-gray-700 mb-1">{label}</label>
                <input className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none" {...props} />
            </div>
        );

        // --- 4. MODULE TRAÇABILITÉ (AVEC VALIDATION PHOTO) ---
        const TraceabilityModule = () => {
            const { data: products, addItem, deleteItem } = useLocalCollection('traceability', 'timestamp');
            const [newProduct, setNewProduct] = useState({ name: '', batch: '', photo: null });
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [isWebcamOpen, setIsWebcamOpen] = useState(false);
            const [fullscreenPhoto, setFullscreenPhoto] = useState(null);
            
            // États pour Zoom et Preview
            const [zoomLevel, setZoomLevel] = useState(1);
            const [tempPhoto, setTempPhoto] = useState(null); // Photo en attente de validation
            
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const fileInputRef = useRef(null);

            useEffect(() => { if (fullscreenPhoto) setZoomLevel(1); }, [fullscreenPhoto]);

            const startWebcam = async () => {
                setTempPhoto(null);
                setIsWebcamOpen(true);
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    setTimeout(() => { if (videoRef.current) videoRef.current.srcObject = stream; }, 100);
                } catch (e) { alert("Impossible d'accéder à la caméra."); setIsWebcamOpen(false); }
            };

            const captureWebcam = () => {
                if (videoRef.current && canvasRef.current) {
                    const v = videoRef.current;
                    const c = canvasRef.current;
                    c.width = v.videoWidth;
                    c.height = v.videoHeight;
                    c.getContext('2d').drawImage(v, 0, 0);
                    setTempPhoto(c.toDataURL('image/jpeg', 0.7)); // Sauvegarde temporaire
                    v.pause(); // Figer la vidéo
                }
            };

            const retakePhoto = () => {
                setTempPhoto(null);
                if (videoRef.current) videoRef.current.play(); // Relancer la vidéo
            };

            const confirmPhoto = () => {
                setNewProduct(p => ({ ...p, photo: tempPhoto }));
                if(videoRef.current?.srcObject) videoRef.current.srcObject.getTracks().forEach(t => t.stop());
                setIsWebcamOpen(false);
                setTempPhoto(null);
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                addItem({ ...newProduct, sortDate: new Date().toISOString().split('T')[0] });
                setNewProduct({ name: '', batch: '', photo: null });
            };
            
            const filtered = products.filter(p => p.sortDate === selectedDate);
            const changeDate = (d) => { const date = new Date(selectedDate); date.setDate(date.getDate() + d); setSelectedDate(date.toISOString().split('T')[0]); };

            return (
                <div className="space-y-6 animate-fadeIn pb-24">
                    <div className="flex justify-between items-center"><h2 className="text-2xl font-bold text-green-800 flex items-center gap-2"><Icon name="ScanBarcode" className="w-8 h-8"/> Traçabilité</h2></div>
                    <div className="grid lg:grid-cols-12 gap-6">
                        <div className="lg:col-span-4">
                            <Card className="border-2 border-green-100">
                                <form onSubmit={handleSubmit}>
                                    <div className="mb-4">
                                        {newProduct.photo ? (
                                            <div onClick={() => setNewProduct({...newProduct, photo: null})} className="relative cursor-pointer group">
                                                <img src={newProduct.photo} className="w-full rounded-lg" />
                                                <div className="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 rounded-lg text-white font-bold"><Icon name="Trash2" className="mr-2"/> Retirer</div>
                                            </div>
                                        ) : (
                                            <div className="space-y-3">
                                                <button type="button" onClick={startWebcam} className="w-full py-8 bg-green-50 text-green-700 rounded-xl border-2 border-dashed border-green-300 flex flex-col items-center justify-center hover:bg-green-100 transition-colors"><Icon name="Aperture" className="w-8 h-8 mb-2"/> Scanner / Photo</button>
                                                <div onClick={() => fileInputRef.current?.click()} className="text-center text-sm text-gray-400 underline cursor-pointer">Importer fichier</div>
                                                <input type="file" ref={fileInputRef} onChange={(e) => { const r = new FileReader(); r.onload=()=>setNewProduct(p=>({...p, photo:r.result})); if(e.target.files[0]) r.readAsDataURL(e.target.files[0]); }} accept="image/*" className="hidden"/>
                                            </div>
                                        )}
                                    </div>
                                    <Input label="Produit" value={newProduct.name} onChange={e => setNewProduct({...newProduct, name: e.target.value})} required />
                                    <Input label="Lot / DLC" value={newProduct.batch} onChange={e => setNewProduct({...newProduct, batch: e.target.value})} />
                                    <Button type="submit" className="w-full" disabled={!newProduct.name || !newProduct.photo}>Enregistrer</Button>
                                </form>
                            </Card>
                        </div>
                        <div className="lg:col-span-8">
                             <div className="bg-white p-4 rounded-xl border flex justify-between items-center mb-4">
                                <div className="flex items-center gap-2">
                                    <button onClick={() => changeDate(-1)}><Icon name="ChevronLeft" className="w-6 h-6"/></button>
                                    <div className="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded-lg border border-gray-200"><Icon name="Calendar" className="w-5 h-5 text-green-600"/><input type="date" value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)} className="bg-transparent font-bold text-gray-700 outline-none" /></div>
                                    <button onClick={() => changeDate(1)}><Icon name="ChevronRight" className="w-6 h-6"/></button>
                                </div>
                                <span className="text-sm text-gray-500">{filtered.length} produit(s)</span>
                            </div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                {filtered.length === 0 && <div className="col-span-full text-center py-10 text-gray-400">Rien ce jour.</div>}
                                {filtered.map(item => (
                                    <div key={item.id} className="bg-white rounded-lg border p-3 flex justify-between items-start">
                                        <div className="flex gap-3 w-full" onClick={() => setFullscreenPhoto(item.photo)}>
                                            <img src={item.photo} className="w-20 h-20 object-cover rounded-lg bg-gray-100 cursor-zoom-in" />
                                            <div><p className="font-bold">{item.name}</p><p className="text-sm text-green-600">{item.batch}</p></div>
                                        </div>
                                        <button onClick={() => deleteItem(item.id)} className="text-gray-300 hover:text-red-500"><Icon name="Trash2"/></button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* INTERFACE CAMERA PLEIN ÉCRAN */}
                    {isWebcamOpen && (
                        <div className="fixed inset-0 z-[100] bg-black flex flex-col">
                            <div className="relative flex-1 w-full h-full overflow-hidden">
                                <video ref={videoRef} autoPlay playsInline className={`absolute inset-0 w-full h-full object-cover ${tempPhoto ? 'hidden' : ''}`}></video>
                                {tempPhoto && <img src={tempPhoto} className="absolute inset-0 w-full h-full object-cover" />}

                                {!tempPhoto ? (
                                    <>
                                        <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                                            <div className="w-[80%] h-[60%] border-2 border-green-500/50 rounded-2xl relative">
                                                <div className="scan-line"></div>
                                            </div>
                                        </div>
                                        <div className="absolute top-0 w-full p-4 flex justify-between items-center z-20 bg-gradient-to-b from-black/60 to-transparent">
                                            <span className="text-white font-bold tracking-wide drop-shadow-md">Scanner</span>
                                            <button onClick={() => { if(videoRef.current?.srcObject) videoRef.current.srcObject.getTracks().forEach(t=>t.stop()); setIsWebcamOpen(false); }} className="p-3 bg-black/40 rounded-full text-white backdrop-blur-md border border-white/20"><Icon name="X" className="w-6 h-6"/></button>
                                        </div>
                                        <div className="absolute bottom-8 w-full flex justify-center z-20">
                                            <button onClick={captureWebcam} className="w-20 h-20 bg-white rounded-full border-4 border-gray-200/50 shadow-2xl active:scale-95 transition-transform flex items-center justify-center">
                                                <div className="w-16 h-16 bg-white rounded-full border-2 border-black"></div>
                                            </button>
                                        </div>
                                    </>
                                ) : (
                                    <>
                                        <div className="absolute top-0 w-full p-4 flex justify-end items-center z-20 bg-gradient-to-b from-black/60 to-transparent">
                                            {/* Header vide ou indicateur */}
                                        </div>
                                        <div className="absolute bottom-8 w-full flex justify-center gap-6 z-20 px-8">
                                            <button onClick={retakePhoto} className="flex-1 py-4 bg-red-500/90 backdrop-blur-md text-white rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg active:scale-95 border border-red-400">
                                                <Icon name="RotateCcw" className="w-6 h-6"/> Reprendre
                                            </button>
                                            <button onClick={confirmPhoto} className="flex-1 py-4 bg-green-500 text-white rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg active:scale-95">
                                                <Icon name="CheckCircle" className="w-6 h-6"/> Valider
                                            </button>
                                        </div>
                                    </>
                                )}
                            </div>
                            <canvas ref={canvasRef} className="hidden"></canvas>
                        </div>
                    )}
                    
                    {/* PRÉVISUALISATION PHOTO AVEC ZOOM */}
                    {fullscreenPhoto && (
                        <div className="fixed inset-0 z-[100] bg-black flex items-center justify-center overflow-hidden" onClick={() => setFullscreenPhoto(null)}>
                            {/* Contrôles de Zoom */}
                            <div className="absolute bottom-10 z-50 flex gap-4 pointer-events-auto" onClick={e => e.stopPropagation()}>
                                <button className="p-4 bg-white/20 backdrop-blur rounded-full text-white border border-white/30 active:scale-95" onClick={() => setZoomLevel(z => Math.max(0.5, z - 0.5))}><Icon name="ZoomOut"/></button>
                                <div className="px-4 py-2 bg-black/50 backdrop-blur rounded-full text-white font-mono flex items-center">{Math.round(zoomLevel * 100)}%</div>
                                <button className="p-4 bg-white/20 backdrop-blur rounded-full text-white border border-white/30 active:scale-95" onClick={() => setZoomLevel(z => Math.min(3, z + 0.5))}><Icon name="ZoomIn"/></button>
                            </div>

                            <button className="absolute top-4 right-4 p-3 bg-black/40 backdrop-blur rounded-full text-white border border-white/20 z-50 pointer-events-auto" onClick={() => setFullscreenPhoto(null)}><Icon name="X"/></button>

                            <div className="w-full h-full flex items-center justify-center overflow-auto">
                                <img 
                                    src={fullscreenPhoto} 
                                    style={{ transform: `scale(${zoomLevel})`, transition: 'transform 0.2s ease-out' }}
                                    className="max-h-screen max-w-full object-contain" 
                                    onClick={e => e.stopPropagation()}
                                />
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- 5. MODULE TEMPÉRATURE ---
        const TemperatureModule = () => {
            const { data: equipments, addItem: addEquip, deleteItem: removeEquip } = useLocalCollection('equipments');
            const { logs: temps, updateLog } = useLocalLogs('temperatures');
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [showAdd, setShowAdd] = useState(false);
            const [newEquip, setNewEquip] = useState("");
            const [picker, setPicker] = useState({ open: false, id: null, name: '', period: '' });
            const [tempInput, setTempInput] = useState(''); 
            const [isSaved, setIsSaved] = useState(false);
            const [exportModalOpen, setExportModalOpen] = useState(false);
            const [exportMonth, setExportMonth] = useState(new Date().toISOString().slice(0, 7));

            const changeDate = (d) => { const date = new Date(selectedDate); date.setDate(date.getDate() + d); setSelectedDate(date.toISOString().split('T')[0]); setIsSaved(false); };
            const handleNumClick = (n) => setTempInput(prev => prev + n);
            const handleDot = () => setTempInput(prev => prev.includes('.') ? prev : prev + '.');
            const handleClear = () => setTempInput('');
            const handleBackspace = () => setTempInput(prev => prev.slice(0, -1));
            const handleValidate = () => {
                updateLog(selectedDate, { [picker.name]: { ...(temps[selectedDate]?.[picker.name]||{}), [picker.period]: tempInput } });
                setPicker({...picker, open: false});
                setTempInput('');
                setIsSaved(false);
            };
            const openPad = (equipId, equipName, period) => { setPicker({ open: true, id: equipId, name: equipName, period: period }); setTempInput(temps[selectedDate]?.[equipName]?.[period] || ''); };
            const getVal = (name, p) => temps[selectedDate]?.[name]?.[p] || '';
            const handleSaveDay = () => { setIsSaved(true); setTimeout(() => setIsSaved(false), 2000); };
            
            const KeypadButton = ({ label, onClick, className = "" }) => (
                <button onClick={onClick} className={`h-16 text-xl font-bold rounded-xl active-press transition-colors shadow-sm border border-gray-200 bg-white hover:bg-gray-50 text-gray-700 ${className}`}>{label}</button>
            );

            // FONCTION GENERATION EXCEL
            const generateExcel = () => {
                const [year, month] = exportMonth.split('-');
                const daysInMonth = new Date(year, month, 0).getDate();
                
                let tableHTML = `
                    <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
                    <head><meta charset="UTF-8"></head>
                    <body>
                    <h2 style="color:#166534; font-family:Arial;">Relevé de Températures - ${month}/${year}</h2>
                    <table border="1" style="border-collapse:collapse; font-family:Arial; width:100%;">
                        <thead>
                            <tr style="background-color:#4ade80; color:white;">
                                <th style="padding:10px;">Date</th>
                                <th style="padding:10px;">Matin (°C)</th>
                                <th style="padding:10px;">Soir (°C)</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                equipments.forEach(eq => {
                    tableHTML += `
                        <tr>
                            <td colspan="3" style="background-color:#dcfce7; color:#166534; font-weight:bold; font-size:14px; padding:10px; text-align:left; border-top: 2px solid #166534;">
                                Équipement : ${eq.name.toUpperCase()}
                            </td>
                        </tr>
                    `;
                    let hasData = false;
                    for(let i=1; i<=daysInMonth; i++) {
                        const day = i.toString().padStart(2, '0');
                        const dateStr = `${year}-${month}-${day}`;
                        const dayData = temps[dateStr] || {};
                        const m = dayData[eq.name]?.matin || '';
                        const s = dayData[eq.name]?.soir || '';
                        
                        if (m || s) {
                            hasData = true;
                            tableHTML += `
                                <tr>
                                    <td style="padding:5px; text-align:center;">${day}/${month}/${year}</td>
                                    <td style="padding:5px; text-align:center; ${m && (parseFloat(m) > 5 || parseFloat(m) < -25) ? 'color:red; font-weight:bold;' : ''}">${m}</td>
                                    <td style="padding:5px; text-align:center; ${s && (parseFloat(s) > 5 || parseFloat(s) < -25) ? 'color:red; font-weight:bold;' : ''}">${s}</td>
                                </tr>
                            `;
                        }
                    }
                    if (!hasData) {
                        tableHTML += `<tr><td colspan="3" style="padding:5px; color:gray; font-style:italic; text-align:center;">Aucune donnée pour ce mois</td></tr>`;
                    }
                    tableHTML += `<tr><td colspan="3" style="height:20px; border:none;"></td></tr>`;
                });

                tableHTML += `</tbody></table></body></html>`;

                const blob = new Blob([tableHTML], { type: 'application/vnd.ms-excel' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Releve_Temperatures_${month}_${year}.xls`;
                a.click();
                setExportModalOpen(false);
            };

            return (
                <div className="space-y-6 animate-fadeIn pb-32">
                    <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                        <h2 className="text-2xl font-bold text-green-800 flex items-center gap-2"><Icon name="Thermometer" className="w-8 h-8"/> Températures</h2>
                        <div className="flex gap-2">
                             <button onClick={() => setExportModalOpen(true)} className="px-4 py-2 bg-green-100 text-green-700 rounded-lg font-bold flex items-center gap-2 hover:bg-green-200 transition-colors">
                                <Icon name="Download" className="w-5 h-5"/> Exporter
                            </button>
                             <div className="flex items-center gap-4 bg-white p-2 rounded-lg border">
                                <button onClick={() => changeDate(-1)}><Icon name="ChevronLeft"/></button>
                                <div className="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded-lg border border-gray-200"><Icon name="Calendar" className="w-5 h-5 text-green-600"/><input type="date" value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)} className="bg-transparent font-bold text-gray-700 outline-none" /></div>
                                <button onClick={() => changeDate(1)}><Icon name="ChevronRight"/></button>
                            </div>
                        </div>
                    </div>

                    <div className="grid gap-4">
                         {showAdd ? (
                            <Card className="bg-green-50 border-dashed border-2 border-green-300">
                                <div className="flex gap-2"><input autoFocus placeholder="Nom..." className="flex-1 p-2 rounded" value={newEquip} onChange={e=>setNewEquip(e.target.value)} /><Button onClick={() => { if(newEquip) { addEquip({name: newEquip}); setNewEquip(""); setShowAdd(false); } }}>OK</Button><Button variant="ghost" onClick={() => setShowAdd(false)}>X</Button></div>
                            </Card>
                        ) : <button onClick={() => setShowAdd(true)} className="w-full py-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 font-bold hover:bg-green-50 flex items-center justify-center gap-2"><Icon name="Plus" className="w-5 h-5"/> Ajouter équipement</button>}
                        {equipments.map(eq => (
                            <Card key={eq.id} className="flex flex-col md:flex-row items-center gap-4 border-l-4 border-l-green-500">
                                <div className="w-full md:w-1/3 flex justify-between items-center"><div className="font-bold text-lg">{eq.name}</div><button onClick={() => removeEquip(eq.id)} className="text-red-300 hover:text-red-500"><Icon name="Trash2" className="w-4 h-4"/></button></div>
                                <div className="flex gap-4 flex-1 w-full">{['matin', 'soir'].map(p => (<div key={p} className="flex-1"><label className="text-xs uppercase text-gray-400 font-bold">{p}</label><button onClick={() => openPad(eq.id, eq.name, p)} className={`w-full p-3 rounded-lg border-2 font-bold flex justify-between items-center ${getVal(eq.name, p) ? 'bg-green-50 border-green-500 text-green-700' : 'bg-gray-50'}`}>{getVal(eq.name, p) ? getVal(eq.name, p) + '°C' : '--'} <Icon name="ChevronRight" className="w-4 h-4 rotate-90 opacity-50"/></button></div>))}</div>
                            </Card>
                        ))}
                    </div>

                    <div className="fixed bottom-6 right-6 z-30"><button onClick={handleSaveDay} className={`flex items-center gap-3 px-8 py-4 rounded-full font-bold text-lg shadow-xl transition-all transform hover:scale-105 active:scale-95 ${isSaved ? 'bg-green-500 text-white' : 'bg-green-600 text-white hover:bg-green-700'}`}>{isSaved ? <Icon name="CheckCircle" className="w-6 h-6"/> : <Icon name="Save" className="w-6 h-6"/>}{isSaved ? 'Enregistré !' : 'Enregistrer'}</button></div>

                    {/* MODAL PAD */}
                    {picker.open && (
                        <div className="fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 animate-fadeIn" onClick={() => setPicker({...picker, open: false})}>
                            <div className="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}>
                                <div className="p-4 bg-green-600 text-white flex justify-between items-center"><h3 className="font-bold text-lg">{picker.name} <span className="text-sm font-normal opacity-80">({picker.period})</span></h3><button onClick={() => setPicker({...picker, open: false})}><Icon name="X" className="w-6 h-6"/></button></div>
                                <div className="p-4 bg-gray-50 border-b flex items-center justify-between"><div className="text-3xl font-bold text-gray-800 tracking-widest h-10 min-w-[100px]">{tempInput || <span className="text-gray-300">--</span>} <span className="text-sm text-gray-400">°C</span></div><button onClick={handleBackspace} className="text-gray-400 hover:text-red-500 p-2"><Icon name="Delete" className="w-6 h-6"/></button></div>
                                <div className="p-4 bg-gray-100 grid grid-cols-3 gap-3">{[7, 8, 9, 4, 5, 6, 1, 2, 3].map(n => (<KeypadButton key={n} label={n} onClick={() => handleNumClick(n.toString())} />))}<KeypadButton label="-" onClick={() => !tempInput.includes('-') && setTempInput(prev => '-' + prev)} className="text-blue-600 bg-blue-50 border-blue-100" /><KeypadButton label="0" onClick={() => handleNumClick('0')} /><KeypadButton label="." onClick={handleDot} className="text-blue-600 bg-blue-50 border-blue-100" /><KeypadButton label="C" onClick={handleClear} className="bg-red-50 text-red-600 border-red-100" /><button onClick={handleValidate} className="col-span-2 h-16 bg-green-600 text-white rounded-xl font-bold text-lg shadow-md active:scale-95 transition-transform flex items-center justify-center gap-2"><Icon name="CheckCircle" className="w-6 h-6"/> Valider</button></div>
                            </div>
                        </div>
                    )}

                    {/* MODAL EXPORT EXCEL */}
                    {exportModalOpen && (
                        <div className="fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setExportModalOpen(false)}>
                            <div className="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl" onClick={e => e.stopPropagation()}>
                                <h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"><Icon name="Download" className="text-green-600"/> Exporter vers Excel</h3>
                                <p className="text-gray-600 mb-4">Choisissez le mois à exporter :</p>
                                <input type="month" value={exportMonth} onChange={(e) => setExportMonth(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg mb-6 text-lg" />
                                <div className="flex gap-3">
                                    <Button onClick={generateExcel} className="flex-1">Télécharger</Button>
                                    <Button variant="ghost" onClick={() => setExportModalOpen(false)}>Annuler</Button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const CleaningModule = () => {
            const { data: zones, addItem: addZone, deleteItem: removeZone } = useLocalCollection('cleaning');
            const { logs, updateLog } = useLocalLogs('cleaning_logs');
            const [showAdd, setShowAdd] = useState(false);
            const [newZone, setNewZone] = useState({ name: "", freq: "Journalier" });
            const today = new Date().toLocaleDateString('fr-FR').replace(/\//g, '-');
            const seed = async () => { for (const z of [{ name: "Sol Cuisine", freq: "Journalier" }, { name: "Hotte", freq: "Hebdo" }]) await addZone(z); };
            const toggle = (id) => updateLog(today, { [id]: !(logs[today]?.[id]) });
            const isDone = (id) => logs[today]?.[id];
            const progress = zones.length === 0 ? 0 : Math.round((zones.filter(z => isDone(z.id)).length / zones.length) * 100);

            return (
                <div className="space-y-6 animate-fadeIn pb-20">
                    <div className="flex justify-between items-end"><h2 className="text-2xl font-bold text-green-800 flex items-center gap-2"><Icon name="ClipboardCheck" className="w-8 h-8"/> Nettoyage</h2><div className="text-right"><span className="text-3xl font-bold text-green-600">{progress}%</span></div></div>
                    <div className="w-full bg-gray-200 rounded-full h-2"><div className="bg-green-600 h-2 rounded-full transition-all duration-500" style={{width: `${progress}%`}}></div></div>
                    <div className="grid gap-3">
                        {zones.length === 0 && <div className="text-center py-8"><Button onClick={seed} variant="secondary">Charger liste défaut</Button></div>}
                        {zones.map(z => (
                            <div key={z.id} onClick={() => toggle(z.id)} className={`p-4 rounded-xl border cursor-pointer flex justify-between items-center transition-all ${isDone(z.id) ? 'bg-green-600 text-white border-green-700 shadow-md transform scale-[1.02]' : 'bg-white border-gray-200'}`}>
                                <div><h4 className="font-bold text-lg">{z.name}</h4><span className={`text-xs px-2 py-0.5 rounded-full ${isDone(z.id) ? 'bg-green-500 text-green-50' : 'bg-gray-100 text-gray-500'}`}>{z.freq}</span></div>
                                <div className="flex gap-4 items-center"><div className={`w-8 h-8 rounded-full flex items-center justify-center ${isDone(z.id) ? 'bg-white text-green-600' : 'bg-gray-100 text-gray-300'}`}><Icon name="CheckCircle" /></div><button onClick={(e) => { e.stopPropagation(); removeZone(z.id); }} className="p-2 hover:bg-white/20 rounded-full"><Icon name="Trash2" className="w-5 h-5"/></button></div>
                            </div>
                        ))}
                        {showAdd ? (
                            <Card className="bg-green-50 border-dashed border-2 border-green-300">
                                <div className="flex flex-col gap-2"><input autoFocus placeholder="Tâche..." className="p-2 rounded border border-gray-300" value={newZone.name} onChange={e=>setNewZone({...newZone, name: e.target.value})} />
                                    <div className="flex gap-2"><select className="p-2 rounded border border-gray-300 bg-white flex-1" value={newZone.freq} onChange={e=>setNewZone({...newZone, freq: e.target.value})}><option value="Journalier">Journalier</option><option value="Hebdomadaire">Hebdomadaire</option><option value="Mensuel">Mensuel</option></select><Button className="flex-1" onClick={() => { if(newZone.name) { addZone(newZone); setNewZone({name:"", freq:"Journalier"}); setShowAdd(false); } }}>Ajouter</Button></div><Button variant="ghost" onClick={() => setShowAdd(false)} className="w-full text-sm py-1">Annuler</Button></div>
                            </Card>
                        ) : <button onClick={() => setShowAdd(true)} className="w-full py-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 font-bold hover:bg-green-50">+ Nouvelle tâche</button>}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [tab, setTab] = useState('traceability');
            const MenuBtn = ({ id, label, icon }) => (
                <button onClick={() => setTab(id)} className={`w-full flex items-center gap-4 px-4 py-4 rounded-xl transition-all ${tab === id ? 'bg-green-600 text-white shadow-lg' : 'text-gray-600 hover:bg-green-50'}`}>
                    <Icon name={icon} className="w-6 h-6"/> <span className="font-semibold text-lg hidden lg:inline">{label}</span>
                    <span className="lg:hidden"><Icon name={icon} className="w-8 h-8"/></span>
                </button>
            );
            return (
                <div className="flex h-screen bg-green-50/50 w-full overflow-hidden flex-col md:flex-row">
                    {/* BARRE LATÉRALE (Desktop: Sidebar gauche, Mobile: Navbar bas) */}
                    <div className="md:w-72 bg-white border-r border-gray-200 z-50 flex flex-col md:h-full shadow-xl order-2 md:order-1">
                        <div className="p-6 border-b hidden md:flex justify-start"><h1 className="text-2xl font-extrabold text-green-700">eHygiène<span className="text-green-400">.</span></h1></div>
                        
                        {/* Navigation Desktop (Vertical) */}
                        <nav className="p-2 space-y-2 flex-1 overflow-y-auto hidden md:block">
                            <MenuBtn id="traceability" label="Traçabilité" icon="ScanBarcode"/>
                            <MenuBtn id="temperature" label="Températures" icon="Thermometer"/>
                            <MenuBtn id="cleaning" label="Nettoyage" icon="ClipboardCheck"/>
                        </nav>
                        
                        {/* Navigation Mobile (Horizontal en bas) */}
                        <div className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around p-3 z-50 pb-safe">
                            <button onClick={() => setTab('traceability')} className={`flex flex-col items-center ${tab === 'traceability' ? 'text-green-600' : 'text-gray-400'}`}><Icon name="ScanBarcode" className="w-6 h-6"/><span className="text-xs">Traçabilité</span></button>
                            <button onClick={() => setTab('temperature')} className={`flex flex-col items-center ${tab === 'temperature' ? 'text-green-600' : 'text-gray-400'}`}><Icon name="Thermometer" className="w-6 h-6"/><span className="text-xs">Températures</span></button>
                            <button onClick={() => setTab('cleaning')} className={`flex flex-col items-center ${tab === 'cleaning' ? 'text-green-600' : 'text-gray-400'}`}><Icon name="ClipboardCheck" className="w-6 h-6"/><span className="text-xs">Nettoyage</span></button>
                        </div>

                        <div className="p-4 border-t text-center text-xs text-gray-400 hidden md:block">Version Premium 2.0</div>
                    </div>

                    {/* CONTENU PRINCIPAL */}
                    <main className="flex-1 flex flex-col h-full overflow-hidden relative w-full order-1 md:order-2 pb-16 md:pb-0">
                         {/* Header Mobile */}
                        <div className="md:hidden bg-white p-4 border-b flex justify-between items-center"><h1 className="text-xl font-extrabold text-green-700">eHygiène<span className="text-green-400">.</span></h1></div>
                        <div className="flex-1 overflow-y-auto p-4 lg:p-10 w-full">
                            <div className="max-w-5xl mx-auto w-full">
                                {tab === 'traceability' && <TraceabilityModule />}
                                {tab === 'temperature' && <TemperatureModule />}
                                {tab === 'cleaning' && <CleaningModule />}
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
