<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>eHygi√®ne - So'Chris</title>
    
    <!-- OPTIMISATION CACHE & PRELOAD -->
    <meta http-equiv="Cache-Control" content="public, max-age=31536000">
    <link rel="preload" href="https://cdn.tailwindcss.com" as="script">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" as="script">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" as="script">
    <link rel="preload" href="https://unpkg.com/@babel/standalone/babel.min.js" as="script">
    <link rel="preload" href="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" as="script">
    <link rel="preload" href="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" as="script">
    
    <!-- ICONS -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEyMCIgZmlsbD0iIzE2YTM0YSIvPjxwYXRoIGQ9Ik0yNTYgODBjMCAwIDE0MCAyNSAxNDAgMTQwYzAgMTAwLTgwIDE4MC0xNDAgMjEyYy02MC0zMi0xNDAtMTEyLTE0MC0yMTJjMC0xMTUgMTQwLTE0MCAxNDAtMTQweiIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZmZmIiBzdHJva2Utd2lkdGg9IjMwIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz48cGF0aCBkPSJNMzM2IDIwMGwtMTAwIDEwMGwtNjAtNjAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI2ZmZiIgc3Ryb2tlLXdpZHRoPSIzMCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+PC9zdmc+">
    <link rel="apple-touch-icon" id="dynamic-apple-icon" href="">
    <link rel="manifest" id="dynamic-manifest" href="">

    <meta name="apple-mobile-web-app-title" content="So'Chris">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#16a34a">
    <meta name="mobile-web-app-capable" content="yes">

    <script>
        (function() {
            const svgIcon = `data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEyMCIgZmlsbD0iIzE2YTM0YSIvPjxwYXRoIGQ9Ik0yNTYgODBjMCAwIDE0MCAyNSAxNDAgMTQwYzAgMTAwLTgwIDE4MC0xNDAgMjEyYy02MC0zMi0xNDAtMTEyLTE0MC0yMTJjMC0xMTUgMTQwLTE0MCAxNDAtMTQweiIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZmZmIiBzdHJva2Utd2lkdGg9IjMwIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz48cGF0aCBkPSJNMzM2IDIwMGwtMTAwIDEwMGwtNjAtNjAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI2ZmZiIgc3Ryb2tlLXdpZHRoPSIzMCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+PC9zdmc+`;
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                canvas.width = 512; canvas.height = 512;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, 512, 512);
                const pngUrl = canvas.toDataURL('image/png');
                const appleIcon = document.getElementById('dynamic-apple-icon');
                if (appleIcon) appleIcon.href = pngUrl;
                const manifest = { 
                    "name": "eHygi√®ne So'Chris", 
                    "short_name": "So'Chris", 
                    "start_url": ".", 
                    "display": "standalone", 
                    "orientation": "portrait",
                    "background_color": "#f0fdf4", 
                    "theme_color": "#16a34a", 
                    "icons": [ { "src": pngUrl, "sizes": "512x512", "type": "image/png", "purpose": "any maskable" } ] 
                };
                const stringManifest = JSON.stringify(manifest);
                const blob = new Blob([stringManifest], {type: 'application/json'});
                const manifestUrl = URL.createObjectURL(blob);
                const manifestLink = document.getElementById('dynamic-manifest');
                if (manifestLink) manifestLink.href = manifestUrl;
            };
            img.src = svgIcon;
        })();
    </script>

    <!-- SCRIPTS MOTEUR (Charg√©s via CDN pour mise en cache) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, query, where, setDoc, getDocs, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        let firebaseConfig;
        let appId;
        let initialAuthToken = null;

        try {
            firebaseConfig = JSON.parse(__firebase_config);
            appId = __app_id;
            if (typeof __initial_auth_token !== 'undefined') { initialAuthToken = __initial_auth_token; }
        } catch (e) {
            console.log("Mode Production");
            firebaseConfig = { apiKey: "AIzaSyCoMV_kNz-eI1JlLp33h0iJ4MZR7NnoI-w", authDomain: "epack-hygiene-99e64.firebaseapp.com", projectId: "epack-hygiene-99e64", storageBucket: "epack-hygiene-99e64.firebasestorage.app", messagingSenderId: "917463324646", appId: "1:917463324646:web:14856a7207be0353aca827" };
            appId = 'epack-prod-data'; 
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app); 

        // --- ACTIVATION PERSISTANCE HORS LIGNE ---
        try {
            enableIndexedDbPersistence(db).catch((err) => {
                if (err.code == 'failed-precondition') {
                    console.warn("Persistance √©chou√©e : multiples onglets ouverts.");
                } else if (err.code == 'unimplemented') {
                    console.warn("Persistance non support√©e par ce navigateur.");
                }
            });
        } catch(e) { console.log("Erreur init persistence", e); }

        window.db = db; window.auth = auth; window.storage = storage; window.appId = appId; window.initialAuthToken = initialAuthToken; 
        window.collection = collection; window.addDoc = addDoc; window.onSnapshot = onSnapshot; window.deleteDoc = deleteDoc; window.doc = doc; window.updateDoc = updateDoc; window.setDoc = setDoc;
        window.signInAnonymously = signInAnonymously; window.signInWithCustomToken = signInWithCustomToken; window.signOut = signOut; window.onAuthStateChanged = onAuthStateChanged;
        window.ref = ref; window.uploadBytes = uploadBytes; window.getDownloadURL = getDownloadURL;
        window.getDocs = getDocs; window.query = query; window.where = where; // Exposed for LogoUploader

        // Signal que Firebase est charg√©
        window.firebaseLoaded = true;
    </script>

    <style>
        body { -webkit-tap-highlight-color: transparent; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .fade-in-element { animation: fadeIn 0.3s ease-out; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .active-press:active { transform: scale(0.95); background-color: #f3f4f6; }
        @keyframes scan { 0% { top: 10%; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 90%; opacity: 0; } }
        .scan-line { position: absolute; left: 10%; right: 10%; height: 2px; background: #4ade80; box-shadow: 0 0 10px #4ade80; animation: scan 2s linear infinite; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .offline-badge { background-color: #f97316; color: white; padding: 4px 12px; border-radius: 9999px; font-weight: bold; font-size: 0.8rem; box-shadow: 0 2px 4px rgba(0,0,0,0.2); animation: pulse 2s infinite; display: flex; align-items: center; gap: 6px; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
        
        /* Loader Statique et Error Screen */
        #static-loader { position: fixed; inset: 0; background: #f0fdf4; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; font-family: sans-serif; text-align: center; padding: 20px; transition: opacity 0.5s; }
        .loader-spinner { width: 40px; height: 40px; border: 4px solid #dcfce7; border-top: 4px solid #16a34a; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #offline-error { display: none; color: #b91c1c; background: #fef2f2; padding: 20px; border-radius: 10px; border: 1px solid #fecaca; max-width: 90%; margin-top: 20px; }
    </style>
</head>
<body class="bg-green-50 text-gray-900 h-screen w-screen overflow-hidden select-none font-sans">
    <!-- LOADER INITIAL (Visible avant que React ne charge) -->
    <div id="root" class="h-full w-full">
        <div id="static-loader">
            <div class="loader-spinner" id="loader-spinner"></div>
            <h2 style="color: #166534; font-weight: bold; font-size: 1.25rem; margin-bottom: 10px;">eHygi√®ne So'Chris</h2>
            <p id="loader-text" style="color: #4b5563; font-size: 0.9rem;">D√©marrage de l'application...</p>
            
            <div id="offline-error">
                <h3 style="font-weight: bold; margin-bottom: 5px;">‚ö†Ô∏è Connexion Requise</h3>
                <p style="font-size: 0.9rem; margin-bottom: 10px;">Impossible de charger les fichiers de l'application.</p>
                <ul style="text-align: left; font-size: 0.85rem; color: #7f1d1d; list-style-type: disc; padding-left: 20px;">
                    <li>Connectez-vous √† Internet (Wi-Fi/4G).</li>
                    <li>Rechargez la page.</li>
                    <li>Utilisez ensuite le bouton <b>"Installer pour Hors-Ligne"</b> dans le menu.</li>
                </ul>
                <button onclick="window.location.reload()" style="margin-top: 15px; padding: 10px 20px; background: #dc2626; color: white; border: none; border-radius: 5px; font-weight: bold;">R√©essayer</button>
            </div>

            <p id="loader-hint" style="color: #9ca3af; font-size: 0.8rem; margin-top: 20px; max-width: 300px;">
                Initialisation des composants...
            </p>
        </div>
    </div>

    <!-- Script de secours pour d√©tecter l'√©chec de chargement -->
    <script>
        setTimeout(function() {
            // Si React n'est pas charg√© apr√®s 8 secondes, c'est probablement un probl√®me r√©seau au d√©marrage
            if (!window.React) {
                document.getElementById('loader-spinner').style.display = 'none';
                document.getElementById('loader-text').style.display = 'none';
                document.getElementById('loader-hint').style.display = 'none';
                document.getElementById('offline-error').style.display = 'block';
            }
        }, 8000);
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const compressImage = (base64Str, maxWidth = 800, quality = 0.6) => {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = base64Str;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width; let height = img.height;
                    if (width > height) { if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } } 
                    else { if (height > maxWidth) { width *= maxWidth / height; height = maxWidth; } }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.onerror = (err) => resolve(base64Str);
            });
        };

        const useSharedCollection = (restaurantId, category, sortField = 'createdAt') => {
            const [data, setData] = useState([]);
            useEffect(() => {
                if (!window.db || !restaurantId) return;
                let q = window.appId === 'epack-prod-data' ? window.collection(window.db, 'haccp_data', restaurantId, category) : window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'haccp_items');
                
                const unsubscribe = window.onSnapshot(q, (snapshot) => {
                    let items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (window.appId !== 'epack-prod-data') { items = items.filter(item => item.restaurantId === restaurantId && item.category === category); }
                    items.sort((a, b) => {
                        if (a.order !== undefined && b.order !== undefined) return a.order - b.order;
                        return (b[sortField] || 0) - (a[sortField] || 0);
                    });
                    setData(items);
                }, (error) => {
                    console.error("Sync error:", error);
                });
                return () => unsubscribe();
            }, [restaurantId, category]);

            const addItem = async (item) => {
                if (!restaurantId) return;
                let itemToSave = { ...item };
                const isOffline = !navigator.onLine;

                if (item.rawFile) {
                    if (isOffline) {
                        console.log("Offline: Saving image directly to Firestore (High Quality)");
                        if (item.photo && item.photo.startsWith('data:')) { 
                            const compressed = await compressImage(item.photo, 1600, 0.85); 
                            itemToSave.photo = compressed; 
                        }
                        delete itemToSave.rawFile;
                    } else {
                        try {
                            const fileName = `${restaurantId}/${category}/${Date.now()}_${Math.random().toString(36).substr(2, 9)}.jpg`;
                            const storageRef = window.ref(window.storage, fileName);
                            const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout")), 10000));
                            await Promise.race([window.uploadBytes(storageRef, item.rawFile), timeoutPromise]);
                            const url = await window.getDownloadURL(storageRef);
                            itemToSave.photo = url; delete itemToSave.rawFile;
                        } catch (e) {
                            console.log("Upload failed, fallback base64", e);
                            if (item.photo && item.photo.startsWith('data:')) { 
                                const compressed = await compressImage(item.photo, 1600, 0.85); 
                                itemToSave.photo = compressed; 
                                delete itemToSave.rawFile; 
                            } 
                            else { delete itemToSave.photo; delete itemToSave.rawFile; }
                        }
                    }
                }
                if (itemToSave.order === undefined) itemToSave.order = Date.now();
                try {
                    if (window.appId === 'epack-prod-data') await window.addDoc(window.collection(window.db, 'haccp_data', restaurantId, category), { createdAt: Date.now(), ...itemToSave });
                    else await window.addDoc(window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'haccp_items'), { restaurantId, category, createdAt: Date.now(), ...itemToSave });
                } catch (e) { alert("Erreur sauvegarde: " + e.message); }
            };

            const deleteItem = async (id) => {
                try {
                    if (window.appId === 'epack-prod-data') await window.deleteDoc(window.doc(window.db, 'haccp_data', restaurantId, category, id));
                    else await window.deleteDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'haccp_items', id));
                } catch (e) { console.error("Delete error", e); }
            };

            const updateItem = async (id, newData) => {
                try {
                    if (window.appId === 'epack-prod-data') await window.updateDoc(window.doc(window.db, 'haccp_data', restaurantId, category, id), newData);
                    else await window.updateDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'haccp_items', id), newData);
                } catch (e) { console.error("Update error", e); }
            }
            return { data, addItem, deleteItem, updateItem };
        };

        const useSharedLogs = (restaurantId, logCategory) => {
            const [logs, setLogs] = useState({});
            useEffect(() => {
                if (!window.db || !restaurantId) return;
                let q = window.appId === 'epack-prod-data' ? window.collection(window.db, 'haccp_logs', restaurantId, logCategory) : window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'haccp_logs');
                const unsubscribe = window.onSnapshot(q, (snapshot) => {
                    const loadedLogs = {};
                    snapshot.docs.forEach(doc => {
                        const d = doc.data();
                        if (window.appId === 'epack-prod-data') loadedLogs[doc.id] = d.data;
                        else if (d.restaurantId === restaurantId && d.category === logCategory) loadedLogs[d.date] = d.data;
                    });
                    setLogs(loadedLogs);
                });
                return () => unsubscribe();
            }, [restaurantId, logCategory]);

            const updateLog = async (dateStr, dataToMerge) => {
                const existingData = logs[dateStr] || {};
                const newData = { ...existingData, ...dataToMerge };
                if (window.appId === 'epack-prod-data') await window.setDoc(window.doc(window.db, 'haccp_logs', restaurantId, logCategory, dateStr), { data: newData }, { merge: true });
                else {
                    const docId = `${restaurantId}_${logCategory}_${dateStr}`.replace(/[^a-zA-Z0-9]/g, '_');
                    await window.setDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'haccp_logs', docId), { restaurantId, category: logCategory, date: dateStr, data: newData }, { merge: true });
                }
            };
            return { logs, updateLog };
        };

        const Icon = ({ name, className }) => {
            const icons = {
                ScanBarcode: <><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></>,
                Thermometer: <path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z" />,
                ClipboardCheck: <><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M15 2H9a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1Z"/><path d="m9 14 2 2 4-4"/></>,
                Camera: <><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></>,
                ChevronRight: <path d="m9 18 6-6-6-6"/>,
                ChevronLeft: <path d="m15 18-6-6 6-6"/>,
                Trash2: <><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>,
                CheckCircle: <><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>,
                Menu: <><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></>,
                Save: <><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>,
                Plus: <><path d="M5 12h14"/><path d="M12 5v14"/></>,
                Calendar: <><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></>,
                Search: <><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></>,
                X: <><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>,
                Aperture: <><circle cx="12" cy="12" r="10"/><line x1="14.31" x2="20.05" y1="8" y2="17.94"/><line x1="9.69" x2="21.17" y1="8" y2="8"/><line x1="7.38" x2="13.12" y1="12" y2="2.06"/><line x1="9.69" x2="3.95" y1="16" y2="6.06"/><line x1="14.31" x2="2.83" y1="16" y2="16"/><line x1="16.62" x2="10.88" y1="12" y2="21.94"/></>,
                ZoomIn: <><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/><line x1="11" x2="11" y1="8" y2="14"/><line x1="8" x2="14" y1="11" y2="11"/></>,
                ZoomOut: <><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/><line x1="8" x2="14" y1="11" y2="11"/></>,
                Delete: <path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2zM18 13l-2.5-2.5L18 8"/>,
                Download: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></>,
                RotateCcw: <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>,
                Wifi: <><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></>,
                LogOut: <><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></>,
                Lock: <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />,
                Snowflake: <path d="M2 12h20M12 2v20M20 20 4 4m16 0L4 20M4.93 19.07l4.24-7.07m5.66 0l4.24 7.07M4.93 4.93l4.24 7.07m5.66 0l4.24-7.07"/>,
                Truck: <path d="M10 17h4V5H2v12h3m10 0h3l4-4V8h-7v9zm-9 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm11 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"/>,
                ArrowUp: <path d="M12 19V5M5 12l7-7 7 7"/>,
                ArrowDown: <path d="M12 5v14M5 12l7 7 7-7"/>,
                ClipboardList: <><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></>,
                WifiOff: <line x1="1" y1="1" x2="23" y2="23"></line>,
                Smartphone: <><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></>,
                Archive: <><polyline points="21 8 21 21 3 21 3 8"></polyline><rect width="22" height="5" x="1" y="3"></rect><line x1="10" x2="14" y1="12" y2="12"></line></>,
                SortAsc: <path d="M11 5h10M11 9h7M11 13h4M3 17l3 3 3-3M6 18V4"/>,
                Edit: <><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" /><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" /></>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || <circle cx="12" cy="12" r="10" />}
                    {name === 'WifiOff' && <><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/><line x1="2" y1="2" x2="22" y2="22"/></>}
                    {name === 'Lock' && <path d="M7 11V7a5 5 0 0 1 10 0v4" />}
                </svg>
            );
        };

        const Card = ({ children, className = "" }) => ( <div className={`bg-white rounded-xl shadow-sm border border-green-100 p-6 ${className}`}>{children}</div> );
        const Button = ({ children, onClick, variant = "primary", className = "", type="button", disabled=false }) => {
            const style = `px-6 py-3 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 active:scale-95 disabled:opacity-50 ${ variant === "primary" ? "bg-green-600 text-white hover:bg-green-700 shadow-md shadow-green-200" : variant === "secondary" ? "bg-white text-green-700 border-2 border-green-600 hover:bg-green-50" : variant === "danger" ? "bg-red-500 text-white hover:bg-red-600 shadow-md" : "bg-transparent text-gray-600 hover:bg-gray-100" } ${className}`;
            return <button type={type} onClick={onClick} disabled={disabled} className={style}>{children}</button>;
        };
        const Input = ({ label, ...props }) => ( <div className="mb-4"><label className="block text-sm font-semibold text-gray-700 mb-1">{label}</label><input className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none" {...props} /></div> );

        const AutocompleteInput = ({ label, value, onChange, options = [], placeholder, required=false }) => {
            const [suggestions, setSuggestions] = useState([]);
            const [show, setShow] = useState(false);
            const wrapperRef = useRef(null);
            useEffect(() => { const handleClickOutside = (event) => { if (wrapperRef.current && !wrapperRef.current.contains(event.target)) setShow(false); }; document.addEventListener("mousedown", handleClickOutside); return () => document.removeEventListener("mousedown", handleClickOutside); }, []);
            const handleChange = (e) => { const val = e.target.value; onChange(e); if (val.length > 0) { const uniqueOptions = [...new Set(options)]; const filtered = uniqueOptions.filter(opt => opt && opt.toLowerCase().includes(val.toLowerCase()) && opt !== val).slice(0, 5); setSuggestions(filtered); setShow(true); } else { setShow(false); } };
            const handleSelect = (val) => { onChange({ target: { value: val } }); setShow(false); };
            const handleFocus = () => { if (value && value.length > 0) { const uniqueOptions = [...new Set(options)]; const filtered = uniqueOptions.filter(opt => opt && opt.toLowerCase().includes(value.toLowerCase()) && opt !== value).slice(0, 5); if(filtered.length > 0) { setSuggestions(filtered); setShow(true); } } };
            return ( <div className="mb-4 relative" ref={wrapperRef}> {label && <label className="block text-sm font-semibold text-gray-700 mb-1">{label}</label>} <input className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none" value={value} onChange={handleChange} onFocus={handleFocus} placeholder={placeholder} required={required} autoComplete="off" /> {show && suggestions.length > 0 && (<ul className="absolute z-50 w-full bg-white border border-gray-200 rounded-lg shadow-xl mt-1 max-h-48 overflow-y-auto">{suggestions.map((s, i) => (<li key={i} className="p-3 hover:bg-green-50 cursor-pointer border-b last:border-b-0 text-gray-700 font-medium" onClick={() => handleSelect(s)}>{s}</li>))}</ul>)} </div> );
        };

        const useNetworkStatus = () => {
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            useEffect(() => {
                const handleOnline = () => setIsOnline(true);
                const handleOffline = () => setIsOnline(false);
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, []);
            return isOnline;
        };
        
        // --- COMPOSANT DE GESTION DU LOGO ---
        const LogoUploader = ({ restaurantId, className = "" }) => {
            const [logo, setLogo] = useState(null);
            const [loading, setLoading] = useState(false);
            const inputRef = useRef(null);

            useEffect(() => {
                if (!restaurantId || !window.db) return;
                // √âcoute de la configuration du restaurant
                const collectionRef = window.collection(window.db, window.appId === 'epack-prod-data' ? 'haccp_settings' : 'artifacts/' + window.appId + '/public/data/settings');
                const q = window.query(collectionRef, window.where('restaurantId', '==', restaurantId));
                
                const unsubscribe = window.onSnapshot(q, (snapshot) => {
                    if (!snapshot.empty) {
                        const data = snapshot.docs[0].data();
                        setLogo(data.logoUrl);
                    }
                });
                return () => unsubscribe();
            }, [restaurantId]);

            const handleUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setLoading(true);
                
                try {
                    // 1. Upload vers Storage
                    const storageRef = window.ref(window.storage, `logos/${restaurantId}_${Date.now()}.jpg`);
                    await window.uploadBytes(storageRef, file);
                    const url = await window.getDownloadURL(storageRef);
                    
                    // 2. Sauvegarde de l'URL dans Firestore (Settings)
                    const collectionRef = window.collection(window.db, window.appId === 'epack-prod-data' ? 'haccp_settings' : 'artifacts/' + window.appId + '/public/data/settings');
                    const q = window.query(collectionRef, window.where('restaurantId', '==', restaurantId));
                    const snapshot = await window.getDocs(q);
                    
                    if (!snapshot.empty) {
                        await window.updateDoc(snapshot.docs[0].ref, { logoUrl: url });
                    } else {
                        await window.addDoc(collectionRef, { restaurantId, logoUrl: url });
                    }
                } catch (err) {
                    console.error("Erreur upload logo", err);
                    alert("Erreur lors de l'envoi du logo. V√©rifiez votre connexion.");
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className={`relative group cursor-pointer flex-shrink-0 ${className}`} onClick={(e) => { e.stopPropagation(); inputRef.current?.click(); }} title="Changer le logo">
                    <input type="file" ref={inputRef} onChange={handleUpload} accept="image/*" className="hidden" />
                    {loading ? (
                        <div className="w-10 h-10 rounded-lg border-2 border-green-500 border-t-transparent animate-spin bg-white"></div>
                    ) : logo ? (
                        <img src={logo} alt="Logo Restaurant" className="w-12 h-12 object-contain rounded-lg bg-white border border-gray-200 shadow-sm hover:opacity-80 transition-opacity" />
                    ) : (
                        <div className="w-12 h-12 bg-green-50 rounded-lg flex items-center justify-center text-green-600 border border-green-200 hover:bg-green-100 transition-colors">
                            <Icon name="Camera" className="w-6 h-6" />
                        </div>
                    )}
                    {/* Petit badge d'√©dition au survol */}
                    <div className="absolute -bottom-1 -right-1 bg-white rounded-full p-1 shadow-md border border-gray-100 opacity-0 group-hover:opacity-100 transition-opacity">
                         <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-gray-600"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                    </div>
                </div>
            );
        };

        // --- MODULES ---
        const TraceabilityModule = ({ restaurantId }) => {
            const { data: products, addItem, deleteItem } = useSharedCollection(restaurantId, 'traceability', 'timestamp');
            const [newProduct, setNewProduct] = useState({ name: '', quantity: '', batch: '', photo: null, rawFile: null });
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [isWebcamOpen, setIsWebcamOpen] = useState(false);
            const [fullscreenPhoto, setFullscreenPhoto] = useState(null);
            const [isUploading, setIsUploading] = useState(false);
            const [zoomLevel, setZoomLevel] = useState(1);
            const [pan, setPan] = useState({ x: 0, y: 0 });
            const [tempPhoto, setTempPhoto] = useState(null);
            const [exportModalOpen, setExportModalOpen] = useState(false);
            const [exportMonth, setExportMonth] = useState(new Date().toISOString().slice(0, 7));
            const [isGenerating, setIsGenerating] = useState(false); // Renamed from isZipping
            const [hasAutoCleaned, setHasAutoCleaned] = useState(false);
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const fileInputRef = useRef(null);
            const nativeCameraInputRef = useRef(null);
            const touchStartDist = useRef(null);
            const startZoom = useRef(1);
            const panStart = useRef(null);
            const startPan = useRef({ x: 0, y: 0 });
            const productHistory = products.map(p => p.name);

            useEffect(() => { if (fullscreenPhoto) { setZoomLevel(1); setPan({x:0, y:0}); } }, [fullscreenPhoto]);
            useEffect(() => { if (products.length > 0 && !hasAutoCleaned) { const timer = setTimeout(async () => { const sixMonthsAgo = Date.now() - (180 * 24 * 60 * 60 * 1000); const oldItems = products.filter(p => { const itemDate = p.createdAt || (p.sortDate ? new Date(p.sortDate).getTime() : null); return itemDate && itemDate < sixMonthsAgo; }); if (oldItems.length > 0) { for (const item of oldItems) { try { await deleteItem(item.id); } catch (e) { console.warn("Erreur suppression auto", e); } } } setHasAutoCleaned(true); }, 5000); return () => clearTimeout(timer); } }, [products, hasAutoCleaned]);

            const handleCameraClick = () => { if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) { nativeCameraInputRef.current?.click(); } else { startWebcam(); } };
            const handleNativeCameraCapture = (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (event) => { setNewProduct(p => ({ ...p, photo: event.target.result, rawFile: file })); }; reader.readAsDataURL(file); } };
            const startWebcam = async () => { setTempPhoto(null); setIsWebcamOpen(true); try { const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }); setTimeout(() => { if (videoRef.current) videoRef.current.srcObject = stream; }, 100); } catch (e) { alert("Impossible d'acc√©der √† la webcam."); setIsWebcamOpen(false); } };
            const captureWebcam = () => { if (videoRef.current && canvasRef.current) { const v = videoRef.current; const c = canvasRef.current; c.width = v.videoWidth; c.height = v.videoHeight; c.getContext('2d').drawImage(v, 0, 0); c.toBlob((blob) => { const previewUrl = c.toDataURL('image/jpeg', 0.8); setTempPhoto({ preview: previewUrl, file: blob }); }, 'image/jpeg', 0.95); v.pause(); } };
            const retakePhoto = () => { setTempPhoto(null); if (videoRef.current) videoRef.current.play(); };
            const confirmPhoto = () => { if (tempPhoto) { setNewProduct(p => ({ ...p, photo: tempPhoto.preview, rawFile: tempPhoto.file })); } if(videoRef.current?.srcObject) videoRef.current.srcObject.getTracks().forEach(t => t.stop()); setIsWebcamOpen(false); setTempPhoto(null); };
            const handleSubmit = async (e) => { e.preventDefault(); setIsUploading(true); try { await addItem({ ...newProduct, sortDate: new Date().toISOString().split('T')[0] }); } catch (error) { console.error(error); } finally { setIsUploading(false); setNewProduct({ name: '', quantity: '', batch: '', photo: null, rawFile: null }); } };
            const filtered = products.filter(p => p.sortDate === selectedDate);
            const changeDate = (d) => { const date = new Date(selectedDate); date.setDate(date.getDate() + d); setSelectedDate(date.toISOString().split('T')[0]); };
            
            // --- NOUVELLE FONCTION DE G√âN√âRATION DE RAPPORT (REMPLACE LE ZIP) ---
            const generateReport = async () => {
                setIsGenerating(true);
                try {
                    const [year, month] = exportMonth.split('-');
                    // Filtrer les produits du mois s√©lectionn√©
                    const itemsToExport = products.filter(p => p.sortDate && p.sortDate.startsWith(exportMonth));
                    
                    if (itemsToExport.length === 0) {
                        alert("Aucune donn√©e trouv√©e pour ce mois.");
                        setIsGenerating(false);
                        return;
                    }

                    // Trier par date (du plus ancien au plus r√©cent pour le rapport)
                    itemsToExport.sort((a, b) => a.sortDate.localeCompare(b.sortDate));

                    // Cr√©ation du contenu HTML
                    let htmlContent = `
                        <!DOCTYPE html>
                        <html lang="fr">
                        <head>
                            <meta charset="UTF-8">
                            <title>Rapport Tra√ßabilit√© - ${month}/${year}</title>
                            <style>
                                body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f3f4f6; color: #1f2937; margin: 0; padding: 20px; }
                                .container { max-width: 1000px; margin: 0 auto; background: white; padding: 40px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
                                h1 { color: #166534; text-align: center; border-bottom: 2px solid #bbf7d0; padding-bottom: 20px; margin-bottom: 30px; }
                                .header-info { text-align: center; margin-bottom: 40px; color: #4b5563; font-style: italic; }
                                .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
                                .card { border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; break-inside: avoid; page-break-inside: avoid; background: #fff; }
                                .card img { width: 100%; height: 200px; object-fit: cover; border-bottom: 1px solid #e5e7eb; }
                                .card-content { padding: 15px; }
                                .date { font-size: 0.8em; color: #6b7280; margin-bottom: 5px; font-weight: bold; }
                                .product-name { font-size: 1.1em; font-weight: bold; color: #111827; margin-bottom: 5px; }
                                .details { font-size: 0.9em; color: #374151; }
                                .tag { display: inline-block; background: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 999px; font-size: 0.8em; font-weight: bold; margin-right: 5px; }
                                @media print {
                                    body { background: white; padding: 0; }
                                    .container { box-shadow: none; padding: 0; }
                                    .no-print { display: none; }
                                    .card { border: 1px solid #ccc; }
                                }
                            </style>
                        </head>
                        <body>
                            <div class="no-print" style="text-align: center; margin-bottom: 20px;">
                                <button onclick="window.print()" style="background: #166534; color: white; border: none; padding: 10px 20px; border-radius: 5px; font-size: 16px; cursor: pointer; font-weight: bold;">üñ®Ô∏è Imprimer / Enregistrer en PDF</button>
                                <p style="font-size: 12px; color: #666; margin-top: 5px;">Cliquez pour imprimer ou choisissez "Enregistrer au format PDF" dans la destination de l'imprimante.</p>
                            </div>
                            <div class="container">
                                <h1>Rapport de Tra√ßabilit√©</h1>
                                <div class="header-info">
                                    P√©riode : <strong>${month}/${year}</strong><br>
                                    Nombre d'√©tiquettes : <strong>${itemsToExport.length}</strong>
                                </div>
                                <div class="grid">
                    `;

                    // Boucle sur les produits
                    itemsToExport.forEach(item => {
                        const dateFormatted = item.sortDate.split('-').reverse().join('/');
                        htmlContent += `
                            <div class="card">
                                <img src="${item.photo}" alt="${item.name}" loading="lazy" onerror="this.src='https://placehold.co/400x300?text=Image+Non+Disponible'">
                                <div class="card-content">
                                    <div class="date">üìÖ ${dateFormatted}</div>
                                    <div class="product-name">${item.name}</div>
                                    <div class="details">
                                        ${item.quantity ? `<span class="tag">Qt√©: ${item.quantity}</span>` : ''}
                                        Lot/DLC: <strong>${item.batch || 'N/A'}</strong>
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    htmlContent += `
                                </div>
                                <div style="margin-top: 40px; text-align: center; font-size: 0.8em; color: #9ca3af; border-top: 1px solid #e5e7eb; padding-top: 20px;">
                                    G√©n√©r√© automatiquement par eHygi√®ne So'Chris le ${new Date().toLocaleDateString()}
                                </div>
                            </div>
                        </body>
                        </html>
                    `;

                    // T√©l√©chargement du fichier HTML
                    const blob = new Blob([htmlContent], { type: "text/html;charset=utf-8" });
                    saveAs(blob, `Rapport_Tracabilite_${restaurantId}_${exportMonth}.html`);
                    setExportModalOpen(false);

                } catch (e) {
                    console.error("Erreur g√©n√©ration rapport", e);
                    alert("Erreur lors de la cr√©ation du rapport : " + e.message);
                } finally {
                    setIsGenerating(false);
                }
            };

            const onTouchStart = (e) => { if (e.touches.length === 2) { touchStartDist.current = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY); startZoom.current = zoomLevel; } else if (e.touches.length === 1 && zoomLevel > 1) { panStart.current = { x: e.touches[0].pageX, y: e.touches[0].pageY }; startPan.current = { ...pan }; } };
            const onTouchMove = (e) => { if (e.touches.length === 2 && touchStartDist.current) { const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY); setZoomLevel(Math.min(Math.max(0.5, startZoom.current * (dist / touchStartDist.current)), 5)); e.stopPropagation(); } else if (e.touches.length === 1 && panStart.current && zoomLevel > 1) { setPan({ x: startPan.current.x + (e.touches[0].pageX - panStart.current.x), y: startPan.current.y + (e.touches[0].pageY - panStart.current.y) }); e.stopPropagation(); } };
            const onTouchEnd = () => { touchStartDist.current = null; panStart.current = null; };

            return (
                <div className="space-y-6 fade-in-element pb-24">
                    <div className="flex justify-between items-center"><h2 className="text-2xl font-bold text-green-800 flex items-center gap-2"><Icon name="ScanBarcode" className="w-8 h-8"/> Tra√ßabilit√©</h2><button onClick={() => setExportModalOpen(true)} className="px-4 py-2 bg-green-100 text-green-700 rounded-lg font-bold flex items-center gap-2 hover:bg-green-200 transition-colors"><Icon name="Download" className="w-5 h-5"/> Exporter</button></div>
                    <div className="grid lg:grid-cols-12 gap-6">
                        <div className="lg:col-span-4">
                            <Card className="border-2 border-green-100">
                                <form onSubmit={handleSubmit}>
                                    <div className="mb-4">{isUploading ? <div className="w-full py-8 bg-gray-50 rounded-xl flex flex-col items-center justify-center text-green-600 animate-pulse border-2 border-green-200"><Icon name="Wifi" className="mb-2 animate-bounce"/>Envoi vers le Cloud...</div> : newProduct.photo ? <div onClick={() => setNewProduct({...newProduct, photo: null, rawFile: null})} className="relative cursor-pointer group"><img src={newProduct.photo} className="w-full rounded-lg" /><div className="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 rounded-lg text-white font-bold"><Icon name="Trash2" className="mr-2"/> Retirer</div></div> : <div className="space-y-3"><button type="button" onClick={handleCameraClick} className="w-full py-8 bg-green-50 text-green-700 rounded-xl border-2 border-dashed border-green-300 flex flex-col items-center justify-center hover:bg-green-100 transition-colors"><Icon name="Aperture" className="w-8 h-8 mb-2"/> Scanner / Photo</button><div onClick={() => fileInputRef.current?.click()} className="text-center text-sm text-gray-400 underline cursor-pointer">Importer fichier</div><input type="file" ref={fileInputRef} onChange={handleNativeCameraCapture} accept="image/*" className="hidden"/><input type="file" ref={nativeCameraInputRef} onChange={handleNativeCameraCapture} accept="image/*" capture="environment" className="hidden"/></div>}</div>
                                    <AutocompleteInput label="Produit" value={newProduct.name} onChange={e => setNewProduct({...newProduct, name: e.target.value})} options={productHistory} required />
                                    {/* MODIF 1 : Ajout de l'input Quantit√© entre Produit et Lot */}
                                    <Input label="Quantit√©" value={newProduct.quantity} onChange={e => setNewProduct({...newProduct, quantity: e.target.value})} placeholder="Ex: 5 kg, 2 cartons..." />
                                    <Input label="Lot / DLC" value={newProduct.batch} onChange={e => setNewProduct({...newProduct, batch: e.target.value})} />
                                    <Button type="submit" className="w-full" disabled={!newProduct.name || !newProduct.photo || isUploading}>{isUploading ? "Enregistrement..." : "Enregistrer (Cloud)"}</Button>
                                </form>
                            </Card>
                        </div>
                        <div className="lg:col-span-8">
                             <div className="bg-white p-4 rounded-xl border flex justify-between items-center mb-4"><div className="flex items-center gap-2"><button onClick={() => changeDate(-1)}><Icon name="ChevronLeft" className="w-6 h-6"/></button><div className="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded-lg border border-gray-200"><Icon name="Calendar" className="w-5 h-5 text-green-600"/><input type="date" value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)} className="bg-transparent font-bold text-gray-700 outline-none" /></div><button onClick={() => changeDate(1)}><Icon name="ChevronRight" className="w-6 h-6"/></button></div><span className="text-sm text-gray-500">{filtered.length} produit(s)</span></div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                {filtered.length === 0 && <div className="col-span-full text-center py-10 text-gray-400">Rien ce jour.</div>}
                                {filtered.map(item => (<div key={item.id} className="bg-white rounded-lg border p-3 flex justify-between items-start"><div className="flex gap-3 w-full" onClick={() => setFullscreenPhoto(item.photo)}><img src={item.photo} className="w-20 h-20 object-cover rounded-lg bg-gray-100 cursor-zoom-in" /><div><p className="font-bold">{item.name}</p><p className="text-sm text-green-600">{item.quantity ? <span className="font-bold text-gray-700">Qt√©: {item.quantity}</span> : ''} {item.quantity && item.batch ? '‚Ä¢' : ''} {item.batch}</p></div></div><button onClick={() => deleteItem(item.id)} className="text-gray-300 hover:text-red-500"><Icon name="Trash2"/></button></div>))}
                            </div>
                        </div>
                    </div>
                    {exportModalOpen && (<div className="fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => !isGenerating && setExportModalOpen(false)}><div className="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl" onClick={e => e.stopPropagation()}><h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"><Icon name="Download" className="text-green-600"/> G√©n√©rer Rapport</h3><p className="text-gray-600 mb-4">Choisissez le mois :</p><input type="month" value={exportMonth} onChange={(e) => setExportMonth(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg mb-6 text-lg" disabled={isGenerating} /><div className="flex gap-3"><Button onClick={generateReport} className="flex-1" disabled={isGenerating}>{isGenerating ? "G√©n√©ration..." : "Cr√©er Rapport"}</Button><Button variant="ghost" onClick={() => setExportModalOpen(false)} disabled={isGenerating}>Annuler</Button></div></div></div>)}
                    {isWebcamOpen && (<div className="fixed inset-0 z-[100] bg-black flex flex-col"><div className="relative flex-1 w-full h-full overflow-hidden"><video ref={videoRef} autoPlay playsInline className={`absolute inset-0 w-full h-full object-cover ${tempPhoto ? 'hidden' : ''}`}></video>{tempPhoto && <img src={tempPhoto.preview} className="absolute inset-0 w-full h-full object-cover" />}{!tempPhoto ? (<><div className="absolute inset-0 flex items-center justify-center pointer-events-none"><div className="w-[80%] h-[60%] border-2 border-green-500/50 rounded-2xl relative"><div className="scan-line"></div></div></div><div className="absolute top-0 w-full p-4 flex justify-between items-center z-20 bg-gradient-to-b from-black/60 to-transparent"><span className="text-white font-bold tracking-wide drop-shadow-md">Scanner</span><button onClick={() => { if(videoRef.current?.srcObject) videoRef.current.srcObject.getTracks().forEach(t=>t.stop()); setIsWebcamOpen(false); }} className="p-3 bg-black/40 rounded-full text-white backdrop-blur-md border border-white/20"><Icon name="X" className="w-6 h-6"/></button></div><div className="absolute bottom-8 w-full flex justify-center z-20"><button onClick={captureWebcam} className="w-20 h-20 bg-white rounded-full border-4 border-gray-200/50 shadow-2xl active:scale-95 transition-transform flex items-center justify-center"><div className="w-16 h-16 bg-white rounded-full border-2 border-black"></div></button></div></>) : (<div className="absolute bottom-8 w-full flex justify-center gap-6 z-20 px-8"><button onClick={retakePhoto} className="flex-1 py-4 bg-red-500/90 backdrop-blur-md text-white rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg active:scale-95 border border-red-400"><Icon name="RotateCcw" className="w-6 h-6"/> Reprendre</button><button onClick={confirmPhoto} className="flex-1 py-4 bg-green-500 text-white rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg active:scale-95"><Icon name="CheckCircle" className="w-6 h-6"/> Valider</button></div>)}</div><canvas ref={canvasRef} className="hidden"></canvas></div>)}
                    {fullscreenPhoto && (<div className="fixed inset-0 z-[100] bg-black flex items-center justify-center overflow-hidden touch-none" onClick={() => setFullscreenPhoto(null)} onTouchStart={onTouchStart} onTouchMove={onTouchMove} onTouchEnd={onTouchEnd}><div className="absolute bottom-10 z-50 flex gap-4 pointer-events-auto" onClick={e => e.stopPropagation()}><button className="p-4 bg-white/20 backdrop-blur rounded-full text-white border border-white/30 active:scale-95" onClick={() => setZoomLevel(z => Math.max(0.5, z - 0.5))}><Icon name="ZoomOut"/></button><div className="px-4 py-2 bg-black/50 backdrop-blur rounded-full text-white font-mono flex items-center">{Math.round(zoomLevel * 100)}%</div><button className="p-4 bg-white/20 backdrop-blur rounded-full text-white border border-white/30 active:scale-95" onClick={() => setZoomLevel(z => Math.min(3, z + 0.5))}><Icon name="ZoomIn"/></button></div><button className="absolute top-4 right-4 p-3 bg-black/40 backdrop-blur rounded-full text-white border border-white/20 z-50 pointer-events-auto" onClick={() => setFullscreenPhoto(null)}><Icon name="X"/></button><div className="w-full h-full flex items-center justify-center overflow-hidden"><img src={fullscreenPhoto} style={{ transform: `translate(${pan.x}px, ${pan.y}px) scale(${zoomLevel})`, transition: (touchStartDist.current || panStart.current) ? 'none' : 'transform 0.2s ease-out' }} className="max-h-screen max-w-full object-contain pointer-events-auto" onClick={e => e.stopPropagation()} /></div></div>)}
                </div>
            );
        };

        const TemperatureModule = ({ restaurantId }) => {
            const { data: equipments, addItem: addEquip, deleteItem: removeEquip, updateItem: updateEquip } = useSharedCollection(restaurantId, 'equipments');
            const { logs: temps, updateLog } = useSharedLogs(restaurantId, 'temperatures');
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [showAdd, setShowAdd] = useState(false);
            const [newEquip, setNewEquip] = useState("");
            const [picker, setPicker] = useState({ open: false, id: null, name: '', period: '' });
            const [tempInput, setTempInput] = useState(''); 
            const [isSaved, setIsSaved] = useState(false);
            const [exportModalOpen, setExportModalOpen] = useState(false);
            const [exportMonth, setExportMonth] = useState(new Date().toISOString().slice(0, 7));
            const equipHistory = equipments.map(e => e.name);
            const changeDate = (d) => { const date = new Date(selectedDate); date.setDate(date.getDate() + d); setSelectedDate(date.toISOString().split('T')[0]); setIsSaved(false); };
            const handleNumClick = (n) => setTempInput(prev => prev + n);
            const handleDot = () => setTempInput(prev => prev.includes('.') ? prev : prev + '.');
            const handleClear = () => setTempInput('');
            const handleBackspace = () => setTempInput(prev => prev.slice(0, -1));
            const handleValidate = () => { updateLog(selectedDate, { [picker.name]: { ...(temps[selectedDate]?.[picker.name]||{}), [picker.period]: tempInput } }); setPicker({...picker, open: false}); setTempInput(''); setIsSaved(false); };
            const openPad = (equipId, equipName, period) => { setPicker({ open: true, id: equipId, name: equipName, period: period }); setTempInput(temps[selectedDate]?.[equipName]?.[period] || ''); };
            const getVal = (name, p) => temps[selectedDate]?.[name]?.[p] || '';
            const handleSaveDay = () => { setIsSaved(true); setTimeout(() => setIsSaved(false), 2000); };
            const KeypadButton = ({ label, onClick, className = "" }) => (<button onClick={onClick} className={`h-16 text-xl font-bold rounded-xl active-press transition-colors shadow-sm border border-gray-200 bg-white hover:bg-gray-50 text-gray-700 ${className}`}>{label}</button>);
            const moveEquip = async (index, direction) => {
                if ((direction === -1 && index === 0) || (direction === 1 && index === equipments.length - 1)) return;
                const itemA = equipments[index]; const itemB = equipments[index + direction];
                const orderA = itemA.order || 0; const orderB = itemB.order || 0;
                await updateEquip(itemA.id, { order: orderB }); await updateEquip(itemB.id, { order: orderA });
            };
            const generateExcel = () => {
                const [year, month] = exportMonth.split('-'); const daysInMonth = new Date(year, month, 0).getDate();
                let tableHTML = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="UTF-8"></head><body><h2 style="color:#166534; font-family:Arial;">Relev√© de Temp√©ratures - ${month}/${year}</h2><table border="1" style="border-collapse:collapse; font-family:Arial; width:100%;"><thead><tr style="background-color:#4ade80; color:white;"><th style="padding:10px;">Date</th><th style="padding:10px;">Matin (¬∞C)</th><th style="padding:10px;">Soir (¬∞C)</th></tr></thead><tbody>`;
                equipments.forEach(eq => { tableHTML += `<tr><td colspan="3" style="background-color:#dcfce7; color:#166534; font-weight:bold; font-size:14px; padding:10px; text-align:left; border-top: 2px solid #166534;">√âquipement : ${eq.name.toUpperCase()}</td></tr>`; let hasData = false; for(let i=1; i<=daysInMonth; i++) { const day = i.toString().padStart(2, '0'); const dateStr = `${year}-${month}-${day}`; const dayData = temps[dateStr] || {}; const m = dayData[eq.name]?.matin || ''; const s = dayData[eq.name]?.soir || ''; if (m || s) { hasData = true; tableHTML += `<tr><td style="padding:5px; text-align:center;">${day}/${month}/${year}</td><td style="padding:5px; text-align:center; ${m && (parseFloat(m) > 5 || parseFloat(m) < -25) ? 'color:red; font-weight:bold;' : ''}">${m}</td><td style="padding:5px; text-align:center; ${s && (parseFloat(s) > 5 || parseFloat(s) < -25) ? 'color:red; font-weight:bold;' : ''}">${s}</td></tr>`; } } if (!hasData) tableHTML += `<tr><td colspan="3" style="padding:5px; color:gray; font-style:italic; text-align:center;">Aucune donn√©e pour ce mois</td></tr>`; tableHTML += `<tr><td colspan="3" style="height:20px; border:none;"></td></tr>`; });
                tableHTML += `</tbody></table></body></html>`; const blob = new Blob([tableHTML], { type: 'application/vnd.ms-excel' }); const url = window.URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `Releve_Temperatures_${month}_${year}.xls`; a.click(); setExportModalOpen(false);
            };
            return (
                <div className="space-y-6 fade-in-element pb-32">
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"><h2 className="text-2xl font-bold text-green-800 flex items-center gap-2"><Icon name="Thermometer" className="w-8 h-8"/> Temp√©ratures</h2><div className="flex gap-2 w-full sm:w-auto"><button onClick={() => setExportModalOpen(true)} className="flex-1 sm:flex-none px-4 py-2 bg-green-100 text-green-700 rounded-lg font-bold flex items-center justify-center gap-2 hover:bg-green-200 transition-colors whitespace-nowrap"><Icon name="Download" className="w-5 h-5"/> Exporter</button><div className="flex items-center gap-4 bg-white p-2 rounded-lg border ml-auto"><button onClick={() => changeDate(-1)}><Icon name="ChevronLeft"/></button><div className="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded-lg border border-gray-200"><Icon name="Calendar" className="w-5 h-5 text-green-600"/><input type="date" value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)} className="bg-transparent font-bold text-gray-700 outline-none w-32" /></div><button onClick={() => changeDate(1)}><Icon name="ChevronRight"/></button></div></div></div>
                    <div className="grid gap-4">
                         {showAdd ? ( <Card className="bg-green-50 border-dashed border-2 border-green-300"><div className="flex gap-2"><AutocompleteInput placeholder="Nom de l'√©quipement..." value={newEquip} onChange={e=>setNewEquip(e.target.value)} options={equipHistory} /><Button onClick={() => { if(newEquip) { addEquip({name: newEquip}); setNewEquip(""); setShowAdd(false); } }}>OK</Button><Button variant="ghost" onClick={() => setShowAdd(false)}>X</Button></div></Card> ) : <button onClick={() => setShowAdd(true)} className="w-full py-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 font-bold hover:bg-green-50 flex items-center justify-center gap-2"><Icon name="Plus" className="w-5 h-5"/> Ajouter √©quipement</button>}
                        {equipments.map((eq, idx) => ( <Card key={eq.id} className="flex flex-col md:flex-row items-center gap-4 border-l-4 border-l-green-500 relative"><div className="w-full md:w-1/3 flex justify-between items-center"><div className="flex items-center gap-3"><div className="flex flex-col gap-1"><button onClick={() => moveEquip(idx, -1)} className="p-1 text-gray-300 hover:text-green-600 disabled:opacity-30" disabled={idx===0}><Icon name="ArrowUp" className="w-5 h-5"/></button><button onClick={() => moveEquip(idx, 1)} className="p-1 text-gray-300 hover:text-green-600 disabled:opacity-30" disabled={idx===equipments.length-1}><Icon name="ArrowDown" className="w-5 h-5"/></button></div><div className="font-bold text-lg">{eq.name}</div></div><button onClick={() => removeEquip(eq.id)} className="text-red-300 hover:text-red-500"><Icon name="Trash2" className="w-4 h-4"/></button></div><div className="flex gap-4 flex-1 w-full">{['matin', 'soir'].map(p => (<div key={p} className="flex-1"><label className="text-xs uppercase text-gray-400 font-bold">{p}</label><button onClick={() => openPad(eq.id, eq.name, p)} className={`w-full p-3 rounded-lg border-2 font-bold flex justify-between items-center ${getVal(eq.name, p) ? 'bg-green-50 border-green-500 text-green-700' : 'bg-gray-50'}`}>{getVal(eq.name, p) ? getVal(eq.name, p) + '¬∞C' : '--'} <Icon name="ChevronRight" className="w-4 h-4 rotate-90 opacity-50"/></button></div>))}</div></Card> ))}
                    </div>
                    <div className="fixed bottom-24 md:bottom-6 right-6 z-30"><button onClick={handleSaveDay} className={`flex items-center gap-3 px-8 py-4 rounded-full font-bold text-lg shadow-xl transition-all transform hover:scale-105 active:scale-95 ${isSaved ? 'bg-green-500 text-white' : 'bg-green-600 text-white hover:bg-green-700'}`}>{isSaved ? <Icon name="CheckCircle" className="w-6 h-6"/> : <Icon name="Save" className="w-6 h-6"/>}{isSaved ? 'Enregistr√© !' : 'Enregistrer'}</button></div>
                    {picker.open && (<div className="fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 fade-in-element" onClick={() => setPicker({...picker, open: false})}><div className="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}><div className="p-4 bg-green-600 text-white flex justify-between items-center"><h3 className="font-bold text-lg">{picker.name} <span className="text-sm font-normal opacity-80">({picker.period})</span></h3><button onClick={() => setPicker({...picker, open: false})}><Icon name="X" className="w-6 h-6"/></button></div><div className="p-4 bg-gray-50 border-b flex items-center justify-between"><div className="text-3xl font-bold text-gray-800 tracking-widest h-10 min-w-[100px]">{tempInput || <span className="text-gray-300">--</span>} <span className="text-sm text-gray-400">¬∞C</span></div><button onClick={handleBackspace} className="text-gray-400 hover:text-red-500 p-2"><Icon name="Delete" className="w-6 h-6"/></button></div><div className="p-4 bg-gray-100 grid grid-cols-3 gap-3">{[7, 8, 9, 4, 5, 6, 1, 2, 3].map(n => (<KeypadButton key={n} label={n} onClick={() => handleNumClick(n.toString())} />))}<KeypadButton label="-" onClick={() => !tempInput.includes('-') && setTempInput(prev => '-' + prev)} className="text-blue-600 bg-blue-50 border-blue-100" /><KeypadButton label="0" onClick={() => handleNumClick('0')} /><KeypadButton label="." onClick={handleDot} className="text-blue-600 bg-blue-50 border-blue-100" /><KeypadButton label="C" onClick={handleClear} className="bg-red-50 text-red-600 border-red-100" /><button onClick={handleValidate} className="col-span-2 h-16 bg-green-600 text-white rounded-xl font-bold text-lg shadow-md active:scale-95 transition-transform flex items-center justify-center gap-2"><Icon name="CheckCircle" className="w-6 h-6"/> Valider</button></div></div></div>)}
                    {exportModalOpen && (<div className="fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setExportModalOpen(false)}><div className="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl" onClick={e => e.stopPropagation()}><h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"><Icon name="Download" className="text-green-600"/> Exporter vers Excel</h3><p className="text-gray-600 mb-4">Choisissez le mois √† exporter :</p><input type="month" value={exportMonth} onChange={(e) => setExportMonth(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg mb-6 text-lg" /><div className="flex gap-3"><Button onClick={generateExcel} className="flex-1">T√©l√©charger</Button><Button variant="ghost" onClick={() => setExportModalOpen(false)}>Annuler</Button></div></div></div>)}
                </div>
            );
        };

        // --- NOUVEAU COMPOSANT GESTION STOCK CONGEL√â ---
        const FrozenStockView = ({ restaurantId, onBack }) => {
            const { data: stockItems, deleteItem } = useSharedCollection(restaurantId, 'frozen_stock', 'date');
            const [sortBy, setSortBy] = useState('date'); // 'date' | 'alpha'

            const sortedItems = [...stockItems].sort((a, b) => {
                if (sortBy === 'alpha') {
                    return (a.product || '').localeCompare(b.product || '');
                } else {
                    // Date desc (plus r√©cent en haut)
                    return (b.date || '').localeCompare(a.date || '');
                }
            });

            return (
                <div className="space-y-6 fade-in-element">
                    <div className="flex items-center gap-4">
                        <button onClick={onBack} className="p-2 bg-white rounded-lg border hover:bg-gray-50"><Icon name="ChevronLeft" className="w-6 h-6 text-gray-600"/></button>
                        <h2 className="text-2xl font-bold text-blue-800 flex items-center gap-2"><Icon name="Snowflake" className="w-8 h-8"/> Stock Congel√©</h2>
                    </div>

                    <div className="flex justify-between items-center bg-blue-50 p-3 rounded-lg border border-blue-100">
                        <span className="font-bold text-blue-800">{sortedItems.length} produits en stock</span>
                        <div className="flex gap-2">
                            <button onClick={() => setSortBy('date')} className={`px-3 py-1 rounded-md text-sm font-bold ${sortBy==='date' ? 'bg-blue-600 text-white' : 'bg-white text-blue-600'}`}>Date</button>
                            <button onClick={() => setSortBy('alpha')} className={`px-3 py-1 rounded-md text-sm font-bold flex items-center gap-1 ${sortBy==='alpha' ? 'bg-blue-600 text-white' : 'bg-white text-blue-600'}`}>A-Z <Icon name="SortAsc" className="w-4 h-4"/></button>
                        </div>
                    </div>

                    <div className="grid gap-3">
                        {sortedItems.map(item => (
                            <div key={item.id} className="bg-white p-4 rounded-xl border shadow-sm flex justify-between items-center">
                                <div>
                                    <div className="font-bold text-lg text-gray-800">{item.product}</div>
                                    <div className="text-sm text-gray-500 flex gap-3">
                                        <span className="flex items-center gap-1"><Icon name="Calendar" className="w-3 h-3"/> Ajout√© le {new Date(item.date).toLocaleDateString()}</span>
                                        {item.quantity && <span className="font-bold text-blue-600 bg-blue-50 px-2 rounded">Qt√©: {item.quantity}</span>}
                                    </div>
                                </div>
                                <button onClick={() => { if(confirm("Sortir ce produit du stock ?")) deleteItem(item.id); }} className="px-4 py-2 bg-red-50 text-red-600 rounded-lg font-bold border border-red-100 hover:bg-red-100 flex items-center gap-2">
                                    <Icon name="LogOut" className="w-4 h-4"/> Sortir
                                </button>
                            </div>
                        ))}
                        {sortedItems.length === 0 && (
                            <div className="text-center py-12 text-gray-400">
                                <Icon name="Archive" className="w-12 h-12 mx-auto mb-2 opacity-20"/>
                                <p>Le cong√©lateur est vide.</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const MonitoringModule = ({ restaurantId }) => {
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            
            // --- 1. Refroidissement / Cong√©lation ---
            const { data: coolings, addItem: addCooling, deleteItem: removeCooling, updateItem: updateCooling } = useSharedCollection(restaurantId, 'cooling_logs', 'startTime');
            const { addItem: addStock } = useSharedCollection(restaurantId, 'frozen_stock');
            const [showFrozenStock, setShowFrozenStock] = useState(false);
            const [editingId, setEditingId] = useState(null);

            const [newCooling, setNewCooling] = useState({ 
                type: 'Refroidissement', 
                start: '', end: '', product: '', tempIn: '', tempOut: '',
                quantity: '', addToStock: false 
            });
            
            const filteredCoolings = coolings.filter(c => c.sortDate === selectedDate);
            const coolingHistory = coolings.map(c => c.product);
            
            // --- 2. Livraison ---
            const { data: deliveries, addItem: addDelivery, deleteItem: removeDelivery } = useSharedCollection(restaurantId, 'delivery_logs', 'timestamp');
            const [newDelivery, setNewDelivery] = useState({ supplier: '', product: '', batch: '', dlc: '', temp: '', compliant: 'Oui', comment: '', photo: null });
            const filteredDeliveries = deliveries.filter(d => d.sortDate === selectedDate);
            const deliveryCameraRef = useRef(null);
            const supplierHistory = deliveries.map(d => d.supplier);
            const deliveryProductHistory = deliveries.map(d => d.product);

            // --- 3. Nettoyage (NOUVELLE LOGIQUE) ---
            const { data: zones, addItem: addZone, deleteItem: removeZone } = useSharedCollection(restaurantId, 'cleaning');
            const { logs, updateLog } = useSharedLogs(restaurantId, 'cleaning_logs');
            const [showAddZone, setShowAddZone] = useState(false);
            const [newZone, setNewZone] = useState({ name: "", freq: "Journalier" });
            const cleaningTaskHistory = zones.map(z => z.name);

            // Fonction intelligente pour calculer le statut d'une t√¢che selon sa fr√©quence
            const getTaskStatus = (task, targetDate) => {
                // 1. R√©cup√©rer toutes les dates o√π cette t√¢che a √©t√© faite, tri√©es de la plus r√©cente √† la plus ancienne
                const dates = Object.keys(logs).sort().reverse(); 
                let lastDoneDate = null;
                
                // 2. Trouver la derni√®re fois qu'elle a √©t√© faite (avant ou √©gal √† la date s√©lectionn√©e)
                for (const d of dates) {
                    if (d <= targetDate && logs[d]?.[task.id]) {
                        lastDoneDate = d;
                        break;
                    }
                }

                if (!lastDoneDate) return { isValid: false, label: "Jamais fait", color: "text-gray-400", bg: "bg-white", border: "border-gray-200" };

                // 3. Calculer l'√©cart en jours
                const d1 = new Date(targetDate);
                const d2 = new Date(lastDoneDate);
                const diffTime = Math.abs(d1 - d2);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

                // 4. D√©terminer si c'est valide selon la fr√©quence
                let isValid = false;
                if (task.freq === 'Journalier') isValid = (diffDays === 0);
                else if (task.freq === 'Hebdomadaire') isValid = (diffDays < 7);
                else if (task.freq === 'Mensuel') isValid = (diffDays < 30);

                // 5. Formater la date pour l'affichage
                let dateDisplay = lastDoneDate.split('-').reverse().slice(0, 2).join('/'); // JJ/MM
                if (diffDays === 0) dateDisplay = "Aujourd'hui";
                else if (diffDays === 1) dateDisplay = "Hier";

                return { 
                    isValid, 
                    label: isValid ? `‚úÖ Fait le ${dateDisplay}` : `‚ö†Ô∏è Dernier : ${dateDisplay}`,
                    color: isValid ? "text-green-600" : "text-orange-500",
                    bg: isValid ? "bg-green-50" : "bg-white",
                    border: isValid ? "border-green-600" : "border-gray-200"
                };
            };

            const toggleZone = (id) => {
                // Quand on clique, on inverse l'√©tat POUR LA DATE S√âLECTIONN√âE (Aujourd'hui g√©n√©ralement)
                // Si c'est d√©j√† fait aujourd'hui, √ßa l'enl√®ve.
                // Si c'√©tait fait il y a 3 jours (donc valide Hebdo), cliquer va le "refaire" pour aujourd'hui (mise √† jour de la date).
                const currentVal = logs[selectedDate]?.[id];
                updateLog(selectedDate, { [id]: !currentVal });
            };

            // Calcul de progression bas√© sur la validit√© (Smart Logic)
            const cleanProgress = zones.length === 0 ? 0 : Math.round((zones.filter(z => getTaskStatus(z, selectedDate).isValid).length / zones.length) * 100);

            // --- WEBCAM LOGIC ---
            const [isWebcamOpen, setIsWebcamOpen] = useState(false);
            const [tempPhoto, setTempPhoto] = useState(null);
            const videoRef = useRef(null);
            const canvasRef = useRef(null);

            const startWebcam = async () => { setTempPhoto(null); setIsWebcamOpen(true); try { const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }); setTimeout(() => { if (videoRef.current) videoRef.current.srcObject = stream; }, 100); } catch (e) { alert("Impossible d'acc√©der √† la webcam."); setIsWebcamOpen(false); } };
            const captureWebcam = () => { if (videoRef.current && canvasRef.current) { const v = videoRef.current; const c = canvasRef.current; c.width = v.videoWidth; c.height = v.videoHeight; c.getContext('2d').drawImage(v, 0, 0); c.toBlob((blob) => { const previewUrl = c.toDataURL('image/jpeg', 0.8); setTempPhoto({ preview: previewUrl, file: blob }); }, 'image/jpeg', 0.95); v.pause(); } };
            const retakePhoto = () => { setTempPhoto(null); if (videoRef.current) videoRef.current.play(); };
            const confirmPhoto = () => { 
                if (tempPhoto) { setNewDelivery({...newDelivery, photo: tempPhoto.preview, rawFile: tempPhoto.file}); } 
                if(videoRef.current?.srcObject) videoRef.current.srcObject.getTracks().forEach(t => t.stop()); 
                setIsWebcamOpen(false); setTempPhoto(null); 
            };
            
            const handleDeliveryCameraClick = () => { 
                if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) { deliveryCameraRef.current?.click(); } else { startWebcam(); } 
            };

            const changeDate = (d) => { const date = new Date(selectedDate); date.setDate(date.getDate() + d); setSelectedDate(date.toISOString().split('T')[0]); };

            const startEdit = (item) => {
                setEditingId(item.id);
                setNewCooling({ type: item.type || 'Refroidissement', start: item.start || '', end: item.end || '', product: item.product || '', tempIn: item.tempIn || '', tempOut: item.tempOut || '', quantity: item.quantity || '', addToStock: false });
                document.querySelector('.cooling-form')?.scrollIntoView({ behavior: 'smooth' });
            };
            const cancelEdit = () => { setEditingId(null); setNewCooling({ type: 'Refroidissement', start: '', end: '', product: '', tempIn: '', tempOut: '', quantity: '', addToStock: false }); };

            const submitCooling = async (e) => {
                e.preventDefault();
                if (editingId) { await updateCooling(editingId, { ...newCooling }); cancelEdit(); } 
                else {
                    await addCooling({ ...newCooling, sortDate: selectedDate, timestamp: Date.now() });
                    if (newCooling.type === 'Cong√©lation' && newCooling.addToStock) { await addStock({ product: newCooling.product, quantity: newCooling.quantity || '1', date: selectedDate, createdAt: Date.now() }); }
                    setNewCooling({ type: 'Refroidissement', start: '', end: '', product: '', tempIn: '', tempOut: '', quantity: '', addToStock: false });
                }
            };

            const handleDeliveryPhoto = (e) => { const file = e.target.files[0]; if(file) { const reader = new FileReader(); reader.onload = (ev) => setNewDelivery({...newDelivery, photo: ev.target.result, rawFile: file}); reader.readAsDataURL(file); } };
            const submitDelivery = async (e) => { e.preventDefault(); await addDelivery({ ...newDelivery, sortDate: selectedDate, timestamp: Date.now() }); setNewDelivery({ supplier: '', product: '', batch: '', dlc: '', temp: '', compliant: 'Oui', comment: '', photo: null }); };

            if (showFrozenStock) { return <FrozenStockView restaurantId={restaurantId} onBack={() => setShowFrozenStock(false)} />; }

            return (
                <div className="space-y-8 fade-in-element pb-24">
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"><h2 className="text-2xl font-bold text-green-800 flex items-center gap-2"><Icon name="ClipboardList" className="w-8 h-8"/> Suivi & Hygi√®ne</h2><div className="flex items-center gap-4 bg-white p-2 rounded-lg border ml-auto w-full sm:w-auto justify-between sm:justify-start"><button onClick={() => changeDate(-1)}><Icon name="ChevronLeft"/></button><div className="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded-lg border border-gray-200"><Icon name="Calendar" className="w-5 h-5 text-green-600"/><input type="date" value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)} className="bg-transparent font-bold text-gray-700 outline-none w-32" /></div><button onClick={() => changeDate(1)}><Icon name="ChevronRight"/></button></div></div>

                    {/* 1. Suivi des Denr√©es (Refroidissement / Cong√©lation) */}
                    {/* MODIF 2 : Correction Layout Mobile (plus de superposition du bouton Stock) */}
                    <Card className="border-l-4 border-l-blue-500 relative cooling-form">
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-2">
                            <h3 className="text-xl font-bold text-blue-800 flex items-center gap-2">
                                <Icon name="Snowflake" className="w-6 h-6"/> Refroidissement / Cong√©lation
                            </h3>
                            <button onClick={() => setShowFrozenStock(true)} className="w-full md:w-auto px-3 py-1.5 bg-blue-100 text-blue-700 text-sm font-bold rounded-lg hover:bg-blue-200 transition-colors flex items-center justify-center gap-2 border border-blue-200 shadow-sm">
                                <Icon name="Snowflake" className="w-4 h-4"/> Voir Stock Congel√©
                            </button>
                        </div>
                        
                        <form onSubmit={submitCooling} className={`grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 bg-blue-50 p-4 rounded-xl border border-blue-100 transition-all ${editingId ? 'ring-2 ring-orange-400' : ''}`}>
                            <div className="flex gap-2 col-span-full"><label className={`flex-1 p-2 text-center rounded-lg cursor-pointer border font-bold transition-all ${newCooling.type === 'Refroidissement' ? 'bg-blue-600 text-white border-blue-600 shadow-md' : 'bg-white text-gray-600 hover:bg-gray-50'}`}><input type="radio" className="hidden" name="type" checked={newCooling.type==='Refroidissement'} onChange={()=>setNewCooling({...newCooling, type:'Refroidissement'})} /> Refroidissement</label><label className={`flex-1 p-2 text-center rounded-lg cursor-pointer border font-bold transition-all ${newCooling.type === 'Cong√©lation' ? 'bg-blue-600 text-white border-blue-600 shadow-md' : 'bg-white text-gray-600 hover:bg-gray-50'}`}><input type="radio" className="hidden" name="type" checked={newCooling.type==='Cong√©lation'} onChange={()=>setNewCooling({...newCooling, type:'Cong√©lation'})} /> Cong√©lation</label></div>
                            <div className="col-span-full"><AutocompleteInput placeholder="Produit..." value={newCooling.product} onChange={e=>setNewCooling({...newCooling, product:e.target.value})} options={coolingHistory} required/></div>
                            <div className="flex gap-2"><div className="flex-1"><label className="text-xs font-bold text-gray-500 ml-1">T¬∞ D√©part</label><input type="number" placeholder="¬∞C" className="w-full p-3 rounded-lg border bg-white" value={newCooling.tempIn} onChange={e=>setNewCooling({...newCooling, tempIn:e.target.value})} /></div><div className="flex-1"><label className="text-xs font-bold text-gray-500 ml-1">T¬∞ Fin</label><input type="number" placeholder="¬∞C" className="w-full p-3 rounded-lg border bg-white" value={newCooling.tempOut} onChange={e=>setNewCooling({...newCooling, tempOut:e.target.value})} /></div></div>
                            <div className="flex gap-2"><div className="flex-1"><label className="text-xs font-bold text-gray-500 ml-1">Heure D√©but</label><input type="time" className="w-full p-3 rounded-lg border bg-white" value={newCooling.start} onChange={e=>setNewCooling({...newCooling, start:e.target.value})} required /></div><div className="flex-1"><label className="text-xs font-bold text-gray-500 ml-1">Heure Fin</label><input type="time" className="w-full p-3 rounded-lg border bg-white" value={newCooling.end} onChange={e=>setNewCooling({...newCooling, end:e.target.value})} /></div></div>
                            {newCooling.type === 'Cong√©lation' && !editingId && ( <div className="col-span-full bg-blue-100/50 p-3 rounded-lg border border-blue-200 animate-[fadeIn_0.3s]"><div className="flex items-center gap-4"><div className="flex-1"><label className="text-xs font-bold text-blue-700 ml-1">Quantit√© (facultatif)</label><input type="text" placeholder="Ex: 2kg, 3 bacs..." className="w-full p-2 rounded-lg border border-blue-200 text-sm" value={newCooling.quantity} onChange={e=>setNewCooling({...newCooling, quantity:e.target.value})} /></div><label className="flex items-center gap-2 font-bold text-blue-800 cursor-pointer select-none bg-white px-3 py-2 rounded-lg border border-blue-200 shadow-sm mt-4"><input type="checkbox" className="w-5 h-5 text-blue-600 rounded focus:ring-blue-500" checked={newCooling.addToStock} onChange={e=>setNewCooling({...newCooling, addToStock:e.target.checked})} />Ajouter au stock</label></div></div> )}
                            <div className="col-span-full flex gap-2"><Button type="submit" className={`flex-1 ${editingId ? 'bg-orange-500 hover:bg-orange-600' : 'bg-blue-600 hover:bg-blue-700'} text-white`}>{editingId ? 'Mettre √† jour' : 'Ajouter cycle'}</Button>{editingId && (<Button variant="ghost" onClick={cancelEdit} className="bg-gray-200 text-gray-700 hover:bg-gray-300">Annuler</Button>)}</div>
                        </form>
                        <div className="space-y-2">{filteredCoolings.map(c => (<div key={c.id} className={`flex justify-between items-center bg-gray-50 p-3 rounded-lg border ${editingId === c.id ? 'border-orange-400 bg-orange-50' : ''}`}><div><div className="font-bold text-gray-800">{c.product} <span className="text-xs font-normal text-blue-600 bg-blue-100 px-2 py-0.5 rounded-full">{c.type}</span></div><div className="text-sm text-gray-500">{c.start} ‚ûù {c.end || 'En cours'} {c.tempIn && c.tempOut && <span className="ml-2 font-mono text-xs bg-gray-200 px-1 rounded">({c.tempIn}¬∞C ‚ûù {c.tempOut}¬∞C)</span>}</div></div><div className="flex gap-2"><button onClick={() => startEdit(c)} className="p-2 text-blue-400 hover:text-blue-600 hover:bg-blue-50 rounded-full transition-colors" title="Modifier"><Icon name="Edit" className="w-5 h-5"/></button><button onClick={() => removeCooling(c.id)} className="p-2 text-red-300 hover:text-red-500 hover:bg-red-50 rounded-full transition-colors" title="Supprimer"><Icon name="Trash2" className="w-5 h-5"/></button></div></div>))}{filteredCoolings.length === 0 && <p className="text-center text-gray-400 italic text-sm">Aucun cycle enregistr√© ce jour.</p>}</div>
                    </Card>

                    {/* 2. R√©ception Marchandises */}
                    <Card className="border-l-4 border-l-orange-500">
                        <h3 className="text-xl font-bold text-orange-800 mb-4 flex items-center gap-2"><Icon name="Truck" className="w-6 h-6"/> R√©ception Marchandises</h3>
                        <form onSubmit={submitDelivery} className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-6 bg-orange-50 p-4 rounded-xl">
                            <AutocompleteInput placeholder="Fournisseur" value={newDelivery.supplier} onChange={e=>setNewDelivery({...newDelivery, supplier:e.target.value})} options={supplierHistory} required/>
                            <AutocompleteInput placeholder="Produit" value={newDelivery.product} onChange={e=>setNewDelivery({...newDelivery, product:e.target.value})} options={deliveryProductHistory} required/>
                            <div className="flex gap-2"><input placeholder="N¬∞ Lot" className="p-2 rounded border flex-1" value={newDelivery.batch} onChange={e=>setNewDelivery({...newDelivery, batch:e.target.value})} /><input placeholder="T¬∞C" type="number" className="p-2 rounded border w-24" value={newDelivery.temp} onChange={e=>setNewDelivery({...newDelivery, temp:e.target.value})} /></div>
                            <div className="flex gap-2"><select className={`p-2 rounded border flex-1 font-bold ${newDelivery.compliant==='Non'?'bg-red-50 text-red-600 border-red-300':'bg-white'}`} value={newDelivery.compliant} onChange={e=>setNewDelivery({...newDelivery, compliant:e.target.value})}><option value="Oui">Conforme</option><option value="Non">Non Conforme</option></select><input type="file" ref={deliveryCameraRef} onChange={handleDeliveryPhoto} accept="image/*" capture="environment" className="hidden"/><button type="button" onClick={handleDeliveryCameraClick} className={`flex-1 border rounded flex items-center justify-center gap-2 font-medium ${newDelivery.photo ? 'bg-green-100 text-green-700 border-green-300' : 'bg-white text-gray-500 border-gray-300 hover:bg-gray-50'}`}><Icon name="Camera" className="w-5 h-5"/> {newDelivery.photo ? 'Photo OK' : 'Photo'}</button></div>
                            {newDelivery.compliant === 'Non' && ( <textarea placeholder="Motif de non-conformit√©..." className="col-span-full p-3 rounded-lg border border-red-200 bg-red-50 text-red-700 placeholder-red-300 focus:ring-2 focus:ring-red-500 outline-none" rows="2" value={newDelivery.comment} onChange={e => setNewDelivery({...newDelivery, comment: e.target.value})} required /> )}
                            <Button type="submit" className="col-span-full bg-orange-600 hover:bg-orange-700 text-white">Valider r√©ception</Button>
                        </form>
                        <div className="space-y-2">{filteredDeliveries.map(d => ( <div key={d.id} className={`flex justify-between items-start bg-white p-3 rounded-lg border shadow-sm ${d.compliant === 'Non' ? 'border-l-4 border-l-red-500' : ''}`}><div className="flex gap-3">{d.photo && <img src={d.photo} className="w-12 h-12 object-cover rounded bg-gray-200" />}<div><div className="font-bold text-gray-800">{d.product} <span className="text-xs text-gray-500">({d.supplier})</span></div><div className="text-sm text-gray-600">Lot: {d.batch} ‚Ä¢ {d.temp}¬∞C ‚Ä¢ <span className={d.compliant==='Oui'?'text-green-600 font-bold':'text-red-600 font-bold'}>{d.compliant==='Oui'?'Conforme':'Non Conforme'}</span></div>{d.comment && <div className="text-xs text-red-500 mt-1 italic">‚ö†Ô∏è {d.comment}</div>}</div></div><button onClick={() => removeDelivery(d.id)} className="text-gray-300 hover:text-red-500"><Icon name="Trash2"/></button></div> ))}{filteredDeliveries.length === 0 && <p className="text-center text-gray-400 italic text-sm">Aucune livraison scann√©e ce jour.</p>}</div>
                    </Card>

                    {/* 3. Nettoyage (NOUVEAU DESIGN INTELLIGENT) */}
                    <div className="border-t pt-8">
                        <div className="flex justify-between items-end mb-4"><h3 className="text-xl font-bold text-gray-700 flex items-center gap-2"><Icon name="ClipboardCheck" className="w-6 h-6"/> Plan de Nettoyage</h3><span className={`text-2xl font-bold ${cleanProgress === 100 ? 'text-green-600' : 'text-orange-500'}`}>{cleanProgress}%</span></div>
                        <div className="w-full bg-gray-200 rounded-full h-2 mb-6"><div className={`h-2 rounded-full transition-all duration-500 ${cleanProgress === 100 ? 'bg-green-600' : 'bg-orange-400'}`} style={{width: `${cleanProgress}%`}}></div></div>
                        <div className="grid gap-3">
                            {zones.map(z => {
                                const status = getTaskStatus(z, selectedDate);
                                return ( 
                                    <div key={z.id} onClick={() => toggleZone(z.id)} className={`p-4 rounded-xl border cursor-pointer flex justify-between items-center transition-all shadow-sm active:scale-[0.98] ${status.bg} ${status.border}`}>
                                        <div className="flex flex-col">
                                            <h4 className="font-bold text-lg text-gray-800">{z.name}</h4>
                                            <span className="text-xs text-gray-400 font-medium bg-gray-100 px-2 py-0.5 rounded-full w-fit">{z.freq}</span>
                                        </div>
                                        <div className="flex items-center gap-4 text-right">
                                            <div className="flex flex-col items-end">
                                                <span className={`text-sm font-bold ${status.color}`}>{status.label}</span>
                                                <span className="text-[10px] text-gray-400">Cliquez pour {status.isValid ? 'refaire' : 'valider'}</span>
                                            </div>
                                            <div className={`w-8 h-8 rounded-full flex items-center justify-center transition-colors ${status.isValid ? 'bg-green-600 text-white shadow-lg shadow-green-200' : 'bg-gray-200 text-gray-400'}`}>
                                                {status.isValid && <Icon name="CheckCircle" />}
                                            </div>
                                            <button onClick={(e) => { e.stopPropagation(); removeZone(z.id); }} className="p-2 hover:bg-red-50 text-gray-300 hover:text-red-500 rounded-full"><Icon name="Trash2" className="w-5 h-5"/></button>
                                        </div>
                                    </div> 
                                );
                            })}
                            {showAddZone ? ( <Card className="bg-green-50 border-dashed border-2 border-green-300"><div className="flex flex-col gap-2"><AutocompleteInput placeholder="Nom de la t√¢che..." value={newZone.name} onChange={e=>setNewZone({...newZone, name: e.target.value})} options={cleaningTaskHistory} /><div className="flex gap-2"><select className="p-2 rounded border border-gray-300 bg-white flex-1" value={newZone.freq} onChange={e=>setNewZone({...newZone, freq: e.target.value})}><option value="Journalier">Journalier</option><option value="Hebdomadaire">Hebdomadaire</option><option value="Mensuel">Mensuel</option></select><Button className="flex-1" onClick={() => { if(newZone.name) { addZone(newZone); setNewZone({name:"", freq:"Journalier"}); setShowAddZone(false); } }}>Ajouter</Button></div><Button variant="ghost" onClick={() => setShowAddZone(false)} className="w-full text-sm py-1">Annuler</Button></div></Card> ) : <button onClick={() => setShowAddZone(true)} className="w-full py-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 font-bold hover:bg-green-50">+ Nouvelle t√¢che</button>}
                        </div>
                    </div>

                    {/* WEBCAM OVERLAY */}
                    {isWebcamOpen && (<div className="fixed inset-0 z-[100] bg-black flex flex-col"><div className="relative flex-1 w-full h-full overflow-hidden"><video ref={videoRef} autoPlay playsInline className={`absolute inset-0 w-full h-full object-cover ${tempPhoto ? 'hidden' : ''}`}></video>{tempPhoto && <img src={tempPhoto.preview} className="absolute inset-0 w-full h-full object-cover" />}{!tempPhoto ? (<><div className="absolute inset-0 flex items-center justify-center pointer-events-none"><div className="w-[80%] h-[60%] border-2 border-green-500/50 rounded-2xl relative"><div className="scan-line"></div></div></div><div className="absolute top-0 w-full p-4 flex justify-between items-center z-20 bg-gradient-to-b from-black/60 to-transparent"><span className="text-white font-bold tracking-wide drop-shadow-md">Scanner</span><button onClick={() => { if(videoRef.current?.srcObject) videoRef.current.srcObject.getTracks().forEach(t=>t.stop()); setIsWebcamOpen(false); }} className="p-3 bg-black/40 rounded-full text-white backdrop-blur-md border border-white/20"><Icon name="X" className="w-6 h-6"/></button></div><div className="absolute bottom-8 w-full flex justify-center z-20"><button onClick={captureWebcam} className="w-20 h-20 bg-white rounded-full border-4 border-gray-200/50 shadow-2xl active:scale-95 transition-transform flex items-center justify-center"><div className="w-16 h-16 bg-white rounded-full border-2 border-black"></div></button></div></>) : (<div className="absolute bottom-8 w-full flex justify-center gap-6 z-20 px-8"><button onClick={retakePhoto} className="flex-1 py-4 bg-red-500/90 backdrop-blur-md text-white rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg active:scale-95 border border-red-400"><Icon name="RotateCcw" className="w-6 h-6"/> Reprendre</button><button onClick={confirmPhoto} className="flex-1 py-4 bg-green-500 text-white rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg active:scale-95"><Icon name="CheckCircle" className="w-6 h-6"/> Valider</button></div>)}</div><canvas ref={canvasRef} className="hidden"></canvas></div>)}
                </div>
            );
        };

        const PinScreen = ({ onLogin, isLoading }) => {
            const [code, setCode] = useState(""); const [error, setError] = useState(false);
            const handleNum = (num) => { if (code.length < 6 && !isLoading) { const newCode = code + num; setCode(newCode); setError(false); if (newCode.length === 6) { onLogin(newCode); } } };
            const handleBackspace = () => setCode(prev => prev.slice(0, -1));
            return (
                <div className="flex flex-col items-center justify-center h-full bg-green-50 p-6 fade-in-element">
                    <div className="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm text-center border border-green-100">
                        <div className="mb-6"><div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-green-600"><Icon name="Lock" className="w-8 h-8"/></div><h2 className="text-2xl font-bold text-gray-800">Verrouill√©</h2><p className="text-gray-500 text-sm mt-1">{isLoading ? "Connexion..." : "Entrez le code de s√©curit√© (6 chiffres)"}</p></div>
                        <div className="flex justify-center gap-4 mb-8">{[0, 1, 2, 3, 4, 5].map(i => (<div key={i} className={`w-4 h-4 rounded-full transition-all duration-200 ${i < code.length ? (error ? 'bg-red-500' : 'bg-green-500') : 'bg-gray-200'}`}></div>))}</div>
                        <div className="grid grid-cols-3 gap-4 mb-4">{[1, 2, 3, 4, 5, 6, 7, 8, 9].map(n => (<button key={n} onClick={() => handleNum(n.toString())} disabled={isLoading} className="h-16 rounded-2xl bg-gray-50 text-2xl font-bold text-gray-700 active:bg-gray-200 active:scale-95 transition-all outline-none touch-manipulation disabled:opacity-50">{n}</button>))}<div className="h-16"></div><button onClick={() => handleNum('0')} disabled={isLoading} className="h-16 rounded-2xl bg-gray-50 text-2xl font-bold text-gray-700 active:bg-gray-200 active:scale-95 transition-all outline-none touch-manipulation disabled:opacity-50">0</button><button onClick={handleBackspace} disabled={isLoading} className="h-16 rounded-2xl flex items-center justify-center text-gray-400 active:bg-red-50 active:text-red-500 active:scale-95 transition-all outline-none touch-manipulation disabled:opacity-50"><Icon name="Delete" className="w-8 h-8"/></button></div>
                        {error && <p className="text-red-500 font-bold text-sm animate-bounce">Code incorrect ou erreur connexion</p>}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [restaurantId, setRestaurantId] = useState(localStorage.getItem('haccp_restaurant_id') || 'mon-restaurant');
            const [tab, setTab] = useState('traceability');
            const [isLocked, setIsLocked] = useState(!localStorage.getItem('haccp_app_unlocked'));
            const [isAuthLoading, setIsAuthLoading] = useState(true); 
            const [isLoginLoading, setIsLoginLoading] = useState(false);
            const [isCaching, setIsCaching] = useState(false);
            const isOnline = useNetworkStatus();

            useEffect(() => {
                const loader = document.getElementById('static-loader');
                if (loader) loader.style.display = 'none';

                let unsubscribe;
                const startAuth = async () => {
                    unsubscribe = window.onAuthStateChanged(window.auth, (u) => {
                        if (u) {
                            setUser(u);
                            setIsAuthLoading(false);
                        } else {
                            const doLogin = async () => {
                                try {
                                    if (window.initialAuthToken) { 
                                        await window.signInWithCustomToken(window.auth, window.initialAuthToken); 
                                    } else { 
                                        await window.signInAnonymously(window.auth); 
                                    }
                                } catch (e) {
                                    console.error("Erreur Auth", e);
                                    setIsAuthLoading(false);
                                }
                            };
                            doLogin();
                        }
                    });
                };
                startAuth();
                return () => { if(unsubscribe) unsubscribe(); };
            }, []);

            useEffect(() => { localStorage.setItem('haccp_restaurant_id', restaurantId); }, [restaurantId]);
            const handleLogin = async (code) => { if (code === '030613') { localStorage.setItem('haccp_app_unlocked', 'true'); setIsLocked(false); } else { alert("Code incorrect"); } };
            const handleLock = () => { localStorage.removeItem('haccp_app_unlocked'); setIsLocked(true); };
            
            const handleInstallCache = async () => {
                setIsCaching(true);
                alert("L'application va t√©l√©charger tous les fichiers n√©cessaires. Veuillez patienter...");
                const urlsToCache = [
                    "https://cdn.tailwindcss.com",
                    "https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js",
                    "https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js",
                    "https://unpkg.com/@babel/standalone/babel.min.js",
                    "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
                    "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js",
                    "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js",
                    "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js",
                    "https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js",
                    "https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"
                ];

                try {
                    await Promise.all(urlsToCache.map(url => fetch(url, { mode: 'cors' })));
                    alert("‚úÖ Succ√®s ! L'application est pr√™te.");
                } catch (e) {
                    alert("‚ö†Ô∏è Erreur lors du t√©l√©chargement. V√©rifiez votre connexion.");
                } finally {
                    setIsCaching(false);
                }
            };

            if (isAuthLoading) return <div className="flex items-center justify-center h-full text-green-700 font-bold animate-pulse">Chargement de vos donn√©es...</div>;
            if (isLocked) { return <PinScreen onLogin={handleLogin} isLoading={isLoginLoading} />; }
            
            const MenuBtn = ({ id, label, icon }) => ( <button onClick={() => setTab(id)} className={`w-full flex items-center gap-4 px-4 py-4 rounded-xl transition-all ${tab === id ? 'bg-green-600 text-white shadow-lg' : 'text-gray-600 hover:bg-green-50'}`}><Icon name={icon} className="w-6 h-6"/> <span className="font-semibold text-lg hidden lg:inline">{label}</span><span className="lg:hidden"><Icon name={icon} className="w-8 h-8"/></span></button> );

            return (
                <div className="flex h-[100dvh] bg-green-50/50 w-full overflow-hidden flex-col md:flex-row fade-in-element">
                    <div className="md:w-72 bg-white border-r border-gray-200 z-50 flex flex-col md:h-full shadow-xl order-2 md:order-1">
                        <div className="p-6 border-b hidden md:flex justify-start items-center gap-4">
                            <LogoUploader restaurantId={restaurantId} />
                            <div>
                                <h1 className="text-2xl font-extrabold text-green-700 leading-none">eHygi√®ne<span className="text-green-400">.</span></h1>
                                <p className="text-xs text-gray-400 font-medium">So'Chris</p>
                            </div>
                        </div>
                        <div className="p-4 bg-green-50 border-b hidden md:block"><p className="text-xs text-green-600 font-bold uppercase tracking-wider">Restaurant</p><p className="font-bold text-gray-800 truncate">{restaurantId}</p></div>
                        <nav className="p-2 space-y-2 flex-1 overflow-y-auto hidden md:block">
                            <MenuBtn id="traceability" label="Tra√ßabilit√©" icon="ScanBarcode"/>
                            <MenuBtn id="temperature" label="Temp√©ratures" icon="Thermometer"/>
                            <MenuBtn id="tracking" label="Suivi & Hygi√®ne" icon="ClipboardList"/>
                            
                            <div className="pt-4 mt-4 border-t px-2">
                                <button onClick={handleInstallCache} disabled={isCaching || !isOnline} className="w-full py-3 px-3 text-sm bg-orange-50 text-orange-700 hover:bg-orange-100 rounded-lg flex items-center gap-2 border border-orange-200 font-semibold disabled:opacity-50">
                                    <Icon name="Smartphone" className="w-5 h-5"/> {isCaching ? "T√©l√©chargement..." : "Installer pour Hors-Ligne"}
                                </button>
                            </div>
                        </nav>
                        <div className="p-4 border-t hidden md:block"><button onClick={handleLock} className="w-full py-2 text-sm text-red-500 hover:bg-red-50 rounded flex items-center justify-center gap-2"><Icon name="LogOut" className="w-4 h-4"/> Verrouiller</button></div>
                        <div className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around p-3 z-50 pb-safe">
                            <button onClick={() => setTab('traceability')} className={`flex flex-col items-center ${tab === 'traceability' ? 'text-green-600' : 'text-green-600/50'}`}><Icon name="ScanBarcode" className="w-6 h-6"/><span className="text-xs">Tra√ßabilit√©</span></button>
                            <button onClick={() => setTab('temperature')} className={`flex flex-col items-center ${tab === 'temperature' ? 'text-green-600' : 'text-green-600/50'}`}><Icon name="Thermometer" className="w-6 h-6"/><span className="text-xs">Temp√©ratures</span></button>
                            <button onClick={() => setTab('tracking')} className={`flex flex-col items-center ${tab === 'tracking' ? 'text-green-600' : 'text-green-600/50'}`}><Icon name="ClipboardList" className="w-6 h-6"/><span className="text-xs">Suivi</span></button>
                            <button onClick={handleInstallCache} className={`flex flex-col items-center text-orange-600/70`}><Icon name="Smartphone" className="w-6 h-6"/><span className="text-xs">Install</span></button>
                        </div>
                    </div>
                    <main className="flex-1 flex flex-col h-full overflow-hidden relative w-full order-1 md:order-2 pb-16 md:pb-0">
                        {/* HEADER MOBILE + BADGE OFFLINE + LOGO */}
                        <div className="md:hidden bg-white p-4 border-b flex justify-between items-center relative">
                            <div className="flex items-center gap-3">
                                <LogoUploader restaurantId={restaurantId} className="w-10 h-10" />
                                <h1 className="text-xl font-extrabold text-green-700">eHygi√®ne<span className="text-green-400">.</span></h1>
                            </div>
                            {!isOnline && <div className="absolute left-1/2 transform -translate-x-1/2 bg-orange-100 text-orange-600 px-3 py-1 rounded-full text-xs font-bold border border-orange-200 flex items-center gap-1 shadow-sm"><Icon name="WifiOff" className="w-3 h-3"/> Hors Ligne</div>}
                            <button onClick={handleLock} className="text-red-500"><Icon name="LogOut" className="w-6 h-6"/></button>
                        </div>
                         {/* HEADER DESKTOP BADGE OFFLINE */}
                         <div className="hidden md:flex absolute top-4 right-10 z-50">
                            {!isOnline && <div className="offline-badge"><Icon name="WifiOff" className="w-4 h-4"/> Mode Hors Ligne</div>}
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 lg:p-10 w-full">
                            <div className="max-w-5xl mx-auto w-full">
                                {tab === 'traceability' && <TraceabilityModule restaurantId={restaurantId} />}
                                {tab === 'temperature' && <TemperatureModule restaurantId={restaurantId} />}
                                {tab === 'tracking' && <MonitoringModule restaurantId={restaurantId} />}
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
