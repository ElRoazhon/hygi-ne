<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>eHygiène - HACCP (Mode Autonome)</title>
    
    <!-- 1. On charge Tailwind CSS (Design) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. On charge React et ReactDOM (Moteur de l'app) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. On charge Babel (Pour comprendre notre code) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- NOTE: J'ai retiré Firebase pour rendre l'app 100% autonome avec LocalStorage -->

    <style>
        /* Animation fluide */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.4s ease-out forwards; }
        /* Pour cacher la scrollbar sur mobile tout en scrollant */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-green-50 text-gray-900 h-screen overflow-hidden select-none">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- 1. GESTION DES DONNEES (LOCALSTORAGE) ---
        // Cette version remplace Firebase pour marcher partout sans config
        
        // Hook générique pour simuler une collection
        const useLocalCollection = (key, sortField = 'timestamp') => {
            const [data, setData] = useState([]);

            // Charger les données au démarrage
            useEffect(() => {
                const stored = localStorage.getItem(key);
                if (stored) {
                    try {
                        let parsed = JSON.parse(stored);
                        // Tri
                        parsed.sort((a, b) => (b[sortField] || 0) - (a[sortField] || 0));
                        setData(parsed);
                    } catch (e) { console.error("Erreur lecture", e); }
                }
            }, [key]);

            const saveData = (newData) => {
                setData(newData);
                localStorage.setItem(key, JSON.stringify(newData));
            };

            const addItem = async (item) => {
                const newItem = { 
                    ...item, 
                    id: Date.now().toString(), // ID unique simple
                    createdAt: Date.now() 
                };
                const newData = [newItem, ...data];
                saveData(newData);
            };

            const deleteItem = async (id) => {
                const newData = data.filter(i => i.id !== id);
                saveData(newData);
            };

            return { data, loading: false, addItem, deleteItem };
        };

        // Hook pour les logs (dictionnaire par date)
        const useLocalLogs = (key) => {
            const [logs, setLogs] = useState({});

            useEffect(() => {
                const stored = localStorage.getItem(key);
                if (stored) {
                    try { setLogs(JSON.parse(stored)); } catch (e) {}
                }
            }, [key]);

            const updateLog = async (dateStr, dataToMerge) => {
                const newLogs = { ...logs };
                // Fusionner les données existantes pour cette date avec les nouvelles
                newLogs[dateStr] = { ...(newLogs[dateStr] || {}), ...dataToMerge };
                setLogs(newLogs);
                localStorage.setItem(key, JSON.stringify(newLogs));
            };

            return { logs, updateLog };
        };

        // --- 2. ICÔNES ---
        const Icon = ({ name, className }) => {
            const icons = {
                ScanBarcode: <path d="M3 7V5a2 2 0 0 1 2-2h2m10 0h2a2 2 0 0 1 2 2v2m0 10v2a2 2 0 0 1-2 2h-2M5 21H3a2 2 0 0 1-2-2v-2m4-8h10m-2 4h2m-6 0h2m-6-8v12" />,
                Thermometer: <path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z" />,
                ClipboardCheck: <><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M15 2H9a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1Z"/><path d="m9 14 2 2 4-4"/></>,
                Camera: <><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></>,
                Trash2: <><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>,
                Save: <><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>,
                ChevronLeft: <path d="m15 18-6-6 6-6"/>,
                ChevronRight: <path d="m9 18 6-6-6-6"/>,
                Menu: <><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></>,
                Cloud: <path d="M17.5 19c0-1.7-1.3-3-3-3h-1.1c-.2-2.3-2.1-4-4.4-4-2.5 0-4.5 2-4.5 4.5 0 .4.1.8.1 1.2-1.8.3-3.1 1.8-3.1 3.7 0 2.1 1.7 3.8 3.8 3.8h11.2c1.7 0 3-1.3 3-3z"/>,
                Loader2: <path d="M21 12a9 9 0 1 1-6.219-8.56"/>,
                Plus: <><path d="M5 12h14"/><path d="M12 5v14"/></>,
                CheckCircle: <><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>,
                Calendar: <><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></>,
                Clock: <><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>,
                Search: <><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></>,
                X: <><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>,
                Aperture: <><circle cx="12" cy="12" r="10"/><line x1="14.31" x2="20.05" y1="8" y2="17.94"/><line x1="9.69" x2="21.17" y1="8" y2="8"/><line x1="7.38" x2="13.12" y1="12" y2="2.06"/><line x1="9.69" x2="3.95" y1="16" y2="6.06"/><line x1="14.31" x2="2.83" y1="16" y2="16"/><line x1="16.62" x2="10.88" y1="12" y2="21.94"/></>,
                ZoomIn: <><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/><line x1="11" x2="11" y1="8" y2="14"/><line x1="8" x2="14" y1="11" y2="11"/></>,
                ZoomOut: <><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/><line x1="8" x2="14" y1="11" y2="11"/></>,
                Focus: <><circle cx="12" cy="12" r="3"/><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/></>,
                TrendingUp: <><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></>,
                BarChart3: <><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></>,
                AlertTriangle: <><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || <circle cx="12" cy="12" r="10" />}
                </svg>
            );
        };

        // --- 3. COMPOSANTS UTILITAIRES ---
        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-xl shadow-sm border border-green-100 p-6 ${className}`}>{children}</div>
        );

        const Button = ({ children, onClick, variant = "primary", className = "", type="button", disabled=false }) => {
            const variants = {
                primary: "bg-green-600 text-white hover:bg-green-700 shadow-md shadow-green-200",
                secondary: "bg-white text-green-700 border-2 border-green-600 hover:bg-green-50",
                danger: "bg-red-50 text-red-600 border border-red-200 hover:bg-red-100",
                ghost: "bg-transparent text-gray-600 hover:bg-gray-100"
            };
            return (
                <button type={type} onClick={onClick} disabled={disabled} className={`px-6 py-3 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 active:scale-95 disabled:opacity-50 ${variants[variant]} ${className}`}>
                    {children}
                </button>
            );
        };

        const Input = ({ label, ...props }) => (
            <div className="mb-4">
                <label className="block text-sm font-semibold text-gray-700 mb-1">{label}</label>
                <input className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none transition-all" {...props} />
            </div>
        );

        // --- 4. MODULES ---
        
        // --- TRACABILITE ---
        const TraceabilityModule = () => {
            const { data: products, addItem, deleteItem } = useLocalCollection('haccp_traceability', 'timestamp');
            const [newProduct, setNewProduct] = useState({ name: '', batch: '', photo: null });
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [isWebcamOpen, setIsWebcamOpen] = useState(false);
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const fileInputRef = useRef(null);

            const startWebcam = async () => {
                setIsWebcamOpen(true);
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    setTimeout(() => { if (videoRef.current) videoRef.current.srcObject = stream; }, 100);
                } catch (e) { alert("Erreur webcam : Vérifiez que vous êtes sur un site sécurisé (https) ou localhost."); setIsWebcamOpen(false); }
            };

            const stopWebcam = () => {
                if (videoRef.current && videoRef.current.srcObject) {
                    videoRef.current.srcObject.getTracks().forEach(t => t.stop());
                }
                setIsWebcamOpen(false);
            };

            const captureWebcam = () => {
                const video = videoRef.current;
                const canvas = canvasRef.current;
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                setNewProduct(prev => ({ ...prev, photo: canvas.toDataURL('image/jpeg', 0.6) }));
                stopWebcam();
            };

            const handlePhoto = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = () => setNewProduct(p => ({ ...p, photo: reader.result }));
                    reader.readAsDataURL(file);
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!newProduct.name || !newProduct.photo) return;
                addItem({
                    ...newProduct,
                    dateString: new Date().toLocaleDateString('fr-FR'),
                    sortDate: new Date().toISOString().split('T')[0],
                    timestamp: Date.now()
                });
                setNewProduct({ name: '', batch: '', photo: null });
            };

            const filtered = products.filter(p => (p.sortDate || new Date(p.timestamp).toISOString().split('T')[0]) === selectedDate);
            const changeDate = (d) => { const date = new Date(selectedDate); date.setDate(date.getDate() + d); setSelectedDate(date.toISOString().split('T')[0]); };

            return (
                <div className="space-y-6 animate-fadeIn">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-green-800 flex items-center gap-2"><Icon name="ScanBarcode" className="w-8 h-8"/> Traçabilité</h2>
                    </div>
                    <div className="grid lg:grid-cols-12 gap-6">
                        <div className="lg:col-span-4">
                            <Card>
                                <form onSubmit={handleSubmit}>
                                    <div className="mb-4">
                                        {newProduct.photo ? (
                                            <div onClick={() => setNewProduct({...newProduct, photo: null})} className="relative cursor-pointer group">
                                                <img src={newProduct.photo} className="w-full rounded-lg" />
                                                <div className="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 rounded-lg text-white font-bold"><Icon name="Trash2" className="mr-2"/> Retirer</div>
                                            </div>
                                        ) : (
                                            <div className="space-y-3">
                                                <button type="button" onClick={startWebcam} className="w-full py-8 bg-green-50 text-green-700 rounded-xl border-2 border-dashed border-green-300 flex flex-col items-center justify-center hover:bg-green-100 transition-colors">
                                                    <Icon name="Camera" className="w-8 h-8 mb-2"/> Prendre photo
                                                </button>
                                                <div onClick={() => fileInputRef.current?.click()} className="text-center text-sm text-gray-400 underline cursor-pointer">Ou importer fichier</div>
                                                <input type="file" ref={fileInputRef} onChange={handlePhoto} accept="image/*" className="hidden"/>
                                            </div>
                                        )}
                                    </div>
                                    <Input label="Produit" value={newProduct.name} onChange={e => setNewProduct({...newProduct, name: e.target.value})} />
                                    <Input label="Lot / DLC" value={newProduct.batch} onChange={e => setNewProduct({...newProduct, batch: e.target.value})} />
                                    <Button type="submit" className="w-full" disabled={!newProduct.name || !newProduct.photo}><Icon name="Save" /> Enregistrer</Button>
                                </form>
                            </Card>
                        </div>
                        <div className="lg:col-span-8">
                             <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex justify-between items-center mb-4">
                                <div className="flex items-center gap-2">
                                    <button onClick={() => changeDate(-1)}><Icon name="ChevronLeft" className="w-6 h-6 text-gray-600"/></button>
                                    <span className="font-bold">{new Date(selectedDate).toLocaleDateString('fr-FR')}</span>
                                    <button onClick={() => changeDate(1)}><Icon name="ChevronRight" className="w-6 h-6 text-gray-600"/></button>
                                </div>
                                <span className="text-sm text-gray-500">{filtered.length} photo(s)</span>
                            </div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                {filtered.length === 0 && <div className="col-span-full text-center text-gray-400 py-8">Aucune photo pour cette date.</div>}
                                {filtered.map(item => (
                                    <div key={item.id} className="bg-white rounded-lg shadow-sm border p-3 flex justify-between items-start hover:shadow-md transition-shadow">
                                        <div className="flex gap-3">
                                            <img src={item.photo} className="w-20 h-20 object-cover rounded-lg bg-gray-100" />
                                            <div>
                                                <p className="font-bold">{item.name}</p>
                                                <p className="text-sm text-green-600">{item.batch}</p>
                                            </div>
                                        </div>
                                        <button onClick={() => deleteItem(item.id)} className="text-gray-300 hover:text-red-500"><Icon name="Trash2"/></button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                    {isWebcamOpen && (
                        <div className="fixed inset-0 z-50 bg-black flex flex-col animate-fadeIn">
                            <div className="p-4 flex justify-between text-white bg-black/50 absolute top-0 w-full z-10">
                                <span className="font-bold">Mode Photo</span><button onClick={stopWebcam}><Icon name="X"/></button>
                            </div>
                            <video ref={videoRef} autoPlay playsInline className="h-full object-cover"></video>
                            <canvas ref={canvasRef} className="hidden"></canvas>
                            <div className="absolute bottom-10 left-0 w-full flex justify-center">
                                <button onClick={captureWebcam} className="w-16 h-16 bg-white rounded-full border-4 border-gray-300 hover:border-green-500 transition-colors"></button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- TEMPERATURES ---
        const TemperatureModule = () => {
            const { data: equipments, addItem: addEquip, deleteItem: removeEquip } = useLocalCollection('haccp_equipments', 'createdAt');
            const { logs: temps, updateLog } = useLocalLogs('haccp_temperatures');
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [showAdd, setShowAdd] = useState(false);
            const [newName, setNewName] = useState("");
            const [picker, setPicker] = useState({ open: false, id: null, name: '', period: '' });

            // Données de base si vide
            useEffect(() => {
                if (equipments.length === 0) {
                     // Pas d'auto-seed pour éviter les doublons au rechargement, l'utilisateur cliquera sur le bouton
                }
            }, []);

            const seed = async () => { 
                if(equipments.length > 0) return;
                for (const n of ["Chambre Froide +", "Chambre Froide -", "Vitrine"]) await addEquip({name: n}); 
            };
            
            const changeDate = (d) => { const date = new Date(selectedDate); date.setDate(date.getDate() + d); setSelectedDate(date.toISOString().split('T')[0]); };
            
            const saveTemp = (val) => {
                const current = temps[selectedDate]?.[picker.name] || {};
                updateLog(selectedDate, { [picker.name]: { ...current, [picker.period]: val } });
                setPicker({...picker, open: false});
            };

            const getVal = (name, p) => temps[selectedDate]?.[name]?.[p] || '';

            return (
                <div className="space-y-6 animate-fadeIn">
                     <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-green-800 flex items-center gap-2"><Icon name="Thermometer" className="w-8 h-8"/> Relevés</h2>
                        <div className="flex items-center gap-4">
                            <button onClick={() => changeDate(-1)}><Icon name="ChevronLeft"/></button>
                            <span className="font-bold">{new Date(selectedDate).toLocaleDateString('fr-FR')}</span>
                            <button onClick={() => changeDate(1)}><Icon name="ChevronRight"/></button>
                        </div>
                    </div>

                    <div className="grid gap-4">
                        {equipments.length === 0 && (
                            <div className="text-center py-8">
                                <p className="text-gray-500 mb-4">Aucun équipement.</p>
                                <Button onClick={seed} variant="secondary">Charger la liste standard</Button>
                            </div>
                        )}
                        {equipments.map(eq => (
                            <Card key={eq.id} className="flex flex-col md:flex-row items-center gap-4 border-l-4 border-l-green-500 hover:shadow-md transition-shadow">
                                <div className="w-full md:w-1/3 flex justify-between">
                                    <span className="font-bold text-lg">{eq.name}</span>
                                    <button onClick={() => removeEquip(eq.id)} className="text-red-200 hover:text-red-500"><Icon name="Trash2" className="w-4 h-4"/></button>
                                </div>
                                <div className="flex gap-4 flex-1 w-full">
                                    {['matin', 'soir'].map(p => (
                                        <div key={p} className="flex-1">
                                            <label className="text-xs uppercase text-gray-400 font-bold">{p}</label>
                                            <button onClick={() => setPicker({open: true, id: eq.id, name: eq.name, period: p})} 
                                                className={`w-full p-3 rounded-lg border-2 font-bold flex justify-between items-center transition-all ${getVal(eq.name, p) ? 'bg-green-50 border-green-500 text-green-700' : 'bg-gray-50 hover:border-green-300'}`}>
                                                {getVal(eq.name, p) ? getVal(eq.name, p) + '°C' : '--'} <Icon name="ChevronRight" className="w-4 h-4 rotate-90 opacity-50"/>
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            </Card>
                        ))}
                        {showAdd ? (
                            <Card className="bg-green-50 border-dashed border-2 border-green-300">
                                <div className="flex gap-2">
                                    <input autoFocus placeholder="Nom de l'équipement..." className="flex-1 p-2 rounded outline-none" value={newName} onChange={e=>setNewName(e.target.value)} />
                                    <Button onClick={() => { if(newName) { addEquip({name: newName}); setNewName(""); setShowAdd(false); } }}>Ajouter</Button>
                                    <Button variant="ghost" onClick={() => setShowAdd(false)}>Annuler</Button>
                                </div>
                            </Card>
                        ) : (
                            <button onClick={() => setShowAdd(true)} className="w-full py-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 font-bold hover:bg-green-50 transition-colors">+ Ajouter un Frigo</button>
                        )}
                    </div>

                    {picker.open && (
                        <div className="fixed inset-0 z-50 bg-black/50 flex items-end sm:items-center justify-center animate-fadeIn" onClick={() => setPicker({...picker, open: false})}>
                            <div className="bg-white w-full sm:w-96 rounded-t-2xl sm:rounded-2xl p-4 shadow-2xl" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4">
                                     <h3 className="font-bold text-lg">{picker.name} <span className="text-green-600 uppercase text-sm">({picker.period})</span></h3>
                                     <button onClick={() => setPicker({...picker, open: false})}><Icon name="X"/></button>
                                </div>
                                <div className="grid grid-cols-4 gap-2 max-h-80 overflow-y-auto p-1">
                                    {Array.from({length: 61}, (_, i) => i - 40).reverse().map(t => (
                                        <button key={t} onClick={() => saveTemp(t)} className={`p-3 rounded font-bold border transition-colors ${t > 0 ? 'bg-white hover:bg-orange-50 border-gray-200' : 'bg-blue-50 hover:bg-blue-100 border-blue-100'}`}>
                                            {t > 0 ? '+' : ''}{t}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- NETTOYAGE ---
        const CleaningModule = () => {
            const { data: zones, addItem: addZone, deleteItem: removeZone } = useLocalCollection('haccp_cleaning_zones', 'createdAt');
            const { logs, updateLog } = useLocalLogs('haccp_cleaning_logs');
            const [showAdd, setShowAdd] = useState(false);
            const [newZone, setNewZone] = useState({ name: "", freq: "Journalier" });
            const today = new Date().toLocaleDateString('fr-FR').replace(/\//g, '-');

            const seed = async () => { 
                if(zones.length > 0) return;
                for (const z of [{ name: "Sol Cuisine", freq: "Journalier" }, { name: "Hotte", freq: "Hebdo" }]) await addZone(z); 
            };
            const toggle = (id) => updateLog(today, { [id]: !(logs[today]?.[id]) });
            const isDone = (id) => logs[today]?.[id];

            return (
                <div className="space-y-6 animate-fadeIn">
                    <h2 className="text-2xl font-bold text-green-800 flex items-center gap-2"><Icon name="ClipboardCheck" className="w-8 h-8"/> Nettoyage</h2>
                    <div className="grid gap-3">
                        {zones.length === 0 && <div className="text-center py-8"><Button onClick={seed} variant="secondary">Charger liste par défaut</Button></div>}
                        {zones.map(z => (
                            <div key={z.id} onClick={() => toggle(z.id)} className={`p-4 rounded-xl border cursor-pointer flex justify-between items-center transition-all ${isDone(z.id) ? 'bg-green-600 text-white border-green-700 shadow-md transform scale-[1.01]' : 'bg-white border-gray-200 hover:border-green-300'}`}>
                                <div>
                                    <h4 className="font-bold text-lg">{z.name}</h4>
                                    <span className={`text-xs px-2 py-0.5 rounded-full ${isDone(z.id) ? 'bg-green-500 text-green-50' : 'bg-gray-100 text-gray-500'}`}>{z.freq}</span>
                                </div>
                                <div className="flex gap-4 items-center">
                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center transition-colors ${isDone(z.id) ? 'bg-white text-green-600' : 'bg-gray-100 text-gray-300'}`}><Icon name="CheckCircle" /></div>
                                    <button onClick={(e) => { e.stopPropagation(); removeZone(z.id); }} className="p-2 hover:bg-white/20 rounded-full transition-colors"><Icon name="Trash2" className="w-5 h-5"/></button>
                                </div>
                            </div>
                        ))}
                        {showAdd ? (
                            <Card className="bg-green-50 border-dashed border-2 border-green-300">
                                <div className="flex flex-col gap-2">
                                    <input autoFocus placeholder="Tâche..." className="p-2 rounded outline-none" value={newZone.name} onChange={e=>setNewZone({...newZone, name: e.target.value})} />
                                    <select className="p-2 rounded outline-none bg-white" value={newZone.freq} onChange={e=>setNewZone({...newZone, freq: e.target.value})}>
                                        <option>Journalier</option><option>Hebdomadaire</option><option>Mensuel</option>
                                    </select>
                                    <div className="flex gap-2">
                                        <Button className="flex-1" onClick={() => { if(newZone.name) { addZone(newZone); setNewZone({name:"", freq:"Journalier"}); setShowAdd(false); } }}>Ajouter</Button>
                                        <Button variant="ghost" onClick={() => setShowAdd(false)}>Annuler</Button>
                                    </div>
                                </div>
                            </Card>
                        ) : (
                            <button onClick={() => setShowAdd(true)} className="w-full py-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 font-bold hover:bg-green-50 transition-colors">+ Nouvelle tâche</button>
                        )}
                    </div>
                </div>
            );
        };

        // --- 6. APPLICATION PRINCIPALE ---
        const App = () => {
            const [tab, setTab] = useState('traceability');
            const [sidebarOpen, setSidebarOpen] = useState(window.innerWidth >= 1024);

            // Plus de chargement infini "Connexion..."

            const MenuBtn = ({ id, label, icon }) => (
                <button onClick={() => { setTab(id); if(window.innerWidth < 1024) setSidebarOpen(false); }} 
                    className={`w-full flex items-center gap-4 px-4 py-4 rounded-xl transition-all ${tab === id ? 'bg-green-600 text-white shadow-lg shadow-green-200' : 'text-gray-600 hover:bg-green-50'}`}>
                    <Icon name={icon} className="w-6 h-6"/> <span className="font-semibold text-lg">{label}</span>
                </button>
            );

            return (
                <div className="flex h-screen overflow-hidden">
                    <div className={`fixed inset-y-0 left-0 z-40 w-72 bg-white border-r border-green-100 transform transition-transform duration-300 ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'} lg:relative lg:translate-x-0 shadow-xl lg:shadow-none`}>
                        <div className="p-8 border-b border-green-50"><h1 className="text-2xl font-extrabold text-green-700">eHygiène<span className="text-green-400">.</span></h1><p className="text-xs text-gray-400 font-bold uppercase mt-1">HACCP Autonome</p></div>
                        <nav className="p-4 space-y-2">
                            <MenuBtn id="traceability" label="Traçabilité" icon="ScanBarcode"/>
                            <MenuBtn id="temperature" label="Températures" icon="Thermometer"/>
                            <MenuBtn id="cleaning" label="Nettoyage" icon="ClipboardCheck"/>
                        </nav>
                        <div className="absolute bottom-0 w-full p-6 border-t bg-gray-50 flex items-center gap-3">
                            <div className="w-10 h-10 rounded-full bg-green-200 flex items-center justify-center text-green-700"><Icon name="Cloud"/></div>
                            <div><p className="text-sm font-bold">Mode Local</p><p className="text-xs text-green-600 flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> Actif</p></div>
                        </div>
                    </div>
                    {sidebarOpen && <div className="fixed inset-0 bg-black/20 z-30 lg:hidden backdrop-blur-sm" onClick={() => setSidebarOpen(false)}></div>}
                    <div className="flex-1 flex flex-col h-full overflow-hidden">
                        <div className="lg:hidden p-4 bg-white border-b flex items-center justify-between shadow-sm z-20">
                            <button onClick={() => setSidebarOpen(true)}><Icon name="Menu" className="w-6 h-6 text-gray-600"/></button>
                            <span className="font-bold text-green-700">eHygiène</span>
                            <div className="w-6"></div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 lg:p-10 pb-20 no-scrollbar">
                            <div className="max-w-7xl mx-auto">
                                {tab === 'traceability' && <TraceabilityModule />}
                                {tab === 'temperature' && <TemperatureModule />}
                                {tab === 'cleaning' && <CleaningModule />}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
