<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>eHygiène - So'Chris</title>
    
    <!-- SÉCURITÉ & OPTIMISATION CACHE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Cache-Control" content="public, max-age=31536000, immutable">
    
    <!-- PRÉ-CHARGEMENT DES RESSOURCES CRITIQUES (FAILSAFE) -->
    <link rel="preload" href="https://cdn.tailwindcss.com" as="script">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" as="script">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" as="script">
    <link rel="preload" href="https://unpkg.com/@babel/standalone/babel.min.js" as="script">
    <link rel="preload" href="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" as="script">
    <link rel="preload" href="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" as="script">
    <link rel="preload" href="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" as="script">
    <link rel="preload" href="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js" as="script">
    
    <!-- CONFIGURATION PWA IOS/ANDROID -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEyMCIgZmlsbD0iIzE2YTM0YSIvPjxwYXRoIGQ9Ik0yNTYgODBjMCAwIDE0MCAyNSAxNDAgMTQwYzAgMTAwLTgwIDE4MC0xNDAgMjEyYy02MC0zMi0xNDAtMTEyLTE0MC0yMTJjMC0xMTUgMTQwLTE0MCAxNDAtMTQweiIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZmZmIiBzdHJva2Utd2lkdGg9IjMwIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz48cGF0aCBkPSJNMzM2IDIwMGwtMTAwIDEwMGwtNjAtNjAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI2ZmZiIgc3Ryb2tlLXdpZHRoPSIzMCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+PC9zdmc+">
    <link rel="apple-touch-icon" id="dynamic-apple-icon" href="">
    <link rel="manifest" id="dynamic-manifest" href="">

    <meta name="apple-mobile-web-app-title" content="So'Chris">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#16a34a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">

    <script>
        // --- 1. GÉNÉRATION PWA ROBUSTE ---
        (function() {
            try {
                const svgIcon = `data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEyMCIgZmlsbD0iIzE2YTM0YSIvPjxwYXRoIGQ9Ik0yNTYgODBjMCAwIDE0MCAyNSAxNDAgMTQwYzAgMTAwLTgwIDE4MC0xNDAgMjEyYy02MC0zMi0xNDAtMTEyLTE0MC0yMTJjMC0xMTUgMTQwLTE0MCAxNDAtMTQweiIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZmZmIiBzdHJva2Utd2lkdGg9IjMwIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz48cGF0aCBkPSJNMzM2IDIwMGwtMTAwIDEwMGwtNjAtNjAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI2ZmZiIgc3Ryb2tlLXdpZHRoPSIzMCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+PC9zdmc+`;
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    canvas.width = 512; canvas.height = 512;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, 512, 512);
                    const pngUrl = canvas.toDataURL('image/png');
                    
                    const appleIcon = document.getElementById('dynamic-apple-icon');
                    if (appleIcon) appleIcon.href = pngUrl;
                    
                    const manifest = { 
                        "name": "eHygiène So'Chris", 
                        "short_name": "So'Chris", 
                        "start_url": ".", 
                        "display": "standalone", 
                        "orientation": "portrait",
                        "background_color": "#f0fdf4", 
                        "theme_color": "#16a34a", 
                        "scope": ".",
                        "icons": [ 
                            { "src": pngUrl, "sizes": "512x512", "type": "image/png", "purpose": "any maskable" },
                            { "src": pngUrl, "sizes": "192x192", "type": "image/png" } 
                        ] 
                    };
                    const stringManifest = JSON.stringify(manifest);
                    const blob = new Blob([stringManifest], {type: 'application/json'});
                    const manifestUrl = URL.createObjectURL(blob);
                    const manifestLink = document.getElementById('dynamic-manifest');
                    if (manifestLink) manifestLink.href = manifestUrl;
                };
                img.src = svgIcon;
            } catch(e) { console.error("PWA Init Error", e); }
        })();
    </script>

    <!-- CHARGEMENT ASYNCHRONE OPTIMISÉ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <script type="module">
        // --- 2. CONFIGURATION FIREBASE & OFFLINE PERSISTENCE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, query, where, setDoc, getDocs, enableIndexedDbPersistence, limit, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        let firebaseConfig;
        let appId;
        let initialAuthToken = null;

        try {
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
                appId = __app_id;
                if (typeof __initial_auth_token !== 'undefined') initialAuthToken = __initial_auth_token;
            } else {
                throw new Error("Env variables missing");
            }
        } catch (e) {
            console.log("Mode Secours (Fallback)");
            firebaseConfig = { apiKey: "AIzaSyCoMV_kNz-eI1JlLp33h0iJ4MZR7NnoI-w", authDomain: "epack-hygiene-99e64.firebaseapp.com", projectId: "epack-hygiene-99e64", storageBucket: "epack-hygiene-99e64.firebasestorage.app", messagingSenderId: "917463324646", appId: "1:917463324646:web:14856a7207be0353aca827" };
            appId = 'epack-prod-data'; 
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app); 

        // --- 3. PERSISTANCE INDEXEDDB CRITIQUE ---
        try {
            enableIndexedDbPersistence(db).catch((err) => {
                if (err.code == 'failed-precondition') {
                    console.warn("Persistance : onglet déjà ouvert.");
                } else if (err.code == 'unimplemented') {
                    console.warn("Persistance non supportée.");
                }
            });
        } catch(e) { console.log("Erreur init persistence", e); }

        // Exposition globale sécurisée
        window.db = db; window.auth = auth; window.storage = storage; window.appId = appId; window.initialAuthToken = initialAuthToken; 
        window.collection = collection; window.addDoc = addDoc; window.onSnapshot = onSnapshot; window.deleteDoc = deleteDoc; window.doc = doc; window.updateDoc = updateDoc; window.setDoc = setDoc;
        window.query = query; window.where = where; window.getDocs = getDocs; window.limit = limit; window.orderBy = orderBy;
        window.signInAnonymously = signInAnonymously; window.signInWithCustomToken = signInWithCustomToken; window.signOut = signOut; window.onAuthStateChanged = onAuthStateChanged;
        window.ref = ref; window.uploadBytes = uploadBytes; window.getDownloadURL = getDownloadURL;
        
        window.firebaseLoaded = true;
    </script>

    <style>
        body { -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .fade-in-element { animation: fadeIn 0.3s ease-out; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .active-press:active { transform: scale(0.95); background-color: #f3f4f6; }
        @keyframes scan { 0% { top: 10%; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 90%; opacity: 0; } }
        .scan-line { position: absolute; left: 10%; right: 10%; height: 2px; background: #4ade80; box-shadow: 0 0 10px #4ade80; animation: scan 2s linear infinite; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .offline-badge { background-color: #f97316; color: white; padding: 4px 12px; border-radius: 9999px; font-weight: bold; font-size: 0.8rem; box-shadow: 0 2px 4px rgba(0,0,0,0.2); animation: pulse 2s infinite; display: flex; align-items: center; gap: 6px; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
        
        #static-loader { position: fixed; inset: 0; background: #f0fdf4; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; font-family: sans-serif; text-align: center; padding: 20px; transition: opacity 0.5s; }
        .loader-spinner { width: 40px; height: 40px; border: 4px solid #dcfce7; border-top: 4px solid #16a34a; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #offline-error { display: none; color: #b91c1c; background: #fef2f2; padding: 20px; border-radius: 10px; border: 1px solid #fecaca; max-width: 90%; margin-top: 20px; }
    </style>
</head>
<body class="bg-green-50 text-gray-900 h-screen w-screen overflow-hidden select-none font-sans">
    
    <!-- LOADER (Hors de root pour éviter l'écrasement) -->
    <div id="static-loader">
        <div class="loader-spinner" id="loader-spinner"></div>
        <h2 style="color: #166534; font-weight: bold; font-size: 1.25rem; margin-bottom: 10px;">eHygiène So'Chris</h2>
        <p id="loader-text" style="color: #4b5563; font-size: 0.9rem;">Chargement des modules...</p>
        
        <div id="offline-error">
            <h3 style="font-weight: bold; margin-bottom: 5px;">Installation Requise</h3>
            <p style="font-size: 0.9rem; margin-bottom: 10px;">Le premier démarrage nécessite une connexion Internet.</p>
            <button onclick="window.location.reload()" style="margin-top: 15px; padding: 10px 20px; background: #16a34a; color: white; border: none; border-radius: 5px; font-weight: bold;">Réessayer</button>
        </div>
        
        <p id="cache-status" style="margin-top: 20px; color: #16a34a; font-size: 0.8rem; display:none;">Mise en cache pour hors-ligne...</p>
    </div>

    <!-- APP ROOT -->
    <div id="root" class="h-full w-full"></div>

    <!-- SCRIPT DE SECOURS (Si CDN HS) -->
    <script>
        setTimeout(function() {
            if (!window.React) {
                document.getElementById('loader-spinner').style.display = 'none';
                document.getElementById('loader-text').style.display = 'none';
                document.getElementById('offline-error').style.display = 'block';
            }
        }, 10000); 
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 4. GESTIONNAIRE DE CACHE IDB (Images Haute Qualité) ---
        const SimpleIDB = {
            dbName: 'SoChrisDrafts',
            storeName: 'drafts',
            version: 1,
            init: function() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(this.storeName)) {
                            db.createObjectStore(this.storeName);
                        }
                    };
                    request.onsuccess = (event) => resolve(event.target.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            },
            save: async function(key, value) {
                try {
                    const db = await this.init();
                    return new Promise((resolve, reject) => {
                        const tx = db.transaction(this.storeName, 'readwrite');
                        const store = tx.objectStore(this.storeName);
                        store.put(value, key);
                        tx.oncomplete = () => resolve();
                        tx.onerror = () => reject();
                    });
                } catch(e) { console.error("IDB Save Error", e); }
            },
            get: async function(key) {
                try {
                    const db = await this.init();
                    return new Promise((resolve, reject) => {
                        const tx = db.transaction(this.storeName, 'readonly');
                        const store = tx.objectStore(this.storeName);
                        const req = store.get(key);
                        req.onsuccess = () => resolve(req.result);
                        req.onerror = () => reject();
                    });
                } catch(e) { return null; }
            },
            delete: async function(key) {
                try {
                    const db = await this.init();
                    const tx = db.transaction(this.storeName, 'readwrite');
                    tx.objectStore(this.storeName).delete(key);
                } catch(e) {}
            }
        };

        const compressImage = (base64Str, maxWidth = 800, quality = 0.6) => {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = base64Str;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width; let height = img.height;
                    if (width > height) { if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } } 
                    else { if (height > maxWidth) { width *= maxWidth / height; height = maxWidth; } }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.onerror = (err) => resolve(base64Str);
            });
        };

        const useSharedCollection = (restaurantId, category, sortField = 'createdAt') => {
            const [data, setData] = useState([]);
            useEffect(() => {
                if (!window.db || !restaurantId) return;
                let q = window.appId === 'epack-prod-data' ? window.collection(window.db, 'haccp_data', restaurantId, category) : window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'haccp_items');
                
                const unsubscribe = window.onSnapshot(q, (snapshot) => {
                    let items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (window.appId !== 'epack-prod-data') { items = items.filter(item => item.restaurantId === restaurantId && item.category === category); }
                    items.sort((a, b) => {
                        if (a.order !== undefined && b.order !== undefined) return a.order - b.order;
                        return (b[sortField] || 0) - (a[sortField] || 0);
                    });
                    setData(items);
                }, (error) => {
                    console.warn("Mode Hors-ligne actif pour", category);
                });
                return () => unsubscribe();
            }, [restaurantId, category]);

            const addItem = async (item) => {
                if (!restaurantId) return;
                let itemToSave = { ...item };
                const isOffline = !navigator.onLine;

                if (item.rawFile) {
                    if (isOffline) {
                        // --- MODE HORS-LIGNE AVANCÉ ---
                        // 1. Sauvegarde Haute Qualité en local (IDB)
                        const offlineKey = `offline_hq_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;
                        await SimpleIDB.save(offlineKey, item.rawFile);

                        // 2. Génération Miniature (pour affichage immédiat sans saturer Firestore)
                        if (item.photo && item.photo.startsWith('data:')) {
                            // On crée une miniature très légère (150px) juste pour l'UI
                            const thumbnail = await compressImage(item.photo, 150, 0.5);
                            itemToSave.photo = thumbnail;
                        }

                        // 3. Marquage pour Synchro future
                        itemToSave.pendingUploadKey = offlineKey;
                        itemToSave.targetStoragePath = `${restaurantId}/${category}/${Date.now()}_${Math.random().toString(36).substr(2, 9)}.jpg`;
                        itemToSave.syncStatus = 'pending';
                        
                        delete itemToSave.rawFile;
                    } else {
                        // --- MODE EN LIGNE STANDARD ---
                        try {
                            const fileName = `${restaurantId}/${category}/${Date.now()}_${Math.random().toString(36).substr(2, 9)}.jpg`;
                            const storageRef = window.ref(window.storage, fileName);
                            // Timeout de secours
                            const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout Upload")), 10000));
                            await Promise.race([window.uploadBytes(storageRef, item.rawFile), timeoutPromise]);
                            const url = await window.getDownloadURL(storageRef);
                            itemToSave.photo = url; delete itemToSave.rawFile;
                        } catch (e) {
                            console.log("Upload échoué (réseau instable?), bascule en sauvegarde locale HQ", e);
                            // Repli stratégie hors-ligne si échec upload
                            const offlineKey = `offline_hq_${Date.now()}`;
                            await SimpleIDB.save(offlineKey, item.rawFile);
                            if (item.photo) itemToSave.photo = await compressImage(item.photo, 150, 0.5);
                            itemToSave.pendingUploadKey = offlineKey;
                            itemToSave.targetStoragePath = `${restaurantId}/${category}/${Date.now()}.jpg`;
                            itemToSave.syncStatus = 'pending';
                            delete itemToSave.rawFile;
                        }
                    }
                }
                if (itemToSave.order === undefined) itemToSave.order = Date.now();
                
                try {
                    // Sauvegarde du document (avec flag 'pending' si hors ligne)
                    let docRef;
                    if (window.appId === 'epack-prod-data') {
                        docRef = await window.addDoc(window.collection(window.db, 'haccp_data', restaurantId, category), { createdAt: Date.now(), ...itemToSave });
                    } else {
                        docRef = await window.addDoc(window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'haccp_items'), { restaurantId, category, createdAt: Date.now(), ...itemToSave });
                    }

                    // Ajout à la file d'attente locale (LocalStorage) pour robustesse
                    if (itemToSave.pendingUploadKey) {
                        const queue = JSON.parse(localStorage.getItem('offline_sync_queue') || '[]');
                        queue.push({
                            docId: docRef.id,
                            collectionType: window.appId === 'epack-prod-data' ? 'prod' : 'artifact',
                            collectionPath: category, // pour artifacts c'est le champ category
                            idbKey: itemToSave.pendingUploadKey,
                            storagePath: itemToSave.targetStoragePath
                        });
                        localStorage.setItem('offline_sync_queue', JSON.stringify(queue));
                    }

                } catch (e) { alert("Erreur sauvegarde: " + e.message); }
            };

            const deleteItem = async (id) => {
                try {
                    if (window.appId === 'epack-prod-data') await window.deleteDoc(window.doc(window.db, 'haccp_data', restaurantId, category, id));
                    else await window.deleteDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'haccp_items', id));
                } catch (e) { console.error("Delete error", e); }
            };

            const updateItem = async (id, newData) => {
                try {
                    if (window.appId === 'epack-prod-data') await window.updateDoc(window.doc(window.db, 'haccp_data', restaurantId, category, id), newData);
                    else await window.updateDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'haccp_items', id), newData);
                } catch (e) { console.error("Update error", e); }
            }
            return { data, addItem, deleteItem, updateItem };
        };

        const useSharedLogs = (restaurantId, logCategory) => {
            const [logs, setLogs] = useState({});
            useEffect(() => {
                if (!window.db || !restaurantId) return;
                let q = window.appId === 'epack-prod-data' ? window.collection(window.db, 'haccp_logs', restaurantId, logCategory) : window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'haccp_logs');
                const unsubscribe = window.onSnapshot(q, (snapshot) => {
                    const loadedLogs = {};
                    snapshot.docs.forEach(doc => {
                        const d = doc.data();
                        if (window.appId === 'epack-prod-data') loadedLogs[doc.id] = d.data;
                        else if (d.restaurantId === restaurantId && d.category === logCategory) loadedLogs[d.date] = d.data;
                    });
                    setLogs(loadedLogs);
                });
                return () => unsubscribe();
            }, [restaurantId, logCategory]);

            const updateLog = async (dateStr, dataToMerge) => {
                const existingData = logs[dateStr] || {};
                const newData = { ...existingData, ...dataToMerge };
                try {
                    if (window.appId === 'epack-prod-data') await window.setDoc(window.doc(window.db, 'haccp_logs', restaurantId, logCategory, dateStr), { data: newData }, { merge: true });
                    else {
                        const docId = `${restaurantId}_${logCategory}_${dateStr}`.replace(/[^a-zA-Z0-9]/g, '_');
                        await window.setDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'haccp_logs', docId), { restaurantId, category: logCategory, date: dateStr, data: newData }, { merge: true });
                    }
                } catch(e) { console.error("Log update error (offline safe)", e); }
            };
            return { logs, updateLog };
        };

        const Icon = ({ name, className }) => {
            const icons = {
                ScanBarcode: <><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></>,
                Thermometer: <path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z" />,
                ClipboardCheck: <><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M15 2H9a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1Z"/><path d="m9 14 2 2 4-4"/></>,
                Camera: <><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></>,
                ChevronRight: <path d="m9 18 6-6-6-6"/>,
                ChevronLeft: <path d="m15 18-6-6 6-6"/>,
                Trash2: <><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>,
                CheckCircle: <><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>,
                Menu: <><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></>,
                Save: <><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>,
                Plus: <><path d="M5 12h14"/><path d="M12 5v14"/></>,
                Calendar: <><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></>,
                Search: <><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></>,
                X: <><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>,
                Aperture: <><circle cx="12" cy="12" r="10"/><line x1="14.31" x2="20.05" y1="8" y2="17.94"/><line x1="9.69" x2="21.17" y1="8" y2="8"/><line x1="7.38" x2="13.12" y1="12" y2="2.06"/><line x1="9.69" x2="3.95" y1="16" y2="6.06"/><line x1="14.31" x2="2.83" y1="16" y2="16"/><line x1="16.62" x2="10.88" y1="12" y2="21.94"/></>,
                ZoomIn: <><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/><line x1="11" x2="11" y1="8" y2="14"/><line x1="8" x2="14" y1="11" y2="11"/></>,
                ZoomOut: <><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/><line x1="8" x2="14" y1="11" y2="11"/></>,
                Delete: <path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2zM18 13l-2.5-2.5L18 8"/>,
                Download: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></>,
                RotateCcw: <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>,
                Wifi: <><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></>,
                LogOut: <><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></>,
                Lock: <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />,
                Snowflake: <path d="M2 12h20M12 2v20M20 20 4 4m16 0L4 20M4.93 19.07l4.24-7.07m5.66 0l4.24 7.07M4.93 4.93l4.24 7.07m5.66 0l4.24-7.07"/>,
                Truck: <path d="M10 17h4V5H2v12h3m10 0h3l4-4V8h-7v9zm-9 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm11 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"/>,
                ArrowUp: <path d="M12 19V5M5 12l7-7 7 7"/>,
                ArrowDown: <path d="M12 5v14M5 12l7 7 7-7"/>,
                ClipboardList: <><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></>,
                WifiOff: <line x1="1" y1="1" x2="23" y2="23"></line>,
                Smartphone: <><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></>,
                CloudUpload: <path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242M12 12v9m-4-4 4-4 4 4" />
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || <circle cx="12" cy="12" r="10" />}
                    {name === 'WifiOff' && <><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/><line x1="2" y1="2" x2="22" y2="22"/></>}
                    {name === 'Lock' && <path d="M7 11V7a5 5 0 0 1 10 0v4" />}
                </svg>
            );
        };

        const Card = ({ children, className = "" }) => ( <div className={`bg-white rounded-xl shadow-sm border border-green-100 p-6 ${className}`}>{children}</div> );
        const Button = ({ children, onClick, variant = "primary", className = "", type="button", disabled=false }) => {
            const style = `px-6 py-3 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 active:scale-95 disabled:opacity-50 ${ variant === "primary" ? "bg-green-600 text-white hover:bg-green-700 shadow-md shadow-green-200" : variant === "secondary" ? "bg-white text-green-700 border-2 border-green-600 hover:bg-green-50" : variant === "danger" ? "bg-red-500 text-white hover:bg-red-600 shadow-md" : "bg-transparent text-gray-600 hover:bg-gray-100" } ${className}`;
            return <button type={type} onClick={onClick} disabled={disabled} className={style}>{children}</button>;
        };
        const Input = ({ label, ...props }) => ( <div className="mb-4"><label className="block text-sm font-semibold text-gray-700 mb-1">{label}</label><input className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none" {...props} /></div> );

        const AutocompleteInput = ({ label, value, onChange, options = [], placeholder, required=false }) => {
            const [suggestions, setSuggestions] = useState([]);
            const [show, setShow] = useState(false);
            const wrapperRef = useRef(null);
            useEffect(() => { const handleClickOutside = (event) => { if (wrapperRef.current && !wrapperRef.current.contains(event.target)) setShow(false); }; document.addEventListener("mousedown", handleClickOutside); return () => document.removeEventListener("mousedown", handleClickOutside); }, []);
            const handleChange = (e) => { const val = e.target.value; onChange(e); if (val.length > 0) { const uniqueOptions = [...new Set(options)]; const filtered = uniqueOptions.filter(opt => opt && opt.toLowerCase().includes(val.toLowerCase()) && opt !== val).slice(0, 5); setSuggestions(filtered); setShow(true); } else { setShow(false); } };
            const handleSelect = (val) => { onChange({ target: { value: val } }); setShow(false); };
            const handleFocus = () => { if (value && value.length > 0) { const uniqueOptions = [...new Set(options)]; const filtered = uniqueOptions.filter(opt => opt && opt.toLowerCase().includes(value.toLowerCase()) && opt !== value).slice(0, 5); if(filtered.length > 0) { setSuggestions(filtered); setShow(true); } } };
            return ( <div className="mb-4 relative" ref={wrapperRef}> {label && <label className="block text-sm font-semibold text-gray-700 mb-1">{label}</label>} <input className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none" value={value} onChange={handleChange} onFocus={handleFocus} placeholder={placeholder} required={required} autoComplete="off" /> {show && suggestions.length > 0 && (<ul className="absolute z-50 w-full bg-white border border-gray-200 rounded-lg shadow-xl mt-1 max-h-48 overflow-y-auto">{suggestions.map((s, i) => (<li key={i} className="p-3 hover:bg-green-50 cursor-pointer border-b last:border-b-0 text-gray-700 font-medium" onClick={() => handleSelect(s)}>{s}</li>))}</ul>)} </div> );
        };

        const useNetworkStatus = () => {
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            useEffect(() => {
                const handleOnline = () => setIsOnline(true);
                const handleOffline = () => setIsOnline(false);
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, []);
            return isOnline;
        };

        // --- GESTIONNAIRE DE SYNC DE PHOTOS (BACKGROUND) ---
        const SyncManager = ({ restaurantId }) => {
            const isOnline = useNetworkStatus();
            const [pendingCount, setPendingCount] = useState(0);

            useEffect(() => {
                const checkQueue = () => {
                    const queue = JSON.parse(localStorage.getItem('offline_sync_queue') || '[]');
                    setPendingCount(queue.length);
                };
                
                const interval = setInterval(checkQueue, 2000);
                return () => clearInterval(interval);
            }, []);

            useEffect(() => {
                const processQueue = async () => {
                    if (!isOnline) return;

                    const queue = JSON.parse(localStorage.getItem('offline_sync_queue') || '[]');
                    if (queue.length === 0) return;

                    console.log("Début synchro photos:", queue.length);

                    // Traitement UN par UN (séquentiel pour fiabilité)
                    const item = queue[0];
                    try {
                        // 1. Récupérer l'image HD locale
                        const blob = await SimpleIDB.get(item.idbKey);
                        if (!blob) {
                            console.warn("Image perdue pour", item.idbKey);
                            // On retire de la file pour ne pas bloquer
                            const newQueue = queue.slice(1);
                            localStorage.setItem('offline_sync_queue', JSON.stringify(newQueue));
                            return;
                        }

                        // 2. Upload vers Storage
                        const storageRef = window.ref(window.storage, item.storagePath);
                        await window.uploadBytes(storageRef, blob);
                        const url = await window.getDownloadURL(storageRef);

                        // 3. Mise à jour du document Firestore
                        const collectionRef = item.collectionType === 'prod' 
                            ? window.collection(window.db, 'haccp_data', restaurantId, item.collectionPath)
                            : window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'haccp_items');
                        
                        await window.updateDoc(window.doc(collectionRef, item.docId), {
                            photo: url,
                            syncStatus: 'synced',
                            pendingUploadKey: window.deleteField ? window.deleteField() : null
                        });

                        // 4. Nettoyage
                        await SimpleIDB.delete(item.idbKey);
                        const newQueue = queue.slice(1);
                        localStorage.setItem('offline_sync_queue', JSON.stringify(newQueue));
                        setPendingCount(newQueue.length);
                        console.log("Photo synchronisée !");

                    } catch (e) {
                        console.error("Erreur sync item", e);
                        // En cas d'erreur, on attend un peu avant de retenter (le useEffect se relancera si online change ou au prochain montage)
                    }
                };

                if (isOnline && pendingCount > 0) {
                    processQueue();
                }
            }, [isOnline, pendingCount, restaurantId]);

            if (pendingCount === 0) return null;

            return (
                <div className="fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white px-4 py-2 rounded-full shadow-lg z-50 flex items-center gap-2 text-sm font-bold animate-pulse">
                    <Icon name="CloudUpload" className="w-4 h-4" />
                    Synchro photos ({pendingCount})...
                </div>
            );
        };

        // --- MODULES ---
        const TraceabilityModule = ({ restaurantId }) => {
            const { data: products, addItem, deleteItem } = useSharedCollection(restaurantId, 'traceability', 'timestamp');
            const [newProduct, setNewProduct] = useState({ name: '', batch: '', photo: null, rawFile: null });
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [isWebcamOpen, setIsWebcamOpen] = useState(false);
            const [fullscreenPhoto, setFullscreenPhoto] = useState(null);
            const [isUploading, setIsUploading] = useState(false);
            const [zoomLevel, setZoomLevel] = useState(1);
            const [pan, setPan] = useState({ x: 0, y: 0 });
            const [tempPhoto, setTempPhoto] = useState(null);
            const [exportModalOpen, setExportModalOpen] = useState(false);
            const [exportMonth, setExportMonth] = useState(new Date().toISOString().slice(0, 7));
            const [isZipping, setIsZipping] = useState(false);
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const fileInputRef = useRef(null);
            const nativeCameraInputRef = useRef(null);
            const touchStartDist = useRef(null);
            const startZoom = useRef(1);
            const panStart = useRef(null);
            const startPan = useRef({ x: 0, y: 0 });
            const productHistory = products.map(p => p.name);

            useEffect(() => { if (fullscreenPhoto) { setZoomLevel(1); setPan({x:0, y:0}); } }, [fullscreenPhoto]);
            
            useEffect(() => {
                const loadDraft = async () => {
                    const savedDraft = localStorage.getItem('draft_traceability_meta');
                    const savedImage = await SimpleIDB.get('draft_traceability_photo');
                    
                    if (savedDraft) {
                        try { 
                            const parsed = JSON.parse(savedDraft);
                            if (savedImage) parsed.photo = savedImage;
                            setNewProduct(parsed); 
                        } catch (e) { console.error("Erreur lecture brouillon", e); }
                    }
                };
                loadDraft();
            }, []);

            useEffect(() => {
                if (newProduct.name || newProduct.batch) {
                    const meta = { ...newProduct, photo: null, rawFile: null }; 
                    try { localStorage.setItem('draft_traceability_meta', JSON.stringify(meta)); } catch (e) {}
                }
            }, [newProduct.name, newProduct.batch]);

            const handleCameraClick = () => { if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) { nativeCameraInputRef.current?.click(); } else { startWebcam(); } };
            
            const handleNativeCameraCapture = async (e) => { 
                const file = e.target.files[0]; 
                if (file) { 
                    const reader = new FileReader(); 
                    reader.onload = async (event) => { 
                        const compressed = await compressImage(event.target.result, 1000, 0.7);
                        await SimpleIDB.save('draft_traceability_photo', compressed);
                        setNewProduct(p => ({ ...p, photo: compressed, rawFile: file })); 
                    }; 
                    reader.readAsDataURL(file); 
                } 
            };

            const startWebcam = async () => { setTempPhoto(null); setIsWebcamOpen(true); try { const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }); setTimeout(() => { if (videoRef.current) videoRef.current.srcObject = stream; }, 100); } catch (e) { alert("Impossible d'accéder à la webcam."); setIsWebcamOpen(false); } };
            const captureWebcam = () => { if (videoRef.current && canvasRef.current) { const v = videoRef.current; const c = canvasRef.current; c.width = v.videoWidth; c.height = v.videoHeight; c.getContext('2d').drawImage(v, 0, 0); c.toBlob((blob) => { const previewUrl = c.toDataURL('image/jpeg', 0.8); setTempPhoto({ preview: previewUrl, file: blob }); }, 'image/jpeg', 0.95); v.pause(); } };
            const retakePhoto = () => { setTempPhoto(null); if (videoRef.current) videoRef.current.play(); };
            
            const confirmPhoto = async () => { 
                if (tempPhoto) { 
                    const compressed = await compressImage(tempPhoto.preview, 1000, 0.7);
                    await SimpleIDB.save('draft_traceability_photo', compressed);
                    setNewProduct(p => ({ ...p, photo: compressed, rawFile: tempPhoto.file })); 
                } 
                if(videoRef.current?.srcObject) videoRef.current.srcObject.getTracks().forEach(t => t.stop()); 
                setIsWebcamOpen(false); setTempPhoto(null); 
            };

            const handleSubmit = async (e) => { 
                e.preventDefault(); 
                setIsUploading(true); 
                try { 
                    await addItem({ ...newProduct, sortDate: new Date().toISOString().split('T')[0] });
                    localStorage.removeItem('draft_traceability_meta');
                    await SimpleIDB.delete('draft_traceability_photo');
                } catch (error) { console.error(error); } finally { 
                    setIsUploading(false); 
                    setNewProduct({ name: '', batch: '', photo: null, rawFile: null }); 
                } 
            };
            const filtered = products.filter(p => p.sortDate === selectedDate);
            const changeDate = (d) => { const date = new Date(selectedDate); date.setDate(date.getDate() + d); setSelectedDate(date.toISOString().split('T')[0]); };
            const downloadPhotos = async () => { setIsZipping(true); try { const zip = new JSZip(); const folder = zip.folder(`Photos_${exportMonth}`); const itemsToExport = products.filter(p => p.sortDate && p.sortDate.startsWith(exportMonth) && p.photo); if (itemsToExport.length === 0) { alert("Aucune photo trouvée pour ce mois."); setIsZipping(false); return; } let count = 0; for (const item of itemsToExport) { try { let blob = await (await fetch(item.photo)).blob(); const safeName = (item.name || 'produit').replace(/[^a-z0-9]/gi, '_'); const filename = `${item.sortDate}_${safeName}_${item.id.substr(0,4)}.jpg`; folder.file(filename, blob); count++; } catch (e) { console.error("Erreur téléchargement image", item, e); } } if (count > 0) { const content = await zip.generateAsync({ type: "blob" }); saveAs(content, `Traceabilite_${restaurantId}_${exportMonth}.zip`); setExportModalOpen(false); } else { alert("Erreur: Impossible de récupérer les images."); } } catch (e) { alert("Erreur ZIP: " + e.message); } finally { setIsZipping(false); } };
            const onTouchStart = (e) => { if (e.touches.length === 2) { touchStartDist.current = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY); startZoom.current = zoomLevel; } else if (e.touches.length === 1 && zoomLevel > 1) { panStart.current = { x: e.touches[0].pageX, y: e.touches[0].pageY }; startPan.current = { ...pan }; } };
            const onTouchMove = (e) => { if (e.touches.length === 2 && touchStartDist.current) { const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY); setZoomLevel(Math.min(Math.max(0.5, startZoom.current * (dist / touchStartDist.current)), 5)); e.stopPropagation(); } else if (e.touches.length === 1 && panStart.current && zoomLevel > 1) { setPan({ x: startPan.current.x + (e.touches[0].pageX - panStart.current.x), y: startPan.current.y + (e.touches[0].pageY - panStart.current.y) }); e.stopPropagation(); } };
            const onTouchEnd = () => { touchStartDist.current = null; panStart.current = null; };

            return (
                <div className="space-y-6 fade-in-element pb-24">
                    <div className="flex justify-between items-center"><h2 className="text-2xl font-bold text-green-800 flex items-center gap-2"><Icon name="ScanBarcode" className="w-8 h-8"/> Traçabilité</h2><button onClick={() => setExportModalOpen(true)} className="px-4 py-2 bg-green-100 text-green-700 rounded-lg font-bold flex items-center gap-2 hover:bg-green-200 transition-colors"><Icon name="Download" className="w-5 h-5"/> Exporter</button></div>
                    <div className="grid lg:grid-cols-12 gap-6">
                        <div className="lg:col-span-4">
                            <Card className="border-2 border-green-100">
                                <form onSubmit={handleSubmit}>
                                    <div className="mb-4">
                                        {isUploading ? (
                                            <div className="w-full h-56 bg-gray-50 rounded-xl flex flex-col items-center justify-center text-green-600 animate-pulse border-2 border-green-200">
                                                <Icon name="Wifi" className="mb-2 animate-bounce"/>Envoi vers le Cloud...
                                            </div>
                                        ) : newProduct.photo ? (
                                            <div onClick={() => setNewProduct({...newProduct, photo: null, rawFile: null})} className="relative cursor-pointer group h-56 w-full bg-gray-100 rounded-xl overflow-hidden border border-green-200 flex items-center justify-center">
                                                <img src={newProduct.photo} className="h-full w-full object-contain" />
                                                <div className="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 rounded-xl text-white font-bold transition-all">
                                                    <Icon name="Trash2" className="mr-2"/> Retirer
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="space-y-3">
                                                <button type="button" onClick={handleCameraClick} className="w-full h-56 bg-green-50 text-green-700 rounded-xl border-2 border-dashed border-green-300 flex flex-col items-center justify-center hover:bg-green-100 transition-colors">
                                                    <Icon name="Aperture" className="w-12 h-12 mb-4"/> 
                                                    <span className="font-bold text-lg">Scanner / Photo</span>
                                                </button>
                                                <div onClick={() => fileInputRef.current?.click()} className="text-center text-sm text-gray-400 underline cursor-pointer pb-2">Importer fichier</div>
                                                <input type="file" ref={fileInputRef} onChange={handleNativeCameraCapture} accept="image/*" className="hidden"/><input type="file" ref={nativeCameraInputRef} onChange={handleNativeCameraCapture} accept="image/*" capture="environment" className="hidden"/>
                                            </div>
                                        )}
                                    </div>
                                    <AutocompleteInput label="Produit" value={newProduct.name} onChange={e => setNewProduct({...newProduct, name: e.target.value})} options={productHistory} required />
                                    <Input label="Lot / DLC" value={newProduct.batch} onChange={e => setNewProduct({...newProduct, batch: e.target.value})} />
                                    <Button type="submit" className="w-full" disabled={!newProduct.name || !newProduct.photo || isUploading}>{isUploading ? "Enregistrement..." : "Enregistrer"}</Button>
                                </form>
                            </Card>
                        </div>
                        <div className="lg:col-span-8">
                             <div className="bg-white p-4 rounded-xl border flex justify-between items-center mb-4"><div className="flex items-center gap-2"><button onClick={() => changeDate(-1)}><Icon name="ChevronLeft" className="w-6 h-6"/></button><div className="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded-lg border border-gray-200"><Icon name="Calendar" className="w-5 h-5 text-green-600"/><input type="date" value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)} className="bg-transparent font-bold text-gray-700 outline-none" /></div><button onClick={() => changeDate(1)}><Icon name="ChevronRight" className="w-6 h-6"/></button></div><span className="text-sm text-gray-500">{filtered.length} produit(s)</span></div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                {filtered.length === 0 && <div className="col-span-full text-center py-10 text-gray-400">Rien ce jour.</div>}
                                {filtered.map(item => (<div key={item.id} className="bg-white rounded-lg border p-3 flex justify-between items-start"><div className="flex gap-3 w-full" onClick={() => setFullscreenPhoto(item.photo)}><img src={item.photo} className={`w-20 h-20 object-cover rounded-lg bg-gray-100 cursor-zoom-in ${item.syncStatus === 'pending' ? 'opacity-50 blur-[1px]' : ''}`} /><div><p className="font-bold">{item.name}</p><p className="text-sm text-green-600">{item.batch}</p>{item.syncStatus === 'pending' && <p className="text-xs text-orange-500 font-bold flex items-center gap-1"><Icon name="WifiOff" className="w-3 h-3"/> En attente synchro...</p>}</div></div><button onClick={() => deleteItem(item.id)} className="text-gray-300 hover:text-red-500"><Icon name="Trash2"/></button></div>))}
                            </div>
                        </div>
                    </div>
                    {exportModalOpen && (<div className="fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => !isZipping && setExportModalOpen(false)}><div className="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl" onClick={e => e.stopPropagation()}><h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"><Icon name="Download" className="text-green-600"/> Exporter Photos</h3><p className="text-gray-600 mb-4">Choisissez le mois à télécharger (ZIP) :</p><input type="month" value={exportMonth} onChange={(e) => setExportMonth(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg mb-6 text-lg" disabled={isZipping} /><div className="flex gap-3"><Button onClick={downloadPhotos} className="flex-1" disabled={isZipping}>{isZipping ? "Création ZIP..." : "Télécharger"}</Button><Button variant="ghost" onClick={() => setExportModalOpen(false)} disabled={isZipping}>Annuler</Button></div></div></div>)}
                    {isWebcamOpen && (<div className="fixed inset-0 z-[100] bg-black flex flex-col"><div className="relative flex-1 w-full h-full overflow-hidden"><video ref={videoRef} autoPlay playsInline className={`absolute inset-0 w-full h-full object-cover ${tempPhoto ? 'hidden' : ''}`}></video>{tempPhoto && <img src={tempPhoto.preview} className="absolute inset-0 w-full h-full object-cover" />}{!tempPhoto ? (<><div className="absolute inset-0 flex items-center justify-center pointer-events-none"><div className="w-[80%] h-[60%] border-2 border-green-500/50 rounded-2xl relative"><div className="scan-line"></div></div></div><div className="absolute top-0 w-full p-4 flex justify-between items-center z-20 bg-gradient-to-b from-black/60 to-transparent"><span className="text-white font-bold tracking-wide drop-shadow-md">Scanner</span><button onClick={() => { if(videoRef.current?.srcObject) videoRef.current.srcObject.getTracks().forEach(t=>t.stop()); setIsWebcamOpen(false); }} className="p-3 bg-black/40 rounded-full text-white backdrop-blur-md border border-white/20"><Icon name="X" className="w-6 h-6"/></button></div><div className="absolute bottom-8 w-full flex justify-center z-20"><button onClick={captureWebcam} className="w-20 h-20 bg-white rounded-full border-4 border-gray-200/50 shadow-2xl active:scale-95 transition-transform flex items-center justify-center"><div className="w-16 h-16 bg-white rounded-full border-2 border-black"></div></button></div></>) : (<div className="absolute bottom-8 w-full flex justify-center gap-6 z-20 px-8"><button onClick={retakePhoto} className="flex-1 py-4 bg-red-500/90 backdrop-blur-md text-white rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg active:scale-95 border border-red-400"><Icon name="RotateCcw" className="w-6 h-6"/> Reprendre</button><button onClick={confirmPhoto} className="flex-1 py-4 bg-green-500 text-white rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg active:scale-95"><Icon name="CheckCircle" className="w-6 h-6"/> Valider</button></div>)}</div><canvas ref={canvasRef} className="hidden"></canvas></div>)}
                    {fullscreenPhoto && (<div className="fixed inset-0 z-[100] bg-black flex items-center justify-center overflow-hidden touch-none" onClick={() => setFullscreenPhoto(null)} onTouchStart={onTouchStart} onTouchMove={onTouchMove} onTouchEnd={onTouchEnd}><div className="absolute bottom-10 z-50 flex gap-4 pointer-events-auto" onClick={e => e.stopPropagation()}><button className="p-4 bg-white/20 backdrop-blur rounded-full text-white border border-white/30 active:scale-95" onClick={() => setZoomLevel(z => Math.max(0.5, z - 0.5))}><Icon name="ZoomOut"/></button><div className="px-4 py-2 bg-black/50 backdrop-blur rounded-full text-white font-mono flex items-center">{Math.round(zoomLevel * 100)}%</div><button className="p-4 bg-white/20 backdrop-blur rounded-full text-white border border-white/30 active:scale-95" onClick={() => setZoomLevel(z => Math.min(3, z + 0.5))}><Icon name="ZoomIn"/></button></div><button className="absolute top-4 right-4 p-3 bg-black/40 backdrop-blur rounded-full text-white border border-white/20 z-50 pointer-events-auto" onClick={() => setFullscreenPhoto(null)}><Icon name="X"/></button><div className="w-full h-full flex items-center justify-center overflow-hidden"><img src={fullscreenPhoto} style={{ transform: `translate(${pan.x}px, ${pan.y}px) scale(${zoomLevel})`, transition: (touchStartDist.current || panStart.current) ? 'none' : 'transform 0.2s ease-out' }} className="max-h-screen max-w-full object-contain pointer-events-auto" onClick={e => e.stopPropagation()} /></div></div>)}
                </div>
            );
        };

        const TemperatureModule = ({ restaurantId }) => {
            const { data: equipments, addItem: addEquip, deleteItem: removeEquip, updateItem: updateEquip } = useSharedCollection(restaurantId, 'equipments');
            const { logs: temps, updateLog } = useSharedLogs(restaurantId, 'temperatures');
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [showAdd, setShowAdd] = useState(false);
            const [newEquip, setNewEquip] = useState("");
            const [picker, setPicker] = useState({ open: false, id: null, name: '', period: '' });
            const [tempInput, setTempInput] = useState(''); 
            const [isSaved, setIsSaved] = useState(false);
            const [exportModalOpen, setExportModalOpen] = useState(false);
            const [exportMonth, setExportMonth] = useState(new Date().toISOString().slice(0, 7));
            const equipHistory = equipments.map(e => e.name);
            const changeDate = (d) => { const date = new Date(selectedDate); date.setDate(date.getDate() + d); setSelectedDate(date.toISOString().split('T')[0]); setIsSaved(false); };
            const handleNumClick = (n) => setTempInput(prev => prev + n);
            const handleDot = () => setTempInput(prev => prev.includes('.') ? prev : prev + '.');
            const handleClear = () => setTempInput('');
            const handleBackspace = () => setTempInput(prev => prev.slice(0, -1));
            const handleValidate = () => { updateLog(selectedDate, { [picker.name]: { ...(temps[selectedDate]?.[picker.name]||{}), [picker.period]: tempInput } }); setPicker({...picker, open: false}); setTempInput(''); setIsSaved(false); };
            const openPad = (equipId, equipName, period) => { setPicker({ open: true, id: equipId, name: equipName, period: period }); setTempInput(temps[selectedDate]?.[equipName]?.[period] || ''); };
            const getVal = (name, p) => temps[selectedDate]?.[name]?.[p] || '';
            const handleSaveDay = () => { setIsSaved(true); setTimeout(() => setIsSaved(false), 2000); };
            const KeypadButton = ({ label, onClick, className = "" }) => (<button onClick={onClick} className={`h-16 text-xl font-bold rounded-xl active-press transition-colors shadow-sm border border-gray-200 bg-white hover:bg-gray-50 text-gray-700 ${className}`}>{label}</button>);
            const moveEquip = async (index, direction) => {
                if ((direction === -1 && index === 0) || (direction === 1 && index === equipments.length - 1)) return;
                const itemA = equipments[index]; const itemB = equipments[index + direction];
                const orderA = itemA.order || 0; const orderB = itemB.order || 0;
                await updateEquip(itemA.id, { order: orderB }); await updateEquip(itemB.id, { order: orderA });
            };
            const generateExcel = () => {
                const [year, month] = exportMonth.split('-'); const daysInMonth = new Date(year, month, 0).getDate();
                let tableHTML = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="UTF-8"></head><body><h2 style="color:#166534; font-family:Arial;">Relevé de Températures - ${month}/${year}</h2><table border="1" style="border-collapse:collapse; font-family:Arial; width:100%;"><thead><tr style="background-color:#4ade80; color:white;"><th style="padding:10px;">Date</th><th style="padding:10px;">Matin (°C)</th><th style="padding:10px;">Soir (°C)</th></tr></thead><tbody>`;
                equipments.forEach(eq => { tableHTML += `<tr><td colspan="3" style="background-color:#dcfce7; color:#166534; font-weight:bold; font-size:14px; padding:10px; text-align:left; border-top: 2px solid #166534;">Équipement : ${eq.name.toUpperCase()}</td></tr>`; let hasData = false; for(let i=1; i<=daysInMonth; i++) { const day = i.toString().padStart(2, '0'); const dateStr = `${year}-${month}-${day}`; const dayData = temps[dateStr] || {}; const m = dayData[eq.name]?.matin || ''; const s = dayData[eq.name]?.soir || ''; if (m || s) { hasData = true; tableHTML += `<tr><td style="padding:5px; text-align:center;">${day}/${month}/${year}</td><td style="padding:5px; text-align:center; ${m && (parseFloat(m) > 5 || parseFloat(m) < -25) ? 'color:red; font-weight:bold;' : ''}">${m}</td><td style="padding:5px; text-align:center; ${s && (parseFloat(s) > 5 || parseFloat(s) < -25) ? 'color:red; font-weight:bold;' : ''}">${s}</td></tr>`; } } if (!hasData) tableHTML += `<tr><td colspan="3" style="padding:5px; color:gray; font-style:italic; text-align:center;">Aucune donnée pour ce mois</td></tr>`; tableHTML += `<tr><td colspan="3" style="height:20px; border:none;"></td></tr>`; });
                tableHTML += `</tbody></table></body></html>`; const blob = new Blob([tableHTML], { type: 'application/vnd.ms-excel' }); const url = window.URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `Releve_Temperatures_${month}_${year}.xls`; a.click(); setExportModalOpen(false);
            };
            return (
                <div className="space-y-6 fade-in-element pb-32">
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"><h2 className="text-2xl font-bold text-green-800 flex items-center gap-2"><Icon name="Thermometer" className="w-8 h-8"/> Températures</h2><div className="flex gap-2 w-full sm:w-auto"><button onClick={() => setExportModalOpen(true)} className="flex-1 sm:flex-none px-4 py-2 bg-green-100 text-green-700 rounded-lg font-bold flex items-center justify-center gap-2 hover:bg-green-200 transition-colors whitespace-nowrap"><Icon name="Download" className="w-5 h-5"/> Exporter</button><div className="flex items-center gap-4 bg-white p-2 rounded-lg border ml-auto"><button onClick={() => changeDate(-1)}><Icon name="ChevronLeft"/></button><div className="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded-lg border border-gray-200"><Icon name="Calendar" className="w-5 h-5 text-green-600"/><input type="date" value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)} className="bg-transparent font-bold text-gray-700 outline-none w-32" /></div><button onClick={() => changeDate(1)}><Icon name="ChevronRight"/></button></div></div></div>
                    <div className="grid gap-4">
                         {showAdd ? ( <Card className="bg-green-50 border-dashed border-2 border-green-300"><div className="flex gap-2"><AutocompleteInput placeholder="Nom de l'équipement..." value={newEquip} onChange={e=>setNewEquip(e.target.value)} options={equipHistory} /><Button onClick={() => { if(newEquip) { addEquip({name: newEquip}); setNewEquip(""); setShowAdd(false); } }}>OK</Button><Button variant="ghost" onClick={() => setShowAdd(false)}>X</Button></div></Card> ) : <button onClick={() => setShowAdd(true)} className="w-full py-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 font-bold hover:bg-green-50 flex items-center justify-center gap-2"><Icon name="Plus" className="w-5 h-5"/> Ajouter équipement</button>}
                        {equipments.map((eq, idx) => ( <Card key={eq.id} className="flex flex-col md:flex-row items-center gap-4 border-l-4 border-l-green-500 relative"><div className="w-full md:w-1/3 flex justify-between items-center"><div className="flex items-center gap-3"><div className="flex flex-col gap-1"><button onClick={() => moveEquip(idx, -1)} className="p-1 text-gray-300 hover:text-green-600 disabled:opacity-30" disabled={idx===0}><Icon name="ArrowUp" className="w-5 h-5"/></button><button onClick={() => moveEquip(idx, 1)} className="p-1 text-gray-300 hover:text-green-600 disabled:opacity-30" disabled={idx===equipments.length-1}><Icon name="ArrowDown" className="w-5 h-5"/></button></div><div className="font-bold text-lg">{eq.name}</div></div><button onClick={() => removeEquip(eq.id)} className="text-red-300 hover:text-red-500"><Icon name="Trash2" className="w-4 h-4"/></button></div><div className="flex gap-4 flex-1 w-full">{['matin', 'soir'].map(p => (<div key={p} className="flex-1"><label className="text-xs uppercase text-gray-400 font-bold">{p}</label><button onClick={() => openPad(eq.id, eq.name, p)} className={`w-full p-3 rounded-lg border-2 font-bold flex justify-between items-center ${getVal(eq.name, p) ? 'bg-green-50 border-green-500 text-green-700' : 'bg-gray-50'}`}>{getVal(eq.name, p) ? getVal(eq.name, p) + '°C' : '--'} <Icon name="ChevronRight" className="w-4 h-4 rotate-90 opacity-50"/></button></div>))}</div></Card> ))}
                    </div>
                    <div className="fixed bottom-24 md:bottom-6 right-6 z-30"><button onClick={handleSaveDay} className={`flex items-center gap-3 px-8 py-4 rounded-full font-bold text-lg shadow-xl transition-all transform hover:scale-105 active:scale-95 ${isSaved ? 'bg-green-500 text-white' : 'bg-green-600 text-white hover:bg-green-700'}`}>{isSaved ? <Icon name="CheckCircle" className="w-6 h-6"/> : <Icon name="Save" className="w-6 h-6"/>}{isSaved ? 'Enregistré !' : 'Enregistrer'}</button></div>
                    {picker.open && (<div className="fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 fade-in-element" onClick={() => setPicker({...picker, open: false})}><div className="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}><div className="p-4 bg-green-600 text-white flex justify-between items-center"><h3 className="font-bold text-lg">{picker.name} <span className="text-sm font-normal opacity-80">({picker.period})</span></h3><button onClick={() => setPicker({...picker, open: false})}><Icon name="X" className="w-6 h-6"/></button></div><div className="p-4 bg-gray-50 border-b flex items-center justify-between"><div className="text-3xl font-bold text-gray-800 tracking-widest h-10 min-w-[100px]">{tempInput || <span className="text-gray-300">--</span>} <span className="text-sm text-gray-400">°C</span></div><button onClick={handleBackspace} className="text-gray-400 hover:text-red-500 p-2"><Icon name="Delete" className="w-6 h-6"/></button></div><div className="p-4 bg-gray-100 grid grid-cols-3 gap-3">{[7, 8, 9, 4, 5, 6, 1, 2, 3].map(n => (<KeypadButton key={n} label={n} onClick={() => handleNumClick(n.toString())} />))}<KeypadButton label="-" onClick={() => !tempInput.includes('-') && setTempInput(prev => '-' + prev)} className="text-blue-600 bg-blue-50 border-blue-100" /><KeypadButton label="0" onClick={() => handleNumClick('0')} /><KeypadButton label="." onClick={handleDot} className="text-blue-600 bg-blue-50 border-blue-100" /><KeypadButton label="C" onClick={handleClear} className="bg-red-50 text-red-600 border-red-100" /><button onClick={handleValidate} className="col-span-2 h-16 bg-green-600 text-white rounded-xl font-bold text-lg shadow-md active:scale-95 transition-transform flex items-center justify-center gap-2"><Icon name="CheckCircle" className="w-6 h-6"/> Valider</button></div></div></div>)}
                    {exportModalOpen && (<div className="fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setExportModalOpen(false)}><div className="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl" onClick={e => e.stopPropagation()}><h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"><Icon name="Download" className="text-green-600"/> Exporter vers Excel</h3><p className="text-gray-600 mb-4">Choisissez le mois à exporter :</p><input type="month" value={exportMonth} onChange={(e) => setExportMonth(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg mb-6 text-lg" /><div className="flex gap-3"><Button onClick={generateExcel} className="flex-1">Télécharger</Button><Button variant="ghost" onClick={() => setExportModalOpen(false)}>Annuler</Button></div></div></div>)}
                </div>
            );
        };

        const MonitoringModule = ({ restaurantId }) => {
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            
            // --- 1. Refroidissement / Congélation ---
            const { data: coolings, addItem: addCooling, deleteItem: removeCooling } = useSharedCollection(restaurantId, 'cooling_logs', 'startTime');
            const [newCooling, setNewCooling] = useState({ type: 'Refroidissement', start: '', end: '', product: '', tempIn: '', tempOut: '' });
            const filteredCoolings = coolings.filter(c => c.sortDate === selectedDate);
            const coolingHistory = coolings.map(c => c.product);
            
            // --- 2. Livraison ---
            const { data: deliveries, addItem: addDelivery, deleteItem: removeDelivery } = useSharedCollection(restaurantId, 'delivery_logs', 'timestamp');
            const [newDelivery, setNewDelivery] = useState({ supplier: '', product: '', batch: '', dlc: '', temp: '', compliant: 'Oui', comment: '', photo: null });
            const filteredDeliveries = deliveries.filter(d => d.sortDate === selectedDate);
            const deliveryCameraRef = useRef(null);
            const supplierHistory = deliveries.map(d => d.supplier);
            const deliveryProductHistory = deliveries.map(d => d.product);

            // --- 3. Nettoyage ---
            const { data: zones, addItem: addZone, deleteItem: removeZone } = useSharedCollection(restaurantId, 'cleaning');
            const { logs, updateLog } = useSharedLogs(restaurantId, 'cleaning_logs');
            const [showAddZone, setShowAddZone] = useState(false);
            const [newZone, setNewZone] = useState({ name: "", freq: "Journalier" });
            const cleaningTaskHistory = zones.map(z => z.name);

            // --- WEBCAM LOGIC (Shared/Duplicated for Delivery) ---
            const [isWebcamOpen, setIsWebcamOpen] = useState(false);
            const [tempPhoto, setTempPhoto] = useState(null);
            const videoRef = useRef(null);
            const canvasRef = useRef(null);

            // --- BROUILLON LIVRAISON VIA INDEXEDDB + LS ---
            useEffect(() => {
                const loadDraft = async () => {
                    const savedDraft = localStorage.getItem('draft_delivery_meta');
                    const savedImage = await SimpleIDB.get('draft_delivery_photo');
                    
                    if (savedDraft) {
                        try { 
                            const parsed = JSON.parse(savedDraft);
                            if (savedImage) parsed.photo = savedImage;
                            setNewDelivery(parsed); 
                        } catch (e) { console.error("Erreur lecture brouillon livraison", e); }
                    }
                };
                loadDraft();
            }, []);

            useEffect(() => {
                if (newDelivery.supplier || newDelivery.product) {
                    const meta = { ...newDelivery, photo: null, rawFile: null };
                    try { localStorage.setItem('draft_delivery_meta', JSON.stringify(meta)); } catch (e) {}
                }
            }, [newDelivery.supplier, newDelivery.product, newDelivery.batch]); // Check specific fields to avoid loop with photo

            const startWebcam = async () => { setTempPhoto(null); setIsWebcamOpen(true); try { const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }); setTimeout(() => { if (videoRef.current) videoRef.current.srcObject = stream; }, 100); } catch (e) { alert("Impossible d'accéder à la webcam."); setIsWebcamOpen(false); } };
            const captureWebcam = () => { if (videoRef.current && canvasRef.current) { const v = videoRef.current; const c = canvasRef.current; c.width = v.videoWidth; c.height = v.videoHeight; c.getContext('2d').drawImage(v, 0, 0); c.toBlob((blob) => { const previewUrl = c.toDataURL('image/jpeg', 0.8); setTempPhoto({ preview: previewUrl, file: blob }); }, 'image/jpeg', 0.95); v.pause(); } };
            const retakePhoto = () => { setTempPhoto(null); if (videoRef.current) videoRef.current.play(); };
            
            const confirmPhoto = async () => { 
                if (tempPhoto) { 
                    const compressed = await compressImage(tempPhoto.preview, 1000, 0.7);
                    await SimpleIDB.save('draft_delivery_photo', compressed);
                    setNewDelivery({...newDelivery, photo: compressed, rawFile: tempPhoto.file}); 
                } 
                if(videoRef.current?.srcObject) videoRef.current.srcObject.getTracks().forEach(t => t.stop()); 
                setIsWebcamOpen(false); setTempPhoto(null); 
            };
            
            // Smart Camera Trigger for Delivery
            const handleDeliveryCameraClick = () => { 
                if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) { 
                    deliveryCameraRef.current?.click(); 
                } else { 
                    startWebcam(); 
                } 
            };

            const changeDate = (d) => { const date = new Date(selectedDate); date.setDate(date.getDate() + d); setSelectedDate(date.toISOString().split('T')[0]); };

            const submitCooling = async (e) => {
                e.preventDefault();
                await addCooling({ ...newCooling, sortDate: selectedDate, timestamp: Date.now() });
                setNewCooling({ type: 'Refroidissement', start: '', end: '', product: '', tempIn: '', tempOut: '' });
            };

            const handleDeliveryPhoto = async (e) => {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = async (ev) => {
                        const compressed = await compressImage(ev.target.result, 1000, 0.7);
                        await SimpleIDB.save('draft_delivery_photo', compressed);
                        setNewDelivery({...newDelivery, photo: compressed, rawFile: file});
                    };
                    reader.readAsDataURL(file);
                }
            };

            const submitDelivery = async (e) => {
                e.preventDefault();
                await addDelivery({ ...newDelivery, sortDate: selectedDate, timestamp: Date.now() });
                // Clean up IDB and LS
                localStorage.removeItem('draft_delivery_meta');
                await SimpleIDB.delete('draft_delivery_photo');
                setNewDelivery({ supplier: '', product: '', batch: '', dlc: '', temp: '', compliant: 'Oui', comment: '', photo: null });
            };

            const toggleZone = (id) => updateLog(selectedDate, { [id]: !(logs[selectedDate]?.[id]) });
            const isDone = (id) => logs[selectedDate]?.[id];
            const cleanProgress = zones.length === 0 ? 0 : Math.round((zones.filter(z => isDone(z.id)).length / zones.length) * 100);

            return (
                <div className="space-y-8 fade-in-element pb-24">
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"><h2 className="text-2xl font-bold text-green-800 flex items-center gap-2"><Icon name="ClipboardList" className="w-8 h-8"/> Suivi & Hygiène</h2><div className="flex items-center gap-4 bg-white p-2 rounded-lg border ml-auto w-full sm:w-auto justify-between sm:justify-start"><button onClick={() => changeDate(-1)}><Icon name="ChevronLeft"/></button><div className="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded-lg border border-gray-200"><Icon name="Calendar" className="w-5 h-5 text-green-600"/><input type="date" value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)} className="bg-transparent font-bold text-gray-700 outline-none w-32" /></div><button onClick={() => changeDate(1)}><Icon name="ChevronRight"/></button></div></div>

                    {/* 1. Suivi des Denrées (Refroidissement / Congélation) */}
                    <Card className="border-l-4 border-l-blue-500">
                        <h3 className="text-xl font-bold text-blue-800 mb-4 flex items-center gap-2"><Icon name="Snowflake" className="w-6 h-6"/> Refroidissement / Congélation</h3>
                        <form onSubmit={submitCooling} className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 bg-blue-50 p-4 rounded-xl">
                            <div className="flex gap-2 col-span-full">
                                <label className={`flex-1 p-2 text-center rounded-lg cursor-pointer border font-bold ${newCooling.type === 'Refroidissement' ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-600'}`}><input type="radio" className="hidden" name="type" checked={newCooling.type==='Refroidissement'} onChange={()=>setNewCooling({...newCooling, type:'Refroidissement'})} /> Refroidissement</label>
                                <label className={`flex-1 p-2 text-center rounded-lg cursor-pointer border font-bold ${newCooling.type === 'Congélation' ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-600'}`}><input type="radio" className="hidden" name="type" checked={newCooling.type==='Congélation'} onChange={()=>setNewCooling({...newCooling, type:'Congélation'})} /> Congélation</label>
                            </div>
                            <div className="col-span-full"><AutocompleteInput placeholder="Produit..." value={newCooling.product} onChange={e=>setNewCooling({...newCooling, product:e.target.value})} options={coolingHistory} required/></div>
                            {/* MODIFICATION 1 : CHAMPS TEMPÉRATURES */}
                            <div className="flex gap-2">
                                <div className="flex-1"><label className="text-xs font-bold text-gray-500 ml-1">T° Départ</label><input type="number" placeholder="°C" className="w-full p-3 rounded-lg border" value={newCooling.tempIn} onChange={e=>setNewCooling({...newCooling, tempIn:e.target.value})} /></div>
                                <div className="flex-1"><label className="text-xs font-bold text-gray-500 ml-1">T° Fin</label><input type="number" placeholder="°C" className="w-full p-3 rounded-lg border" value={newCooling.tempOut} onChange={e=>setNewCooling({...newCooling, tempOut:e.target.value})} /></div>
                            </div>
                            <div className="flex gap-2">
                                <div className="flex-1"><label className="text-xs font-bold text-gray-500 ml-1">Heure Début</label><input type="time" className="w-full p-3 rounded-lg border" value={newCooling.start} onChange={e=>setNewCooling({...newCooling, start:e.target.value})} required /></div>
                                <div className="flex-1"><label className="text-xs font-bold text-gray-500 ml-1">Heure Fin</label><input type="time" className="w-full p-3 rounded-lg border" value={newCooling.end} onChange={e=>setNewCooling({...newCooling, end:e.target.value})} /></div>
                            </div>
                            <Button type="submit" className="col-span-full bg-blue-600 hover:bg-blue-700 text-white">Ajouter cycle</Button>
                        </form>
                        <div className="space-y-2">
                            {filteredCoolings.map(c => (<div key={c.id} className="flex justify-between items-center bg-gray-50 p-3 rounded-lg border"><div><div className="font-bold text-gray-800">{c.product} <span className="text-xs font-normal text-blue-600 bg-blue-100 px-2 py-0.5 rounded-full">{c.type}</span></div><div className="text-sm text-gray-500">{c.start} ➝ {c.end || 'En cours'} {c.tempIn && c.tempOut && <span className="ml-2 font-mono text-xs bg-gray-200 px-1 rounded">({c.tempIn}°C ➝ {c.tempOut}°C)</span>}</div></div><button onClick={() => removeCooling(c.id)} className="text-red-300 hover:text-red-500"><Icon name="Trash2"/></button></div>))}
                            {filteredCoolings.length === 0 && <p className="text-center text-gray-400 italic text-sm">Aucun cycle enregistré ce jour.</p>}
                        </div>
                    </Card>

                    {/* 2. Réception Marchandises */}
                    <Card className="border-l-4 border-l-orange-500">
                        <h3 className="text-xl font-bold text-orange-800 mb-4 flex items-center gap-2"><Icon name="Truck" className="w-6 h-6"/> Réception Marchandises</h3>
                        <form onSubmit={submitDelivery} className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-6 bg-orange-50 p-4 rounded-xl">
                            <AutocompleteInput placeholder="Fournisseur" value={newDelivery.supplier} onChange={e=>setNewDelivery({...newDelivery, supplier:e.target.value})} options={supplierHistory} required/>
                            <AutocompleteInput placeholder="Produit" value={newDelivery.product} onChange={e=>setNewDelivery({...newDelivery, product:e.target.value})} options={deliveryProductHistory} required/>
                            <div className="flex gap-2"><input placeholder="N° Lot" className="p-2 rounded border flex-1" value={newDelivery.batch} onChange={e=>setNewDelivery({...newDelivery, batch:e.target.value})} /><input placeholder="T°C" type="number" className="p-2 rounded border w-24" value={newDelivery.temp} onChange={e=>setNewDelivery({...newDelivery, temp:e.target.value})} /></div>
                            <div className="flex gap-2">
                                <select className={`p-2 rounded border flex-1 font-bold ${newDelivery.compliant==='Non'?'bg-red-50 text-red-600 border-red-300':'bg-white'}`} value={newDelivery.compliant} onChange={e=>setNewDelivery({...newDelivery, compliant:e.target.value})}><option value="Oui">Conforme</option><option value="Non">Non Conforme</option></select>
                                {/* MODIFICATION 2: Bouton Camera Smart */}
                                <input type="file" ref={deliveryCameraRef} onChange={handleDeliveryPhoto} accept="image/*" capture="environment" className="hidden"/>
                                <button type="button" onClick={handleDeliveryCameraClick} className={`flex-1 border rounded flex items-center justify-center gap-2 font-medium ${newDelivery.photo ? 'bg-green-100 text-green-700 border-green-300' : 'bg-white text-gray-500 border-gray-300 hover:bg-gray-50'}`}><Icon name="Camera" className="w-5 h-5"/> {newDelivery.photo ? 'Photo OK' : 'Photo'}</button>
                            </div>
                            {newDelivery.compliant === 'Non' && ( <textarea placeholder="Motif de non-conformité..." className="col-span-full p-3 rounded-lg border border-red-200 bg-red-50 text-red-700 placeholder-red-300 focus:ring-2 focus:ring-red-500 outline-none" rows="2" value={newDelivery.comment} onChange={e => setNewDelivery({...newDelivery, comment: e.target.value})} required /> )}
                            <Button type="submit" className="col-span-full bg-orange-600 hover:bg-orange-700 text-white">Valider réception</Button>
                        </form>
                        <div className="space-y-2">
                            {filteredDeliveries.map(d => ( <div key={d.id} className={`flex justify-between items-start bg-white p-3 rounded-lg border shadow-sm ${d.compliant === 'Non' ? 'border-l-4 border-l-red-500' : ''}`}><div className="flex gap-3">{d.photo && <img src={d.photo} className={`w-12 h-12 object-cover rounded bg-gray-200 ${d.syncStatus === 'pending' ? 'opacity-50 blur-[1px]' : ''}`} />}<div><div className="font-bold text-gray-800">{d.product} <span className="text-xs text-gray-500">({d.supplier})</span></div><div className="text-sm text-gray-600">Lot: {d.batch} • {d.temp}°C • <span className={d.compliant==='Oui'?'text-green-600 font-bold':'text-red-600 font-bold'}>{d.compliant==='Oui'?'Conforme':'Non Conforme'}</span></div>{d.comment && <div className="text-xs text-red-500 mt-1 italic">⚠️ {d.comment}</div>}{d.syncStatus === 'pending' && <p className="text-xs text-orange-500 font-bold flex items-center gap-1 mt-1"><Icon name="WifiOff" className="w-3 h-3"/> En attente synchro...</p>}</div></div><button onClick={() => removeDelivery(d.id)} className="text-gray-300 hover:text-red-500"><Icon name="Trash2"/></button></div> ))}
                            {filteredDeliveries.length === 0 && <p className="text-center text-gray-400 italic text-sm">Aucune livraison scannée ce jour.</p>}
                        </div>
                    </Card>

                    {/* 3. Nettoyage (En bas) */}
                    <div className="border-t pt-8">
                        <div className="flex justify-between items-end mb-4"><h3 className="text-xl font-bold text-gray-700 flex items-center gap-2"><Icon name="ClipboardCheck" className="w-6 h-6"/> Plan de Nettoyage</h3><span className="text-2xl font-bold text-green-600">{cleanProgress}%</span></div>
                        <div className="w-full bg-gray-200 rounded-full h-2 mb-6"><div className="bg-green-600 h-2 rounded-full transition-all duration-500" style={{width: `${cleanProgress}%`}}></div></div>
                        <div className="grid gap-3">
                            {zones.map(z => ( <div key={z.id} onClick={() => toggleZone(z.id)} className={`p-4 rounded-xl border cursor-pointer flex justify-between items-center transition-all ${isDone(z.id) ? 'bg-green-600 text-white border-green-700 shadow-md transform scale-[1.02]' : 'bg-white border-gray-200'}`}><div><h4 className="font-bold text-lg">{z.name}</h4><span className={`text-xs px-2 py-0.5 rounded-full ${isDone(z.id) ? 'bg-green-500 text-green-50' : 'bg-gray-100 text-gray-500'}`}>{z.freq}</span></div><div className="flex gap-4 items-center"><div className={`w-8 h-8 rounded-full flex items-center justify-center ${isDone(z.id) ? 'bg-white text-green-600' : 'bg-gray-100 text-gray-300'}`}><Icon name="CheckCircle" /></div><button onClick={(e) => { e.stopPropagation(); removeZone(z.id); }} className="p-2 hover:bg-white/20 rounded-full"><Icon name="Trash2" className="w-5 h-5"/></button></div></div> ))}
                            {showAddZone ? ( <Card className="bg-green-50 border-dashed border-2 border-green-300"><div className="flex flex-col gap-2"><AutocompleteInput placeholder="Nom de la tâche..." value={newZone.name} onChange={e=>setNewZone({...newZone, name: e.target.value})} options={cleaningTaskHistory} /><div className="flex gap-2"><select className="p-2 rounded border border-gray-300 bg-white flex-1" value={newZone.freq} onChange={e=>setNewZone({...newZone, freq: e.target.value})}><option value="Journalier">Journalier</option><option value="Hebdomadaire">Hebdomadaire</option><option value="Mensuel">Mensuel</option></select><Button className="flex-1" onClick={() => { if(newZone.name) { addZone(newZone); setNewZone({name:"", freq:"Journalier"}); setShowAddZone(false); } }}>Ajouter</Button></div><Button variant="ghost" onClick={() => setShowAddZone(false)} className="w-full text-sm py-1">Annuler</Button></div></Card> ) : <button onClick={() => setShowAddZone(true)} className="w-full py-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 font-bold hover:bg-green-50">+ Nouvelle tâche</button>}
                        </div>
                    </div>

                    {/* WEBCAM OVERLAY FOR DELIVERY */}
                    {isWebcamOpen && (<div className="fixed inset-0 z-[100] bg-black flex flex-col"><div className="relative flex-1 w-full h-full overflow-hidden"><video ref={videoRef} autoPlay playsInline className={`absolute inset-0 w-full h-full object-cover ${tempPhoto ? 'hidden' : ''}`}></video>{tempPhoto && <img src={tempPhoto.preview} className="absolute inset-0 w-full h-full object-cover" />}{!tempPhoto ? (<><div className="absolute inset-0 flex items-center justify-center pointer-events-none"><div className="w-[80%] h-[60%] border-2 border-green-500/50 rounded-2xl relative"><div className="scan-line"></div></div></div><div className="absolute top-0 w-full p-4 flex justify-between items-center z-20 bg-gradient-to-b from-black/60 to-transparent"><span className="text-white font-bold tracking-wide drop-shadow-md">Scanner</span><button onClick={() => { if(videoRef.current?.srcObject) videoRef.current.srcObject.getTracks().forEach(t=>t.stop()); setIsWebcamOpen(false); }} className="p-3 bg-black/40 rounded-full text-white backdrop-blur-md border border-white/20"><Icon name="X" className="w-6 h-6"/></button></div><div className="absolute bottom-8 w-full flex justify-center z-20"><button onClick={captureWebcam} className="w-20 h-20 bg-white rounded-full border-4 border-gray-200/50 shadow-2xl active:scale-95 transition-transform flex items-center justify-center"><div className="w-16 h-16 bg-white rounded-full border-2 border-black"></div></button></div></>) : (<div className="absolute bottom-8 w-full flex justify-center gap-6 z-20 px-8"><button onClick={retakePhoto} className="flex-1 py-4 bg-red-500/90 backdrop-blur-md text-white rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg active:scale-95 border border-red-400"><Icon name="RotateCcw" className="w-6 h-6"/> Reprendre</button><button onClick={confirmPhoto} className="flex-1 py-4 bg-green-500 text-white rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg active:scale-95"><Icon name="CheckCircle" className="w-6 h-6"/> Valider</button></div>)}</div><canvas ref={canvasRef} className="hidden"></canvas></div>)}
                </div>
            );
        };

        const PinScreen = ({ onLogin, isLoading }) => {
            const [code, setCode] = useState(""); const [error, setError] = useState(false);
            const handleNum = (num) => { if (code.length < 6 && !isLoading) { const newCode = code + num; setCode(newCode); setError(false); if (newCode.length === 6) { onLogin(newCode); } } };
            const handleBackspace = () => setCode(prev => prev.slice(0, -1));
            return (
                <div className="flex flex-col items-center justify-center h-full bg-green-50 p-6 fade-in-element">
                    <div className="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm text-center border border-green-100">
                        <div className="mb-6"><div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-green-600"><Icon name="Lock" className="w-8 h-8"/></div><h2 className="text-2xl font-bold text-gray-800">Verrouillé</h2><p className="text-gray-500 text-sm mt-1">{isLoading ? "Connexion..." : "Entrez le code de sécurité (6 chiffres)"}</p></div>
                        <div className="flex justify-center gap-4 mb-8">{[0, 1, 2, 3, 4, 5].map(i => (<div key={i} className={`w-4 h-4 rounded-full transition-all duration-200 ${i < code.length ? (error ? 'bg-red-500' : 'bg-green-500') : 'bg-gray-200'}`}></div>))}</div>
                        <div className="grid grid-cols-3 gap-4 mb-4">{[1, 2, 3, 4, 5, 6, 7, 8, 9].map(n => (<button key={n} onClick={() => handleNum(n.toString())} disabled={isLoading} className="h-16 rounded-2xl bg-gray-50 text-2xl font-bold text-gray-700 active:bg-gray-200 active:scale-95 transition-all outline-none touch-manipulation disabled:opacity-50">{n}</button>))}<div className="h-16"></div><button onClick={() => handleNum('0')} disabled={isLoading} className="h-16 rounded-2xl bg-gray-50 text-2xl font-bold text-gray-700 active:bg-gray-200 active:scale-95 transition-all outline-none touch-manipulation disabled:opacity-50">0</button><button onClick={handleBackspace} disabled={isLoading} className="h-16 rounded-2xl flex items-center justify-center text-gray-400 active:bg-red-50 active:text-red-500 active:scale-95 transition-all outline-none touch-manipulation disabled:opacity-50"><Icon name="Delete" className="w-8 h-8"/></button></div>
                        {error && <p className="text-red-500 font-bold text-sm animate-bounce">Code incorrect ou erreur connexion</p>}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [restaurantId, setRestaurantId] = useState(localStorage.getItem('haccp_restaurant_id') || 'mon-restaurant');
            const [tab, setTab] = useState('traceability');
            const [isLocked, setIsLocked] = useState(!localStorage.getItem('haccp_app_unlocked'));
            const [isAuthLoading, setIsAuthLoading] = useState(true); 
            const [isLoginLoading, setIsLoginLoading] = useState(false);
            const [isCaching, setIsCaching] = useState(false);
            const isOnline = useNetworkStatus();

            useEffect(() => {
                const loader = document.getElementById('static-loader');
                
                // --- 5. AUTOMATISATION DU CACHE AU DÉMARRAGE (CRITIQUE) ---
                // C'est ce qui télécharge tout le site dans le cache disque
                const preloadAssets = async () => {
                   if (navigator.onLine && !localStorage.getItem('app_cached_v3')) {
                       // SAFE GUARDED DOM ACCESS
                       const txtEl = document.getElementById('loader-text');
                       if (txtEl) txtEl.innerText = "Installation hors-ligne...";
                       
                       const statusEl = document.getElementById('cache-status');
                       if (statusEl) statusEl.style.display = 'block';

                       try {
                           const urls = [
                               "https://cdn.tailwindcss.com",
                               "https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js",
                               "https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js",
                               "https://unpkg.com/@babel/standalone/babel.min.js",
                               "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
                               "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js",
                               "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js",
                               "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js",
                               "https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js",
                               "https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"
                           ];
                           await Promise.all(urls.map(url => fetch(url, { mode: 'cors', cache: 'force-cache' })));
                           localStorage.setItem('app_cached_v3', 'true');
                       } catch(e) { console.warn("Cache preload partial error", e); }
                   }
                   if (loader) loader.style.display = 'none';
                };

                let unsubscribe;
                const startAuth = async () => {
                    unsubscribe = window.onAuthStateChanged(window.auth, (u) => {
                        if (u) {
                            setUser(u);
                            setIsAuthLoading(false);
                            preloadAssets(); // Lancement preload après auth
                        } else {
                            const doLogin = async () => {
                                try {
                                    if (window.initialAuthToken) await window.signInWithCustomToken(window.auth, window.initialAuthToken); 
                                    else await window.signInAnonymously(window.auth); 
                                } catch (e) {
                                    console.error("Auth Error (Offline?):", e);
                                    setIsAuthLoading(false);
                                    preloadAssets(); // Lancement preload même si erreur auth
                                }
                            };
                            doLogin();
                        }
                    });
                };
                startAuth();
                return () => { if(unsubscribe) unsubscribe(); };
            }, []);

            useEffect(() => { localStorage.setItem('haccp_restaurant_id', restaurantId); }, [restaurantId]);
            const handleLogin = async (code) => { if (code === '030613') { localStorage.setItem('haccp_app_unlocked', 'true'); setIsLocked(false); } else { alert("Code incorrect"); } };
            const handleLock = () => { localStorage.removeItem('haccp_app_unlocked'); setIsLocked(true); };
            
            // --- SYNC MANUELLE & CACHE ASSETS ---
            const handleInstallCache = async () => {
                setIsCaching(true);
                
                try {
                    if (navigator.storage && navigator.storage.persist) await navigator.storage.persist();

                    const urlsToCache = [
                        "https://cdn.tailwindcss.com",
                        "https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js",
                        "https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js",
                        "https://unpkg.com/@babel/standalone/babel.min.js",
                        "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
                        "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js",
                        "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js",
                        "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js",
                        "https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js",
                        "https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"
                    ];

                    // TOLÉRANCE AUX PANNES DE TÉLÉCHARGEMENT (Promise.allSettled)
                    const results = await Promise.allSettled(urlsToCache.map(url => fetch(url, { cache: 'reload' })));
                    
                    const failed = results.filter(r => r.status === 'rejected');
                    if (failed.length > 0) {
                        console.warn("Certains fichiers n'ont pas pu être mis en cache", failed);
                    }

                    const collectionsToWarm = ['traceability', 'equipments', 'cleaning'];
                    for (const colName of collectionsToWarm) {
                        try {
                            let q = window.appId === 'epack-prod-data' 
                                ? window.query(window.collection(window.db, 'haccp_data', restaurantId, colName), window.limit(50))
                                : window.query(window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'haccp_items'), window.where('restaurantId', '==', restaurantId), window.where('category', '==', colName), window.limit(50));
                            await window.getDocs(q);
                        } catch(e) {}
                    }
                    localStorage.setItem('app_cached_v3', 'true');
                    alert(failed.length > 0 ? `⚠️ MàJ partielle (${failed.length} erreurs). Réessayez plus tard.` : "✅ Application téléchargée pour hors-ligne !");
                } catch (e) {
                    alert("⚠️ Erreur téléchargement : " + e.message);
                } finally {
                    setIsCaching(false);
                }
            };

            if (isAuthLoading) return null; // Le loader HTML gère l'attente
            if (isLocked) { return <PinScreen onLogin={handleLogin} isLoading={isLoginLoading} />; }
            
            const MenuBtn = ({ id, label, icon }) => ( <button onClick={() => setTab(id)} className={`w-full flex items-center gap-4 px-4 py-4 rounded-xl transition-all ${tab === id ? 'bg-green-600 text-white shadow-lg' : 'text-gray-600 hover:bg-green-50'}`}><Icon name={icon} className="w-6 h-6"/> <span className="font-semibold text-lg hidden lg:inline">{label}</span><span className="lg:hidden"><Icon name={icon} className="w-8 h-8"/></span></button> );

            return (
                <div className="flex h-[100dvh] bg-green-50/50 w-full overflow-hidden flex-col md:flex-row fade-in-element">
                    <SyncManager restaurantId={restaurantId} />
                    <div className="md:w-72 bg-white border-r border-gray-200 z-50 flex flex-col md:h-full shadow-xl order-2 md:order-1">
                        <div className="p-6 border-b hidden md:flex justify-start items-center gap-2"><h1 className="text-2xl font-extrabold text-green-700">eHygiène<span className="text-green-400">.</span></h1></div>
                        <div className="p-4 bg-green-50 border-b hidden md:block"><p className="text-xs text-green-600 font-bold uppercase tracking-wider">Restaurant</p><p className="font-bold text-gray-800 truncate">{restaurantId}</p></div>
                        <nav className="p-2 space-y-2 flex-1 overflow-y-auto hidden md:block">
                            <MenuBtn id="traceability" label="Traçabilité" icon="ScanBarcode"/>
                            <MenuBtn id="temperature" label="Températures" icon="Thermometer"/>
                            <MenuBtn id="tracking" label="Suivi & Hygiène" icon="ClipboardList"/>
                            
                            <div className="pt-4 mt-4 border-t px-2">
                                <button onClick={handleInstallCache} disabled={isCaching || !isOnline} className="w-full py-3 px-3 text-sm bg-orange-50 text-orange-700 hover:bg-orange-100 rounded-lg flex items-center gap-2 border border-orange-200 font-semibold disabled:opacity-50">
                                    <Icon name="Smartphone" className="w-5 h-5"/> {isCaching ? "Téléchargement..." : "Mise à jour Hors-Ligne"}
                                </button>
                                <p className="text-[10px] text-gray-400 mt-2 text-center px-2">Cliquez pour forcer la mise à jour.</p>
                            </div>
                        </nav>
                        <div className="p-4 border-t hidden md:block"><button onClick={handleLock} className="w-full py-2 text-sm text-red-500 hover:bg-red-50 rounded flex items-center justify-center gap-2"><Icon name="LogOut" className="w-4 h-4"/> Verrouiller</button></div>
                        <div className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around p-3 z-50 pb-safe">
                            <button onClick={() => setTab('traceability')} className={`flex flex-col items-center ${tab === 'traceability' ? 'text-green-600' : 'text-green-600/50'}`}><Icon name="ScanBarcode" className="w-6 h-6"/><span className="text-xs">Traçabilité</span></button>
                            <button onClick={() => setTab('temperature')} className={`flex flex-col items-center ${tab === 'temperature' ? 'text-green-600' : 'text-green-600/50'}`}><Icon name="Thermometer" className="w-6 h-6"/><span className="text-xs">Températures</span></button>
                            <button onClick={() => setTab('tracking')} className={`flex flex-col items-center ${tab === 'tracking' ? 'text-green-600' : 'text-green-600/50'}`}><Icon name="ClipboardList" className="w-6 h-6"/><span className="text-xs">Suivi</span></button>
                            <button onClick={handleInstallCache} className={`flex flex-col items-center text-orange-600/70`}><Icon name="Smartphone" className="w-6 h-6"/><span className="text-xs">MàJ</span></button>
                        </div>
                    </div>
                    <main className="flex-1 flex flex-col h-full overflow-hidden relative w-full order-1 md:order-2 pb-16 md:pb-0">
                        {/* HEADER MOBILE + BADGE OFFLINE */}
                        <div className="md:hidden bg-white p-4 border-b flex justify-between items-center relative">
                            <h1 className="text-xl font-extrabold text-green-700">eHygiène<span className="text-green-400">.</span></h1>
                            {!isOnline && <div className="absolute left-1/2 transform -translate-x-1/2 bg-orange-100 text-orange-600 px-3 py-1 rounded-full text-xs font-bold border border-orange-200 flex items-center gap-1 shadow-sm"><Icon name="WifiOff" className="w-3 h-3"/> Hors Ligne</div>}
                            <button onClick={handleLock} className="text-red-500"><Icon name="LogOut" className="w-6 h-6"/></button>
                        </div>
                         {/* HEADER DESKTOP BADGE OFFLINE */}
                         <div className="hidden md:flex absolute top-4 right-10 z-50">
                            {!isOnline && <div className="offline-badge"><Icon name="WifiOff" className="w-4 h-4"/> Mode Hors Ligne</div>}
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 lg:p-10 w-full">
                            <div className="max-w-5xl mx-auto w-full">
                                {tab === 'traceability' && <TraceabilityModule restaurantId={restaurantId} />}
                                {tab === 'temperature' && <TemperatureModule restaurantId={restaurantId} />}
                                {tab === 'tracking' && <MonitoringModule restaurantId={restaurantId} />}
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
