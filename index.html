import React, { useState, useEffect, useRef, useMemo } from 'react';
import { initializeApp } from "firebase/app";
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "firebase/auth";
import { 
  getFirestore, 
  collection, 
  doc, 
  setDoc, 
  addDoc, 
  deleteDoc, 
  onSnapshot, 
  query, 
  orderBy, 
  serverTimestamp 
} from "firebase/firestore";
import { 
  Camera, 
  Thermometer, 
  ClipboardCheck, 
  History, 
  ChevronRight, 
  ChevronLeft,
  Trash2, 
  CheckCircle, 
  Menu,
  Save,
  ScanBarcode,
  Plus,
  Calendar as CalendarIcon,
  Search,
  X,
  Aperture,
  ZoomIn,
  ZoomOut,
  Focus,
  TrendingUp,
  BarChart3,
  Clock,
  AlertTriangle,
  Cloud,
  Loader2
} from 'lucide-react';

// --- Configuration Firebase ---
// On utilise la configuration injectée par l'environnement si disponible,
// sinon on utilise une configuration par défaut (à remplacer pour un usage externe)
const getFirebaseConfig = () => {
  try {
    if (typeof __firebase_config !== 'undefined') {
      return JSON.parse(__firebase_config);
    }
  } catch (e) {
    console.warn("Utilisation de la config locale (Fallback)");
  }
  return {
    apiKey: "", // À remplir si usage local
    authDomain: "",
    projectId: "",
    storageBucket: "",
    messagingSenderId: "",
    appId: ""
  };
};

const app = initializeApp(getFirebaseConfig());
const auth = getAuth(app);
const db = getFirestore(app);

// ID de l'application
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- Hooks Personnalisés Firebase ---

const useFirestoreCollection = (collectionName, user, sortField = 'createdAt') => {
  const [data, setData] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!user) return;
    
    // Chemin sécurisé: artifacts/{appId}/public/data/{collectionName}
    const q = query(
      collection(db, 'artifacts', appId, 'public', 'data', collectionName),
      orderBy(sortField, 'desc')
    );

    const unsubscribe = onSnapshot(q, (snapshot) => {
      const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setData(items);
      setLoading(false);
    }, (error) => {
      console.error(`Erreur lecture ${collectionName}:`, error);
      setLoading(false);
    });

    return () => unsubscribe();
  }, [user, collectionName, sortField]);

  const addItem = async (item) => {
    if (!user) return;
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', collectionName), {
        ...item,
        createdAt: serverTimestamp()
      });
    } catch (e) {
      console.error("Erreur ajout:", e);
      // Fallback UI error handling could go here
    }
  };

  const deleteItem = async (id) => {
    if (!user) return;
    try {
      await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', collectionName, id));
    } catch (e) {
      console.error("Erreur suppression:", e);
    }
  };

  return { data, loading, addItem, deleteItem };
};

const useDailyLogs = (collectionName, user) => {
  const [logs, setLogs] = useState({});

  useEffect(() => {
    if (!user) return;
    
    const q = collection(db, 'artifacts', appId, 'public', 'data', collectionName);

    const unsubscribe = onSnapshot(q, (snapshot) => {
      const allLogs = {};
      snapshot.docs.forEach(doc => {
        allLogs[doc.id] = doc.data();
      });
      setLogs(allLogs);
    }, (error) => console.error(error));

    return () => unsubscribe();
  }, [user, collectionName]);

  const updateLog = async (dateStr, dataToMerge) => {
    if (!user) return;
    const docRef = doc(db, 'artifacts', appId, 'public', 'data', collectionName, dateStr);
    try {
      await setDoc(docRef, dataToMerge, { merge: true });
    } catch (e) {
      console.error("Erreur update log:", e);
    }
  };

  return { logs, updateLog };
};


// --- Composants UI Reutilisables ---

const Card = ({ children, className = "" }) => (
  <div className={`bg-white rounded-xl shadow-sm border border-green-100 p-6 ${className}`}>
    {children}
  </div>
);

const Button = ({ children, onClick, variant = "primary", className = "", type="button", disabled=false }) => {
  const baseStyle = "px-6 py-3 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 active:scale-95 touch-manipulation disabled:opacity-50 disabled:cursor-not-allowed";
  const variants = {
    primary: "bg-green-600 text-white hover:bg-green-700 shadow-md shadow-green-200",
    secondary: "bg-white text-green-700 border-2 border-green-600 hover:bg-green-50",
    danger: "bg-red-50 text-red-600 border border-red-200 hover:bg-red-100",
    ghost: "bg-transparent text-gray-600 hover:bg-gray-100"
  };
  
  return (
    <button type={type} onClick={onClick} disabled={disabled} className={`${baseStyle} ${variants[variant]} ${className}`}>
      {children}
    </button>
  );
};

const Input = ({ label, ...props }) => (
  <div className="mb-4">
    <label className="block text-sm font-semibold text-gray-700 mb-1">{label}</label>
    <input 
      className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none transition-all"
      {...props}
    />
  </div>
);

// --- Modules de l'Application ---

// 1. Module Traçabilité
const TraceabilityModule = ({ user }) => {
  const { data: products, loading, addItem, deleteItem } = useFirestoreCollection('traceability', user);
  
  const [newProduct, setNewProduct] = useState({ name: '', batch: '', photo: null });
  const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
  
  const [isWebcamOpen, setIsWebcamOpen] = useState(false);
  const [fullscreenPhoto, setFullscreenPhoto] = useState(null);
  const [zoomLevel, setZoomLevel] = useState(1);
  const [focusStatus, setFocusStatus] = useState("auto");
  
  const videoRef = useRef(null);
  const canvasRef = useRef(null);
  const fileInputRef = useRef(null);

  useEffect(() => {
    if (fullscreenPhoto) setZoomLevel(1);
  }, [fullscreenPhoto]);

  // Webcam Logic
  const startWebcam = async () => {
    try {
      setIsWebcamOpen(true);
      setTimeout(async () => {
        const constraints = { 
          video: { 
            facingMode: 'environment',
            width: { ideal: 1280 }, 
            height: { ideal: 720 }
          } 
        };
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        if (videoRef.current) {
          videoRef.current.srcObject = stream;
        }
      }, 100);
    } catch (err) {
      console.error("Erreur webcam:", err);
      // Fallback
      alert("Impossible d'accéder à la webcam.");
      setIsWebcamOpen(false);
    }
  };

  const triggerFocus = async () => {
    setFocusStatus("focusing");
    setTimeout(() => {
        setFocusStatus("focused");
        setTimeout(() => setFocusStatus("auto"), 1000);
    }, 800);
  };

  const stopWebcam = () => {
    if (videoRef.current && videoRef.current.srcObject) {
      const tracks = videoRef.current.srcObject.getTracks();
      tracks.forEach(track => track.stop());
      videoRef.current.srcObject = null;
    }
    setIsWebcamOpen(false);
  };

  const captureWebcam = () => {
    if (videoRef.current && canvasRef.current) {
      const video = videoRef.current;
      const canvas = canvasRef.current;
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const context = canvas.getContext('2d');
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      const imageSrc = canvas.toDataURL('image/jpeg', 0.6); 
      setNewProduct(prev => ({ ...prev, photo: imageSrc }));
      stopWebcam();
    }
  };

  const handlePhotoUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      if (file.size > 2 * 1024 * 1024) { // 2MB limit
          alert("Image trop lourde. Essayez de réduire la qualité.");
      }
      const reader = new FileReader();
      reader.onloadend = () => {
        setNewProduct(prev => ({ ...prev, photo: reader.result }));
      };
      reader.readAsDataURL(file);
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!newProduct.name || !newProduct.photo) return;
    
    await addItem({
      timestamp: Date.now(),
      dateString: new Date().toLocaleDateString('fr-FR'), 
      sortDate: new Date().toISOString().split('T')[0],   
      name: newProduct.name,
      batch: newProduct.batch,
      photo: newProduct.photo
    });

    setNewProduct({ name: '', batch: '', photo: null });
    setSelectedDate(new Date().toISOString().split('T')[0]);
  };

  const filteredProducts = products.filter(product => {
    const pDate = product.sortDate || new Date(product.timestamp).toISOString().split('T')[0];
    return pDate === selectedDate;
  });

  const changeDate = (days) => {
    const date = new Date(selectedDate);
    date.setDate(date.getDate() + days);
    setSelectedDate(date.toISOString().split('T')[0]);
  };

  return (
    <div className="space-y-6 animate-fadeIn">
      <div className="flex justify-between items-center">
        <h2 className="text-2xl font-bold text-green-800 flex items-center gap-2">
          <ScanBarcode className="w-8 h-8" />
          Traçabilité Produits
        </h2>
        {loading && <Loader2 className="w-5 h-5 animate-spin text-green-600" />}
      </div>

      <div className="grid lg:grid-cols-12 gap-6">
        <div className="lg:col-span-4 space-y-4">
          <Card className="h-fit border-2 border-green-500/20">
            <h3 className="font-bold text-lg text-gray-800 mb-4 flex items-center gap-2">
              <Camera className="w-5 h-5 text-green-600" /> Nouvel Arrivage
            </h3>
            <form onSubmit={handleSubmit}>
              <div className="mb-4">
                {newProduct.photo ? (
                  <div className="relative group cursor-pointer" onClick={() => setNewProduct({...newProduct, photo: null})}>
                    <img src={newProduct.photo} alt="Preview" className="w-full rounded-lg shadow-sm border border-green-200" />
                    <div className="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity rounded-lg">
                      <span className="text-white font-bold flex items-center gap-2">
                        <Trash2 className="w-5 h-5" /> Retirer
                      </span>
                    </div>
                  </div>
                ) : (
                  <div className="space-y-3">
                    <button
                      type="button"
                      onClick={startWebcam}
                      className="w-full py-8 bg-green-50 hover:bg-green-100 text-green-700 rounded-xl font-bold flex flex-col items-center justify-center gap-3 transition-colors border-2 border-dashed border-green-300 group"
                    >
                      <div className="w-16 h-16 bg-green-200 rounded-full flex items-center justify-center group-hover:scale-110 transition-transform shadow-sm">
                        <Aperture className="w-8 h-8 text-green-800" />
                      </div>
                      <span className="text-lg">Prendre une photo</span>
                    </button>
                    <div 
                      onClick={() => fileInputRef.current?.click()}
                      className="text-center text-sm text-gray-400 hover:text-green-600 cursor-pointer underline decoration-dotted"
                    >
                      Ou importer un fichier existant
                      <input 
                        type="file" 
                        accept="image/*" 
                        capture="environment" 
                        ref={fileInputRef}
                        onChange={handlePhotoUpload}
                        className="hidden" 
                      />
                    </div>
                  </div>
                )}
              </div>
              <Input 
                label="Nom du Produit" 
                placeholder="ex: Saumon Frais" 
                value={newProduct.name}
                onChange={e => setNewProduct({...newProduct, name: e.target.value})}
                required
              />
              <Input 
                label="Numéro de Lot / DLC" 
                placeholder="ex: L4589 - 12/10/24" 
                value={newProduct.batch}
                onChange={e => setNewProduct({...newProduct, batch: e.target.value})}
              />
              <Button type="submit" disabled={!newProduct.name || !newProduct.photo} className="w-full mt-2 py-4 text-lg shadow-lg shadow-green-200">
                <Save className="w-6 h-6" /> Enregistrer dans le Cloud
              </Button>
            </form>
          </Card>
        </div>

        <div className="lg:col-span-8 flex flex-col h-full">
          <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex flex-col sm:flex-row items-center justify-between gap-4 mb-4">
            <div className="flex items-center gap-2 w-full sm:w-auto">
              <button onClick={() => changeDate(-1)} className="p-2 hover:bg-gray-100 rounded-full border border-gray-200">
                <ChevronLeft className="w-5 h-5 text-gray-600" />
              </button>
              <div className="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-lg border border-gray-200 flex-1 sm:flex-initial justify-center">
                <CalendarIcon className="w-5 h-5 text-green-600" />
                <input 
                  type="date" 
                  value={selectedDate}
                  onChange={(e) => setSelectedDate(e.target.value)}
                  className="bg-transparent font-bold text-gray-700 outline-none text-center"
                />
              </div>
              <button onClick={() => changeDate(1)} className="p-2 hover:bg-gray-100 rounded-full border border-gray-200">
                <ChevronRight className="w-5 h-5 text-gray-600" />
              </button>
            </div>
            <div className="text-sm text-gray-500 font-medium">
              {filteredProducts.length} photo{filteredProducts.length > 1 ? 's' : ''} trouvée{filteredProducts.length > 1 ? 's' : ''}
            </div>
          </div>

          <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            {filteredProducts.length === 0 ? (
              <div className="col-span-full py-12 flex flex-col items-center justify-center text-gray-400 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
                <Search className="w-12 h-12 mb-2 opacity-20" />
                <p>Aucune traçabilité pour cette date.</p>
                {selectedDate !== new Date().toISOString().split('T')[0] && (
                  <button 
                    onClick={() => setSelectedDate(new Date().toISOString().split('T')[0])}
                    className="text-green-600 font-bold mt-2 hover:underline"
                  >
                    Revenir à aujourd'hui
                  </button>
                )}
              </div>
            ) : (
              filteredProducts.map(item => (
                <div key={item.id} className="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden flex flex-col hover:shadow-md transition-shadow">
                  <div 
                    className="relative h-48 bg-gray-100 cursor-zoom-in group"
                    onClick={() => setFullscreenPhoto(item.photo)}
                    title="Cliquer pour agrandir"
                  >
                    <img 
                      src={item.photo} 
                      alt={item.name} 
                      className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105" 
                    />
                    <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors" />
                    <div className="absolute bottom-2 right-2 bg-black/50 text-white p-1 rounded opacity-0 group-hover:opacity-100 transition-opacity">
                        <ZoomIn className="w-4 h-4" />
                    </div>
                  </div>
                  <div className="p-3 flex justify-between items-start">
                    <div>
                      <h4 className="font-bold text-gray-800 leading-tight">{item.name}</h4>
                      {item.batch && (
                        <p className="text-sm text-green-600 font-medium mt-1">Lot: {item.batch}</p>
                      )}
                    </div>
                    <button 
                      onClick={() => deleteItem(item.id)}
                      className="text-gray-300 hover:text-red-500 p-2 rounded-full hover:bg-red-50 transition-colors"
                    >
                      <Trash2 className="w-5 h-5" />
                    </button>
                  </div>
                </div>
              ))
            )}
          </div>
        </div>
      </div>

      {isWebcamOpen && (
        <div className="fixed inset-0 z-[200] bg-black flex flex-col items-center justify-center animate-fadeIn">
            <div className="relative w-full h-full flex flex-col">
                <div className="absolute top-0 left-0 right-0 p-4 flex justify-between items-center z-10 bg-gradient-to-b from-black/50 to-transparent">
                     <span className="text-white font-bold drop-shadow-md">Mode Photo</span>
                     <button 
                        onClick={stopWebcam}
                        className="p-3 bg-black/30 backdrop-blur-md text-white rounded-full hover:bg-red-500/80 transition-colors"
                     >
                        <X className="w-6 h-6" />
                     </button>
                </div>
                <div 
                  className="flex-1 relative bg-black flex items-center justify-center cursor-crosshair"
                  onClick={triggerFocus}
                >
                    <video 
                        ref={videoRef} 
                        autoPlay 
                        playsInline 
                        className="w-full h-full object-contain"
                    />
                    <canvas ref={canvasRef} className="hidden" />
                    {focusStatus === 'focused' && (
                        <div className="absolute inset-0 flex items-center justify-center pointer-events-none animate-ping-slow">
                            <div className="w-20 h-20 border-2 border-green-400 rounded-full opacity-75"></div>
                        </div>
                    )}
                     {focusStatus === 'focusing' && (
                        <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                            <div className="w-16 h-16 border-2 border-yellow-400 rounded-lg animate-pulse"></div>
                        </div>
                    )}
                </div>
                <div className="h-32 bg-black/80 backdrop-blur-sm flex items-center justify-center gap-8 pb-4">
                     <div className="flex flex-col items-center gap-1">
                        <button 
                            onClick={triggerFocus}
                            className="p-4 rounded-full bg-gray-800 text-white hover:bg-gray-700 transition-colors"
                            title="Refaire la mise au point"
                        >
                            <Focus className="w-6 h-6" />
                        </button>
                        <span className="text-xs text-gray-400">Focus</span>
                     </div>
                     <button 
                        onClick={captureWebcam}
                        className="p-1 rounded-full border-4 border-white hover:border-green-400 transition-colors active:scale-95 transform"
                     >
                        <div className="w-16 h-16 bg-white rounded-full border-4 border-black"></div>
                     </button>
                     <div className="w-16"></div>
                </div>
            </div>
        </div>
      )}

      {fullscreenPhoto && (
        <div 
          className="fixed inset-0 z-[100] bg-black/95 backdrop-blur-sm flex items-center justify-center overflow-hidden"
          onClick={() => setFullscreenPhoto(null)}
        >
          <div className="absolute top-4 right-4 flex gap-4 z-50">
             <div 
                className="flex bg-white/10 rounded-lg overflow-hidden backdrop-blur-md"
                onClick={(e) => e.stopPropagation()}
             >
                <button 
                    onClick={() => setZoomLevel(prev => Math.max(0.5, prev - 0.5))}
                    className="p-3 text-white hover:bg-white/20 transition-colors border-r border-white/10"
                >
                    <ZoomOut className="w-6 h-6" />
                </button>
                <span className="p-3 text-white font-mono text-sm flex items-center min-w-[3rem] justify-center">
                    {Math.round(zoomLevel * 100)}%
                </span>
                <button 
                    onClick={() => setZoomLevel(prev => Math.min(3, prev + 0.5))}
                    className="p-3 text-white hover:bg-white/20 transition-colors"
                >
                    <ZoomIn className="w-6 h-6" />
                </button>
             </div>
             <button 
                className="p-3 bg-white/10 text-white rounded-full hover:bg-white/20 transition-colors"
                onClick={() => setFullscreenPhoto(null)}
              >
                <X className="w-6 h-6" />
              </button>
          </div>
          <div 
            className="w-full h-full flex items-center justify-center overflow-auto p-4"
            style={{ cursor: zoomLevel > 1 ? 'grab' : 'default' }}
          >
            <img 
              src={fullscreenPhoto} 
              alt="Vue agrandie" 
              className="max-w-none transition-transform duration-200 ease-out origin-center"
              style={{ 
                  transform: `scale(${zoomLevel})`,
                  maxHeight: zoomLevel <= 1 ? '90vh' : 'none',
                  maxWidth: zoomLevel <= 1 ? '90vw' : 'none'
              }}
              onClick={(e) => e.stopPropagation()}
            />
          </div>
        </div>
      )}
    </div>
  );
};

// 2. Module Températures
const TemperatureModule = ({ user }) => {
  const { data: equipmentList, addItem: addEquip, deleteItem: removeEquip } = useFirestoreCollection('equipments', user);
  const { logs: temps, updateLog } = useDailyLogs('temperatures', user);

  const [showAddForm, setShowAddForm] = useState(false);
  const [newEquipName, setNewEquipName] = useState("");
  const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
  
  const [pickerState, setPickerState] = useState({ isOpen: false, equipId: null, equipName: '', period: '' });
  const [graphState, setGraphState] = useState({ isOpen: false, equipName: '' });
  const [isSaved, setIsSaved] = useState(false);

  const seedDefaults = async () => {
    const defaults = ["Chambre Froide Positive", "Chambre Froide Négative", "Vitrine Boissons", "Tour Réfrigérée"];
    for (const name of defaults) {
      await addEquip({ name });
    }
  };

  const changeDate = (days) => {
    const date = new Date(selectedDate);
    date.setDate(date.getDate() + days);
    setSelectedDate(date.toISOString().split('T')[0]);
    setIsSaved(false);
  };

  const handleTempChange = async (equipName, period, value) => {
    const currentDayData = temps[selectedDate] || {};
    const currentEquipData = currentDayData[equipName] || {};
    
    await updateLog(selectedDate, {
      [equipName]: {
        ...currentEquipData,
        [period]: value
      }
    });
    
    setIsSaved(false);
  };

  const handleSaveDay = () => {
    setIsSaved(true);
    setTimeout(() => setIsSaved(false), 3000);
  };

  const handleAddEquipment = async (e) => {
    e.preventDefault();
    if (newEquipName.trim()) {
      await addEquip({ name: newEquipName.trim() });
      setNewEquipName("");
      setShowAddForm(false);
    }
  };

  const getTempValue = (equipName, period) => temps[selectedDate]?.[equipName]?.[period] || '';

  const openPicker = (equipId, equipName, period) => {
    setPickerState({ isOpen: true, equipId, equipName, period });
  };

  return (
    <div className="space-y-6 animate-fadeIn">
      <div className="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
        <h2 className="text-2xl font-bold text-green-800 flex items-center gap-2">
          <Thermometer className="w-8 h-8" />
          Relevé de Températures
        </h2>
        
        <div className="flex items-center gap-4 bg-white p-2 rounded-xl shadow-sm border border-gray-200">
           <button onClick={() => changeDate(-1)} className="p-2 hover:bg-gray-100 rounded-full">
                <ChevronLeft className="w-5 h-5 text-gray-600" />
           </button>
           <div className="flex items-center gap-2 px-2 font-bold text-gray-700">
             <CalendarIcon className="w-5 h-5 text-green-600" />
             {new Date(selectedDate).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' })}
           </div>
           <button onClick={() => changeDate(1)} className="p-2 hover:bg-gray-100 rounded-full">
                <ChevronRight className="w-5 h-5 text-gray-600" />
           </button>
        </div>
      </div>

      <div className="grid gap-4">
        {equipmentList.length === 0 && (
            <div className="text-center py-8">
                <p className="text-gray-500 mb-4">Aucun équipement configuré.</p>
                <Button onClick={seedDefaults} variant="secondary">Charger les équipements par défaut</Button>
            </div>
        )}

        {equipmentList.map((equip) => (
          <Card key={equip.id} className="flex flex-col md:flex-row md:items-center justify-between gap-4 border-l-4 border-l-green-500 relative group transition-all hover:shadow-md">
            <div className="w-full md:w-1/3 flex justify-between items-center">
              <div 
                className="font-bold text-lg text-gray-700 flex items-center gap-2 cursor-pointer hover:text-green-600 transition-colors group/title"
                onClick={() => setGraphState({ isOpen: true, equipName: equip.name })}
                title="Voir le graphique"
              >
                {equip.name}
                <BarChart3 className="w-5 h-5 text-gray-300 group-hover/title:text-green-500" />
              </div>
              <button 
                onClick={() => removeEquip(equip.id)}
                className="md:hidden p-2 text-red-300 hover:text-red-500 hover:bg-red-50 rounded-full transition-colors"
              >
                <Trash2 className="w-5 h-5" />
              </button>
            </div>
            
            <div className="flex gap-4 flex-1">
              {['matin', 'soir'].map((period) => {
                const val = getTempValue(equip.name, period);
                return (
                  <div key={period} className="flex-1">
                    <label className="text-xs font-semibold text-gray-500 uppercase block mb-1">{period}</label>
                    <button
                        onClick={() => openPicker(equip.id, equip.name, period)}
                        className={`
                            w-full p-4 rounded-xl border-2 text-lg font-bold flex justify-between items-center transition-all
                            ${val !== '' ? 'bg-green-50 border-green-500 text-green-700' : 'bg-gray-50 border-gray-200 text-gray-400 hover:border-green-300'}
                        `}
                    >
                        <span>{val !== '' ? `${val > 0 ? '+' : ''}${val}°C` : '--'}</span>
                        <ChevronRight className="w-5 h-5 opacity-50 rotate-90" />
                    </button>
                  </div>
                );
              })}

              <button 
                onClick={() => removeEquip(equip.id)}
                className="hidden md:flex items-center justify-center text-gray-300 hover:text-red-500 hover:bg-red-50 p-3 rounded-full transition-colors"
                title="Supprimer ce frigo"
              >
                <Trash2 className="w-5 h-5" />
              </button>
            </div>
          </Card>
        ))}

        {showAddForm ? (
          <Card className="border-dashed border-2 border-green-300 bg-green-50/50">
            <form onSubmit={handleAddEquipment} className="flex gap-4 items-center">
              <input
                autoFocus
                type="text"
                placeholder="Nom du nouveau frigo/équipement..."
                className="flex-1 p-3 rounded-lg border border-green-300 focus:ring-2 focus:ring-green-500 outline-none"
                value={newEquipName}
                onChange={(e) => setNewEquipName(e.target.value)}
              />
              <Button type="submit">Valider</Button>
              <Button variant="ghost" onClick={() => setShowAddForm(false)}>Annuler</Button>
            </form>
          </Card>
        ) : (
          <button 
            onClick={() => setShowAddForm(true)}
            className="w-full py-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 font-medium hover:border-green-500 hover:text-green-600 hover:bg-green-50 transition-all flex items-center justify-center gap-2"
          >
            <Plus className="w-5 h-5" /> Ajouter un équipement
          </button>
        )}
      </div>

      <div className="fixed bottom-6 right-6 lg:bottom-10 lg:right-10 z-30">
          <button 
            onClick={handleSaveDay}
            className={`
                flex items-center gap-3 px-8 py-4 rounded-full font-bold text-lg shadow-xl transition-all transform hover:scale-105 active:scale-95
                ${isSaved ? 'bg-green-500 text-white' : 'bg-green-600 text-white hover:bg-green-700'}
            `}
          >
            {isSaved ? <CheckCircle className="w-6 h-6" /> : <Save className="w-6 h-6" />}
            {isSaved ? 'Enregistré !' : 'Enregistrer le jour'}
          </button>
      </div>

      {pickerState.isOpen && (
        <div className="fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm flex items-end sm:items-center justify-center animate-fadeIn" onClick={() => setPickerState({ ...pickerState, isOpen: false })}>
            <div 
                className="bg-white w-full sm:w-[400px] rounded-t-2xl sm:rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[80vh]"
                onClick={(e) => e.stopPropagation()}
            >
                <div className="p-4 bg-green-600 text-white flex justify-between items-center">
                    <div>
                        <h3 className="font-bold text-lg">{pickerState.equipName}</h3>
                        <p className="text-green-100 text-sm capitalize">{pickerState.period}</p>
                    </div>
                    <button onClick={() => setPickerState({ ...pickerState, isOpen: false })} className="p-2 hover:bg-white/20 rounded-full"><X className="w-6 h-6" /></button>
                </div>
                
                <div className="overflow-y-auto p-2 grid grid-cols-4 gap-2 bg-gray-50">
                    {Array.from({length: 61}, (_, i) => i - 40).reverse().map(temp => (
                        <button
                            key={temp}
                            onClick={() => {
                                handleTempChange(pickerState.equipName, pickerState.period, temp);
                                setPickerState({ ...pickerState, isOpen: false });
                            }}
                            className={`
                                py-4 rounded-lg font-bold text-lg shadow-sm border
                                ${getTempValue(pickerState.equipName, pickerState.period) == temp 
                                    ? 'bg-green-600 text-white border-green-700 ring-2 ring-green-300' 
                                    : temp > 0 
                                        ? 'bg-white text-gray-800 border-gray-200 hover:bg-orange-50 hover:border-orange-300' 
                                        : temp === 0
                                            ? 'bg-gray-100 text-gray-600 border-gray-300'
                                            : 'bg-white text-blue-800 border-blue-100 hover:bg-blue-50 hover:border-blue-300'
                                }
                            `}
                        >
                            {temp > 0 ? '+' : ''}{temp}
                        </button>
                    ))}
                </div>
            </div>
        </div>
      )}

      {graphState.isOpen && (
          <GraphModal 
            isOpen={graphState.isOpen} 
            onClose={() => setGraphState({ ...graphState, isOpen: false })} 
            equipName={graphState.equipName}
            allTemps={temps}
          />
      )}
    </div>
  );
};

// Composant Graphique SVG Simple
const GraphModal = ({ isOpen, onClose, equipName, allTemps }) => {
    const data = useMemo(() => {
        const result = [];
        const today = new Date();
        for (let i = 6; i >= 0; i--) {
            const d = new Date(today);
            d.setDate(today.getDate() - i);
            const dateStr = d.toLocaleDateString('fr-FR').replace(/\//g, '-');
            const dayData = allTemps[dateStr]?.[equipName] || {};
            const label = d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'numeric' });
            result.push({ label, matin: dayData.matin, soir: dayData.soir });
        }
        return result;
    }, [allTemps, equipName]);

    const width = 600;
    const height = 300;
    const padding = 40;
    const maxTemp = 20;
    const minTemp = -30;
    const range = maxTemp - minTemp;

    const getY = (temp) => {
        if (temp === undefined || temp === "") return null;
        return height - padding - ((temp - minTemp) / range) * (height - 2 * padding);
    };

    const getX = (index) => padding + (index / (data.length - 1)) * (width - 2 * padding);

    const createPath = (key) => {
        if(data.length < 2) return "";
        return data.map((point, i) => {
            const y = getY(point[key]);
            if (y === null) return null;
            return `${i === 0 ? 'M' : 'L'} ${getX(i)} ${y}`;
        }).filter(Boolean).join(' ');
    };

    const pathMatin = createPath('matin');
    const pathSoir = createPath('soir');

    return (
        <div className="fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 animate-fadeIn" onClick={onClose}>
            <div className="bg-white w-full max-w-2xl rounded-2xl shadow-2xl p-6" onClick={e => e.stopPropagation()}>
                <div className="flex justify-between items-start mb-6">
                    <div>
                        <h3 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                            <TrendingUp className="w-6 h-6 text-green-600" />
                            Historique : {equipName}
                        </h3>
                        <p className="text-gray-500 text-sm">7 derniers jours</p>
                    </div>
                    <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-full"><X className="w-6 h-6" /></button>
                </div>

                <div className="flex gap-6 mb-4 justify-center text-sm font-bold">
                    <div className="flex items-center gap-2 text-blue-600">
                        <div className="w-3 h-3 rounded-full bg-blue-500"></div> Matin
                    </div>
                    <div className="flex items-center gap-2 text-orange-600">
                        <div className="w-3 h-3 rounded-full bg-orange-500"></div> Soir
                    </div>
                </div>

                <div className="relative w-full aspect-video bg-gray-50 rounded-lg border border-gray-100 overflow-hidden">
                    <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full">
                        {[0, 0.25, 0.5, 0.75, 1].map(ratio => {
                             const y = padding + ratio * (height - 2 * padding);
                             return <line key={ratio} x1={padding} y1={y} x2={width-padding} y2={y} stroke="#e5e7eb" strokeDasharray="4" />
                        })}
                        <line x1={padding} y1={getY(0)} x2={width-padding} y2={getY(0)} stroke="#9ca3af" strokeWidth="1" />
                        {pathMatin && <path d={pathMatin} fill="none" stroke="#3b82f6" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" />}
                        {pathSoir && <path d={pathSoir} fill="none" stroke="#f97316" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" />}
                        {data.map((point, i) => (
                            <g key={i}>
                                {getY(point.matin) && <circle cx={getX(i)} cy={getY(point.matin)} r="4" fill="white" stroke="#3b82f6" strokeWidth="2" />}
                                {getY(point.soir) && <circle cx={getX(i)} cy={getY(point.soir)} r="4" fill="white" stroke="#f97316" strokeWidth="2" />}
                                <text x={getX(i)} y={height - 10} textAnchor="middle" fontSize="12" fill="#6b7280">{point.label}</text>
                            </g>
                        ))}
                    </svg>
                </div>
            </div>
        </div>
    );
};

// 3. Module Nettoyage
const CleaningModule = ({ user }) => {
  const { data: zones, addItem: addZone, deleteItem: removeZone } = useFirestoreCollection('cleaning_zones', user);
  const { logs: cleaningLog, updateLog } = useDailyLogs('cleaning_logs', user);

  const [showAddForm, setShowAddForm] = useState(false);
  const [newZone, setNewZone] = useState({ name: "", freq: "Journalier" });

  const [historyModal, setHistoryModal] = useState({ isOpen: false, zoneId: null, zoneName: '' });

  const today = new Date().toLocaleDateString('fr-FR').replace(/\//g, '-');

  const seedDefaults = async () => {
    const defaults = [
      { name: "Plan de travail Inox", freq: "Journalier" },
      { name: "Sols Cuisine", freq: "Journalier" },
      { name: "Piano de cuisson", freq: "Journalier" },
      { name: "Hotte (Filtres)", freq: "Hebdomadaire" },
      { name: "Poubelles", freq: "Journalier" },
    ];
    for (const z of defaults) await addZone(z);
  };

  const toggleClean = async (id) => {
    const currentStatus = cleaningLog[today]?.[id] || false;
    await updateLog(today, { [id]: !currentStatus });
  };

  const handleAddZone = async (e) => {
    e.preventDefault();
    if (newZone.name.trim()) {
      await addZone(newZone);
      setNewZone({ name: "", freq: "Journalier" });
      setShowAddForm(false);
    }
  };

  const isDone = (id) => cleaningLog[today]?.[id];

  const getLastCleanDate = (zoneId) => {
      const sortedDates = Object.keys(cleaningLog).sort((a, b) => {
          const dateA = new Date(a.split('-').reverse().join('-'));
          const dateB = new Date(b.split('-').reverse().join('-'));
          return dateB - dateA;
      });

      for (let date of sortedDates) {
          if (cleaningLog[date]?.[zoneId]) {
              return date; // Format DD-MM-YYYY
          }
      }
      return null;
  };

  const getDaysSinceLast = (lastDateStr) => {
      if (!lastDateStr) return null;
      const [d, m, y] = lastDateStr.split('-').map(Number);
      const lastDate = new Date(y, m - 1, d);
      const todayDate = new Date();
      todayDate.setHours(0,0,0,0);
      lastDate.setHours(0,0,0,0);
      
      const diffTime = Math.abs(todayDate - lastDate);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      return diffDays;
  };

  const getStatusColor = (freq, days) => {
      if (days === null) return 'text-gray-400 bg-gray-100'; 
      if (days === 0) return 'text-green-600 bg-green-100'; 

      if (freq === 'Journalier') {
          if (days === 1) return 'text-green-600 bg-green-100'; 
          return 'text-red-600 bg-red-100'; 
      }
      if (freq === 'Hebdomadaire') {
          if (days <= 7) return 'text-green-600 bg-green-100';
          return 'text-red-600 bg-red-100';
      }
      if (freq === 'Mensuel') {
          if (days <= 30) return 'text-green-600 bg-green-100';
          return 'text-red-600 bg-red-100';
      }
      return 'text-gray-600 bg-gray-100';
  };

  const totalTasks = zones.length;
  const doneTasks = zones.filter(z => isDone(z.id)).length;
  const progress = totalTasks === 0 ? 0 : Math.round((doneTasks / totalTasks) * 100);

  return (
    <div className="space-y-6 animate-fadeIn">
      <div className="flex justify-between items-end mb-4">
        <div>
           <h2 className="text-2xl font-bold text-green-800 flex items-center gap-2">
            <ClipboardCheck className="w-8 h-8" />
            Plan de Nettoyage
          </h2>
          <p className="text-gray-500 text-sm mt-1">Cochez les tâches effectuées aujourd'hui</p>
        </div>
        <div className="text-right">
          <div className="text-3xl font-bold text-green-600">{progress}%</div>
          <div className="text-xs text-gray-400 uppercase font-semibold">Complété</div>
        </div>
      </div>

      <div className="w-full bg-gray-200 rounded-full h-2.5 mb-6">
        <div className="bg-green-600 h-2.5 rounded-full transition-all duration-500" style={{ width: `${progress}%` }}></div>
      </div>

      <div className="grid gap-3">
        {zones.length === 0 && (
            <div className="text-center py-8">
                <p className="text-gray-500 mb-4">Aucune zone de nettoyage configurée.</p>
                <Button onClick={seedDefaults} variant="secondary">Charger la liste standard</Button>
            </div>
        )}

        {zones.map((zone) => {
            const lastDate = getLastCleanDate(zone.id);
            const daysSince = getDaysSinceLast(lastDate);
            const statusClass = getStatusColor(zone.freq, daysSince);

            return (
              <div 
                key={zone.id}
                onClick={() => toggleClean(zone.id)}
                className={`
                  p-4 rounded-xl border cursor-pointer transition-all duration-200 flex items-center justify-between group relative pr-28
                  ${isDone(zone.id) 
                    ? 'bg-green-600 border-green-700 shadow-md transform scale-[1.01]' 
                    : 'bg-white border-gray-200 hover:border-green-300 hover:shadow-sm'}
                `}
              >
                <div>
                  <h4 className={`font-bold text-lg ${isDone(zone.id) ? 'text-white' : 'text-gray-800'}`}>
                    {zone.name}
                  </h4>
                  <div className="flex items-center gap-2 mt-1">
                      <span className={`text-xs px-2 py-0.5 rounded-full ${isDone(zone.id) ? 'bg-green-500 text-green-50' : 'bg-gray-100 text-gray-500'}`}>
                        {zone.freq}
                      </span>
                      <span className={`text-xs font-medium flex items-center gap-1 ${isDone(zone.id) ? 'text-green-100' : 'text-gray-400'}`}>
                         <Clock className="w-3 h-3" />
                         {lastDate ? `Fait le ${lastDate}` : 'Jamais fait'}
                      </span>
                  </div>
                </div>
                
                <div className="flex items-center gap-4">
                    {!isDone(zone.id) && daysSince !== null && (
                         <div className={`px-2 py-1 rounded text-xs font-bold flex items-center gap-1 ${statusClass}`}>
                             {daysSince > 0 && daysSince < 100 ? `J+${daysSince}` : daysSince === 0 ? "Auj." : "!"}
                             {(statusClass.includes('red')) && <AlertTriangle className="w-3 h-3" />}
                         </div>
                    )}

                    <div className={`
                      w-10 h-10 rounded-full flex items-center justify-center transition-colors
                      ${isDone(zone.id) ? 'bg-white text-green-600' : 'bg-gray-100 text-gray-300 group-hover:text-green-400'}
                    `}>
                      <CheckCircle className="w-6 h-6" />
                    </div>
                </div>

                <button
                    onClick={(e) => {
                        e.stopPropagation();
                        setHistoryModal({ isOpen: true, zoneId: zone.id, zoneName: zone.name });
                    }}
                    className={`
                        absolute top-1/2 -translate-y-1/2 right-14 p-2 rounded-full transition-colors z-20
                        ${isDone(zone.id) ? 'text-green-300 hover:text-white' : 'text-gray-300 hover:text-green-600 hover:bg-green-50'}
                    `}
                    title="Voir l'historique"
                >
                    <History className="w-5 h-5" />
                </button>

                <button
                  onClick={(e) => { e.stopPropagation(); removeZone(zone.id); }}
                  className={`
                    absolute top-1/2 -translate-y-1/2 right-2 p-3 rounded-full transition-colors z-20
                    ${isDone(zone.id) ? 'text-green-300 hover:text-white hover:bg-red-500/30' : 'text-gray-300 hover:text-red-500 hover:bg-red-50'}
                  `}
                  title="Supprimer la tâche"
                >
                  <Trash2 className="w-5 h-5" />
                </button>
              </div>
            );
        })}

        {showAddForm ? (
          <Card className="border-dashed border-2 border-green-300 bg-green-50/50">
            <form onSubmit={handleAddZone} className="flex flex-col gap-3">
              <input
                autoFocus
                type="text"
                placeholder="Nom de la tâche (ex: Nettoyer trancheuse)"
                className="w-full p-3 rounded-lg border border-green-300 focus:ring-2 focus:ring-green-500 outline-none"
                value={newZone.name}
                onChange={(e) => setNewZone({...newZone, name: e.target.value})}
              />
              <div className="flex gap-3">
                <select 
                  className="p-3 rounded-lg border border-green-300 bg-white"
                  value={newZone.freq}
                  onChange={(e) => setNewZone({...newZone, freq: e.target.value})}
                >
                  <option value="Journalier">Journalier</option>
                  <option value="Hebdomadaire">Hebdomadaire</option>
                  <option value="Mensuel">Mensuel</option>
                </select>
                <Button type="submit" className="flex-1">Ajouter</Button>
                <Button variant="ghost" onClick={() => setShowAddForm(false)}>Annuler</Button>
              </div>
            </form>
          </Card>
        ) : (
          <button 
            onClick={() => setShowAddForm(true)}
            className="w-full py-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 font-medium hover:border-green-500 hover:text-green-600 hover:bg-green-50 transition-all flex items-center justify-center gap-2"
          >
            <Plus className="w-5 h-5" /> Ajouter une tâche de nettoyage
          </button>
        )}
      </div>

      {/* MODALE HISTORIQUE NETTOYAGE */}
      {historyModal.isOpen && (
          <div className="fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 animate-fadeIn" onClick={() => setHistoryModal({ ...historyModal, isOpen: false })}>
              <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[80vh]" onClick={(e) => e.stopPropagation()}>
                  <div className="p-4 bg-green-600 text-white flex justify-between items-center">
                      <h3 className="font-bold text-lg flex items-center gap-2">
                          <History className="w-5 h-5" /> Historique
                      </h3>
                      <button onClick={() => setHistoryModal({ ...historyModal, isOpen: false })} className="p-2 hover:bg-white/20 rounded-full"><X className="w-6 h-6" /></button>
                  </div>
                  
                  <div className="p-4 border-b border-gray-100 bg-gray-50">
                      <p className="text-sm text-gray-500 uppercase font-bold">Équipement</p>
                      <p className="text-xl font-bold text-gray-800">{historyModal.zoneName}</p>
                  </div>

                  <div className="overflow-y-auto p-4 space-y-2">
                      {(() => {
                          const logs = Object.keys(cleaningLog)
                              .filter(date => cleaningLog[date]?.[historyModal.zoneId])
                              .sort((a, b) => {
                                  const dateA = new Date(a.split('-').reverse().join('-'));
                                  const dateB = new Date(b.split('-').reverse().join('-'));
                                  return dateB - dateA;
                              })
                              .slice(0, 10);

                          if (logs.length === 0) return <p className="text-gray-400 text-center py-4 italic">Aucun historique disponible.</p>;

                          return logs.map((date, idx) => (
                              <div key={idx} className="flex justify-between items-center p-3 bg-white border border-gray-100 rounded-lg shadow-sm">
                                  <div className="font-medium text-gray-700">{date}</div>
                                  <div className="flex items-center text-green-600 text-sm font-bold gap-1">
                                      <CheckCircle className="w-4 h-4" /> Fait
                                  </div>
                              </div>
                          ));
                      })()}
                  </div>
              </div>
          </div>
      )}
    </div>
  );
};

// --- Composant Principal App ---

export default function App() {
  const [activeTab, setActiveTab] = useState('traceability');
  const [sidebarOpen, setSidebarOpen] = useState(true);
  const [user, setUser] = useState(null);
  const [initLoading, setInitLoading] = useState(true);

  useEffect(() => {
    const handleResize = () => {
      if (window.innerWidth < 1024) setSidebarOpen(false);
      else setSidebarOpen(true);
    };
    handleResize();
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  // Authentification
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
        } else {
            await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("Auth Error:", err);
      }
    };
    initAuth();
    
    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
      setInitLoading(false);
    });
    return () => unsubscribe();
  }, []);

  const menuItems = [
    { id: 'traceability', label: 'Traçabilité', icon: ScanBarcode },
    { id: 'temperature', label: 'Températures', icon: Thermometer },
    { id: 'cleaning', label: 'Nettoyage', icon: ClipboardCheck },
  ];

  if (initLoading) {
      return (
          <div className="h-screen w-full flex flex-col items-center justify-center bg-green-50 text-green-800 gap-4">
              <Loader2 className="w-12 h-12 animate-spin" />
              <p className="font-bold">Connexion à eHygiène Cloud...</p>
          </div>
      );
  }

  return (
    <div className="flex h-screen bg-green-50/50 font-sans text-gray-900 overflow-hidden">
      
      <aside 
        className={`
          fixed lg:static inset-y-0 left-0 z-50 w-72 bg-white border-r border-green-100 shadow-xl lg:shadow-none transform transition-transform duration-300 ease-in-out
          ${sidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'}
        `}
      >
        <div className="h-full flex flex-col">
          <div className="p-8 border-b border-green-50">
            <h1 className="text-2xl font-extrabold text-green-700 tracking-tight">
              eHygiène<span className="text-green-400">.</span>
            </h1>
            <p className="text-xs text-gray-400 mt-1 uppercase tracking-wider font-semibold">Gestion HACCP Cloud</p>
          </div>

          <nav className="flex-1 p-4 space-y-2">
            {menuItems.map((item) => {
              const Icon = item.icon;
              const isActive = activeTab === item.id;
              return (
                <button
                  key={item.id}
                  onClick={() => {
                    setActiveTab(item.id);
                    if (window.innerWidth < 1024) setSidebarOpen(false);
                  }}
                  className={`
                    w-full flex items-center gap-4 px-4 py-4 rounded-xl transition-all duration-200
                    ${isActive 
                      ? 'bg-green-600 text-white shadow-lg shadow-green-200' 
                      : 'text-gray-600 hover:bg-green-50 hover:text-green-700'}
                  `}
                >
                  <Icon className={`w-6 h-6 ${isActive ? 'text-white' : 'text-gray-400'}`} />
                  <span className="font-semibold text-lg">{item.label}</span>
                  {isActive && <ChevronRight className="ml-auto w-5 h-5 opacity-50" />}
                </button>
              );
            })}
          </nav>

          <div className="p-6 bg-gray-50 border-t border-gray-100">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 rounded-full bg-green-200 flex items-center justify-center text-green-700 font-bold">
                <Cloud className="w-5 h-5" />
              </div>
              <div>
                <p className="text-sm font-bold text-gray-700">Cuisine Principale</p>
                <div className="flex items-center gap-1">
                    <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                    <p className="text-xs text-green-600">Connecté</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </aside>

      {sidebarOpen && (
        <div 
          className="fixed inset-0 bg-black/20 z-40 lg:hidden backdrop-blur-sm"
          onClick={() => setSidebarOpen(false)}
        />
      )}

      <main className="flex-1 flex flex-col h-full overflow-hidden relative">
        <header className="lg:hidden bg-white p-4 flex items-center justify-between border-b border-gray-200 shadow-sm z-30">
          <button onClick={() => setSidebarOpen(true)} className="p-2 text-gray-600 hover:bg-gray-100 rounded-lg">
            <Menu className="w-6 h-6" />
          </button>
          <span className="font-bold text-green-700">eHygiène</span>
          <div className="w-8"></div>
        </header>

        <div className="flex-1 overflow-y-auto p-4 lg:p-10 pb-20">
          <div className="max-w-7xl mx-auto">
            {activeTab === 'traceability' && <TraceabilityModule user={user} />}
            {activeTab === 'temperature' && <TemperatureModule user={user} />}
            {activeTab === 'cleaning' && <CleaningModule user={user} />}
          </div>
        </div>
      </main>
    </div>
  );
}
