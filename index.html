<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Application de Pointage d'Heure</title>
    
    <!-- M√©ta-donn√©es pour PWA (Progressive Web App) -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Pointage">
    <meta name="application-name" content="Pointage">
    <meta name="theme-color" content="#2563eb">

    <!-- Placeholders pour les ic√¥nes -->
    <link rel="icon" type="image/png" id="dynamic-favicon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üïí</text></svg>">
    <link rel="apple-touch-icon" id="dynamic-apple-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üïí</text></svg>">
    <link rel="manifest" id="dynamic-manifest">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Utilisation de xlsx-js-style pour le style Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, updateDoc, onSnapshot, collection, query, where, limit, getDocs, deleteDoc, orderBy, serverTimestamp, getDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            getFirestore,
            doc,
            addDoc,
            setDoc,
            updateDoc,
            onSnapshot,
            collection,
            query,
            where,
            limit,
            getDocs,
            deleteDoc,
            orderBy,
            serverTimestamp,
            getDoc,
            Timestamp
        };
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
            touch-action: manipulation; 
            overscroll-behavior-y: none;
        }
        .container-card {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05), 0 0 10px rgba(0, 0, 0, 0.03);
            background-color: white;
        }
        .btn-primary {
            transition: all 0.2s;
        }
        .btn-primary:active {
            transform: scale(0.98);
        }
        .input-4-digit {
            letter-spacing: 0.5rem;
            text-align: center;
            font-family: monospace;
        }
        
        /* SCROLL WHEEL STYLES */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .wheel-container {
            position: relative;
            height: 160px;
            overflow: hidden;
            background: #f8fafc;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
        }
        .wheel-highlight {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 40px;
            margin-top: -20px;
            background-color: #dbeafe;
            border-top: 1px solid #93c5fd;
            border-bottom: 1px solid #93c5fd;
            pointer-events: none;
            z-index: 0;
        }
        .wheel-column {
            height: 100%;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            padding-top: 60px; /* Aligns perfectly with highlight at top 50% - 20px */
            padding-bottom: 60px;
            position: relative;
            z-index: 10;
        }
        .wheel-item {
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            scroll-snap-align: center;
            font-size: 1.25rem;
            font-weight: 600;
            color: #64748b;
            transition: color 0.2s, transform 0.2s;
        }
        
        .numpad-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        .numpad-btn {
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            height: 60px;
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: background-color 0.15s, transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        .numpad-btn:active {
            background-color: #f1f5f9;
            transform: scale(0.95);
        }
        .numpad-btn.action-btn {
            background-color: #eff6ff;
            color: #2563eb;
            border-color: #bfdbfe;
        }
        .numpad-btn.clear-btn {
            background-color: #fef2f2;
            color: #dc2626;
            border-color: #fecaca;
        }
        
        /* Toast notification */
        #toast-notification {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 17px;
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }
        #toast-notification.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }
        
        /* Logo Upload Styles */
        .logo-container {
            position: relative;
            cursor: pointer;
            display: inline-block;
        }
        .logo-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            font-weight: bold;
            text-align: center;
        }
        .logo-container:hover .logo-overlay {
            opacity: 1;
        }
        
        /* Loading spinner for logo */
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
            margin: auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Success Animation */
        @keyframes progress { from { width: 100%; } to { width: 0%; } }
        .progress-bar { animation: progress 5s linear forwards; }
        
        /* Table Preview Styles - AGRANDI ET CLARIFI√â */
        .preview-header { 
            background-color: #FFC000; 
            font-weight: bold; 
            text-align: center; 
            font-size: 0.85rem;
            border: 1px solid #94a3b8;
            padding: 12px 6px;
            color: #0f172a;
            white-space: nowrap;
        }
        .preview-cell { 
            text-align: center; 
            font-size: 0.95rem;
            border: 1px solid #cbd5e1; 
            padding: 12px 6px;
            color: #334155;
            white-space: nowrap;
        }
        .preview-week-row { 
            background-color: #FFFF00; 
            font-weight: bold; 
            color: #DC2626; 
            text-align: center;
            font-size: 0.9rem;
            padding: 8px;
        }
        .preview-total-row { 
            background-color: #FFF2CC; 
            font-weight: bold; 
            text-align: center; 
            font-size: 0.85rem; 
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 flex flex-col items-center">

    <!-- Auth / App Info -->
    <div id="auth-info" class="mb-4 text-xs text-gray-500 w-full max-w-4xl text-center">
        Statut: <span id="connection-status" class="font-bold text-orange-500">D√©marrage...</span>
    </div>

    <!-- Main Application Container -->
    <div id="app-container" class="w-full max-w-4xl container-card rounded-xl p-6 md:p-10 relative">
        <div id="error-banner-container"></div>

        <div class="flex flex-col items-center justify-center mb-6">
            <!-- Hidden File Input for Logo -->
            <input type="file" id="logo-upload-input" accept="image/*" class="hidden" onchange="handleLogoUpload(this)">
            
            <!-- Logo Image Container with Click-to-Edit -->
            <div class="logo-container mb-4" onclick="document.getElementById('logo-upload-input').click()" title="Cliquez pour changer le logo">
                <img id="app-logo" src="logo.png" 
                     alt="Logo Pointage" 
                     class="h-48 w-auto object-contain rounded-lg shadow-sm hover:shadow-md transition-shadow duration-300 hidden">
                
                <!-- Fallback Icon (also clickable) -->
                <div id="fallback-logo-icon" class="bg-blue-50 p-4 rounded-full text-blue-600 border border-blue-100 shadow-sm cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                    </svg>
                    <div class="text-xs text-center mt-1 font-bold">Ajouter Logo</div>
                </div>
                
                <!-- Loading State -->
                <div id="logo-loading" class="hidden absolute inset-0 bg-white bg-opacity-80 flex items-center justify-center rounded-lg">
                    <div class="loading-spinner"></div>
                </div>

                <!-- Hover Overlay -->
                <div class="logo-overlay">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </div>
            </div>

            <h1 class="text-3xl font-bold text-gray-800 text-center">Syst√®me de Pointage d'Heure</h1>
            <p class="text-xs text-gray-400 mt-2">Mode: Donn√©es Partag√©es (Cloud Public)</p>
        </div>

        <!-- Navigation Tabs -->
        <div class="flex border-b border-gray-200 mb-8">
            <button id="tab-punch" onclick="showView('punch')" class="flex-1 py-3 text-sm font-medium border-b-2 transition-colors duration-200" data-active-class="border-blue-600 text-blue-600" data-inactive-class="border-transparent text-gray-500 hover:text-gray-700">Pointage Employ√©</button>
            <button id="tab-admin" onclick="requestAdminAccess()" class="flex-1 py-3 text-sm font-medium border-b-2 transition-colors duration-200" data-active-class="border-blue-600 text-blue-600" data-inactive-class="border-transparent text-gray-500 hover:text-gray-700">
                <span class="flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                    Administration
                </span>
            </button>
        </div>

        <!-- 1. PUNCH CLOCK INTERFACE -->
        <div id="view-punch" class="view-content">
            <div class="max-w-md mx-auto">
                
                <!-- STEP 1: LOGIN (Code Entry) -->
                <div id="step-login" class="p-6 bg-blue-50 rounded-lg shadow-inner mb-8">
                    <p class="text-center text-lg font-medium text-blue-800 mb-4">Entrez votre code</p>
                    <input id="employee-code" type="text" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" readonly class="input-4-digit w-full p-4 text-4xl border-2 border-blue-300 rounded-lg bg-white focus:ring-blue-500 focus:border-blue-500 mb-6 text-gray-800">
                    <div class="numpad-grid select-none">
                        <div onclick="typeNum('employee-code', '1')" class="numpad-btn">1</div>
                        <div onclick="typeNum('employee-code', '2')" class="numpad-btn">2</div>
                        <div onclick="typeNum('employee-code', '3')" class="numpad-btn">3</div>
                        <div onclick="typeNum('employee-code', '4')" class="numpad-btn">4</div>
                        <div onclick="typeNum('employee-code', '5')" class="numpad-btn">5</div>
                        <div onclick="typeNum('employee-code', '6')" class="numpad-btn">6</div>
                        <div onclick="typeNum('employee-code', '7')" class="numpad-btn">7</div>
                        <div onclick="typeNum('employee-code', '8')" class="numpad-btn">8</div>
                        <div onclick="typeNum('employee-code', '9')" class="numpad-btn">9</div>
                        <div onclick="clearNum('employee-code')" class="numpad-btn clear-btn">Effacer</div>
                        <div onclick="typeNum('employee-code', '0')" class="numpad-btn">0</div>
                        <div onclick="verifyCodeAndShowMenu()" class="numpad-btn action-btn bg-blue-600 text-white border-blue-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                        </div>
                    </div>
                    <button onclick="verifyCodeAndShowMenu()" class="w-full btn-primary bg-blue-600 text-white font-bold py-4 rounded-xl text-xl shadow-lg hover:bg-blue-700 flex items-center justify-center">
                        <span class="mr-2">VALIDER</span>
                    </button>
                    <p id="punch-message" class="text-center mt-4 text-sm font-medium h-6"></p>
                </div>

                <!-- STEP 2: EMPLOYEE DASHBOARD (Choice: Punch or History) -->
                <div id="step-dashboard" class="hidden">
                    <div class="text-center mb-8">
                        <h2 id="dashboard-welcome" class="text-2xl font-bold text-gray-800">Bonjour</h2>
                        <p class="text-sm text-gray-500">Que souhaitez-vous faire ?</p>
                    </div>
                    
                    <div class="grid grid-cols-1 gap-6">
                        <button onclick="onMenuPunch()" id="btn-punch-action" class="p-8 rounded-xl shadow-lg border-2 text-left transition-all transform active:scale-95 flex items-center justify-between group">
                            <!-- JS will update class and text here (Green/Red) -->
                            <div class="flex items-center">
                                <div id="btn-punch-icon" class="p-4 rounded-full mr-4 bg-gray-100">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                                <div>
                                    <span id="btn-punch-text" class="block text-xl font-bold text-gray-800">Pointer / D√©pointer</span>
                                    <span id="btn-punch-sub" class="text-sm text-gray-500">Chargement...</span>
                                </div>
                            </div>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400 group-hover:text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </button>

                        <button onclick="onMenuHistory()" class="bg-white p-8 rounded-xl shadow-lg border-2 border-blue-100 hover:border-blue-300 text-left transition-all transform active:scale-95 flex items-center justify-between group">
                            <div class="flex items-center">
                                <div class="bg-blue-50 p-4 rounded-full mr-4 text-blue-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                </div>
                                <div>
                                    <span class="block text-xl font-bold text-gray-800">Voir mes heures</span>
                                    <span class="text-sm text-gray-500">Consulter le tableau du mois</span>
                                </div>
                            </div>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400 group-hover:text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>

                    <button onclick="resetToCodeEntry()" class="w-full mt-8 py-3 text-gray-500 font-medium hover:text-red-600 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z" />
                        </svg>
                        Retour / D√©connexion
                    </button>
                </div>

                <!-- STEP 3: EMPLOYEE HISTORY TABLE -->
                <div id="step-history" class="hidden">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold text-gray-800">Mes Heures (Ce mois)</h2>
                        <button onclick="document.getElementById('step-history').classList.add('hidden'); document.getElementById('step-dashboard').classList.remove('hidden');" class="text-blue-600 font-bold text-sm bg-blue-50 px-3 py-2 rounded-lg hover:bg-blue-100">
                            Retour
                        </button>
                    </div>
                    <!-- Hauteur augment√©e √† h-[70vh] pour une meilleure vue sur mobile/tablette -->
                    <div class="overflow-auto border border-gray-300 rounded-lg shadow-inner bg-white h-[70vh]">
                        <table class="min-w-full border-collapse">
                            <thead class="sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="preview-header">Sem</th>
                                    <th class="preview-header">Date</th>
                                    <th class="preview-header">Arr M</th>
                                    <th class="preview-header">Dep M</th>
                                    <th class="preview-header">Pau M</th>
                                    <th class="preview-header">Tot M</th>
                                    <th class="preview-header">Arr S</th>
                                    <th class="preview-header">Dep S</th>
                                    <th class="preview-header">Pau S</th>
                                    <th class="preview-header">Tot S</th>
                                    <th class="preview-header">Total</th>
                                </tr>
                            </thead>
                            <tbody id="employee-history-body" class="bg-white">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>

        <!-- 2. ADMIN INTERFACE (Unchanged) -->
        <div id="view-admin" class="view-content hidden">
             <!-- NEW: Month Picker for Preview & Export -->
            <div class="mb-6 bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex items-center justify-between">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Mois √† visualiser / exporter :</label>
                    <input type="month" id="admin-month-picker" class="p-2 border rounded shadow-sm focus:ring-blue-500 focus:border-blue-500 text-gray-700 font-medium" onchange="renderMonthPreview()">
                </div>
                <div>
                     <button onclick="exportToExcel()" class="btn-primary bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 flex items-center justify-center shadow">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        T√©l√©charger Excel
                    </button>
                </div>
            </div>

             <!-- Manual Correction Tool -->
             <div class="mb-10 p-6 bg-white rounded-lg shadow-sm border border-orange-200">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center text-orange-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                        Corrections & Ajout Manuel
                    </h3>
                    <button onclick="openManualPunchModal(null)" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded text-sm font-medium flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        Nouvelle Entr√©e
                    </button>
                </div>
                <div class="flex flex-col md:flex-row gap-4 mb-4 bg-orange-50 p-4 rounded-lg">
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-gray-500 mb-1">Employ√©</label>
                        <select id="admin-correction-employee" class="w-full p-2 border rounded focus:ring-orange-500 focus:border-orange-500" onchange="loadCorrectionData()">
                            <option value="">-- Tous les employ√©s --</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">Date √† corriger</label>
                        <input type="date" id="admin-correction-date" class="p-2 border rounded focus:ring-orange-500 focus:border-orange-500" onchange="loadCorrectionData()">
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Employ√©</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Arriv√©e</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">D√©part</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Pause</th>
                                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="correction-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>

            <!-- Add Employee Form -->
            <div class="p-6 bg-gray-50 rounded-lg border mb-8">
                <h3 class="text-xl font-medium mb-4 text-gray-700">Ajouter un Nouvel Employ√©</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input id="new-employee-name" type="text" placeholder="Nom de l'employ√©" class="p-3 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input id="new-employee-code" type="text" maxlength="4" placeholder="Code (4 chiffres)" class="p-3 border rounded-lg focus:ring-blue-500 focus:border-blue-500" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 4)">
                    <button onclick="addEmployee()" class="btn-primary bg-green-600 text-white font-medium py-3 rounded-lg hover:bg-green-700">Ajouter</button>
                </div>
                <p id="admin-message" class="mt-2 text-sm text-red-600 h-5"></p>
            </div>

            <!-- Employee List -->
            <h3 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">Liste des Employ√©s</h3>
            <div id="employee-list-container" class="overflow-x-auto mb-8">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Code</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th></tr></thead>
                    <tbody id="employee-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>

            <!-- PREVIEW EXCEL TABLE -->
            <div class="mt-10 mb-10">
                <h3 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Aper√ßu Tableau Comptable
                </h3>
                
                <div id="preview-records-container" class="overflow-x-auto max-h-[600px] border border-gray-300 rounded-lg shadow-inner bg-gray-50">
                    <table class="min-w-full border-collapse">
                        <thead class="sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th class="preview-header">Sem</th>
                                <th class="preview-header">Date</th>
                                <th class="preview-header">Arr M</th>
                                <th class="preview-header">Dep M</th>
                                <th class="preview-header">Pau M</th>
                                <th class="preview-header">Tot M</th>
                                <th class="preview-header">Arr S</th>
                                <th class="preview-header">Dep S</th>
                                <th class="preview-header">Pau S</th>
                                <th class="preview-header">Tot S</th>
                                <th class="preview-header">Total</th>
                            </tr>
                        </thead>
                        <tbody id="preview-table-body" class="bg-white">
                            <tr><td colspan="11" class="text-center py-8 text-gray-500 italic">Chargement des donn√©es...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="mt-4 flex justify-end">
                    <button onclick="resetAllPunches()" class="text-red-600 hover:text-red-800 text-sm font-medium flex items-center border border-red-200 bg-red-50 hover:bg-red-100 px-3 py-2 rounded shadow-sm transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>R√©initialiser tout l'historique</button>
                </div>
            </div>

            <!-- Admin Settings -->
            <div class="mt-12 p-6 bg-gray-100 rounded-lg border border-gray-200">
                <h3 class="text-xl font-semibold mb-4 text-gray-700 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>Param√®tres Administrateur</h3>
                <div class="flex items-center space-x-4">
                    <div class="flex-grow max-w-xs">
                        <label class="block text-xs font-bold text-gray-500 mb-1">Code d'acc√®s Admin</label>
                        <input id="setting-admin-code" type="text" maxlength="8" class="w-full p-2 border rounded shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: 1976">
                    </div>
                    <div class="mt-5">
                        <button onclick="saveNewAdminCode()" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 font-medium text-sm transition-colors">Enregistrer le nouveau code</button>
                    </div>
                </div>
                <p id="settings-message" class="mt-2 text-sm h-5"></p>
            </div>
        </div>
    </div>

    <!-- NEW: Modal for Manual Time Entry with SCROLL WHEEL -->
    <div id="manual-time-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all scale-100 flex flex-col h-auto max-h-screen overflow-y-auto">
            <h3 id="manual-time-title" class="text-xl font-bold mb-6 text-gray-800 text-center">Confirmation Horaire</h3>
            
            <div class="mb-4">
                <label class="block text-sm font-bold text-gray-600 mb-2">Date</label>
                <input type="date" id="manual-punch-date" class="w-full p-4 border-2 border-gray-200 rounded-lg text-center text-lg focus:border-blue-500 focus:ring-blue-500 outline-none transition-colors">
            </div>

            <!-- iOS STYLE SCROLL PICKER -->
            <div class="mb-6">
                <label class="block text-sm font-bold text-gray-600 mb-2">Heure</label>
                <div class="wheel-container">
                    <div class="wheel-highlight"></div>
                    <div class="flex justify-center h-full relative z-10">
                        <!-- Hour Wheel -->
                        <div class="w-20 wheel-column no-scrollbar" id="hour-wheel">
                            <!-- Populated by JS -->
                        </div>
                        <div class="flex items-center justify-center font-bold text-2xl text-gray-400 mx-2 z-10 pt-[2px]">:</div>
                        <!-- Minute Wheel -->
                        <div class="w-20 wheel-column no-scrollbar" id="minute-wheel">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
                <button onclick="setManualToNow()" class="w-full py-3 mt-2 text-xs font-bold text-blue-500 uppercase tracking-wide hover:bg-blue-50 rounded transition-colors">Remettre √† maintenant</button>
            </div>
            
            <!-- REMOVED BREAK INPUT FROM HERE, MOVED TO RED MODAL -->

            <div class="flex space-x-3 mt-2">
                <button onclick="closeManualTimeModal()" class="flex-1 py-4 border border-gray-300 rounded-lg text-gray-600 font-medium hover:bg-gray-50 transition-colors">Annuler</button>
                <button onclick="confirmManualPunch()" class="flex-1 py-4 bg-blue-600 text-white rounded-lg font-bold shadow-md hover:bg-blue-700 transition-colors">Valider</button>
            </div>
        </div>
    </div>
    
    <!-- NEW: REDESIGNED BREAK SELECTION MODAL (Cleaner White) -->
    <div id="break-selection-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full transform transition-all scale-100 flex flex-col animate-bounce-in">
            <h3 class="text-xl font-bold mb-2 text-center text-gray-800">Temps de Pause ?</h3>
            <p class="text-center text-gray-500 mb-6 text-sm">Entrez la dur√©e de votre pause en minutes</p>
            
            <div class="flex items-center justify-center mb-8 select-none">
                <button onclick="adjustBreakRed(-5)" class="p-4 bg-gray-100 rounded-l-lg hover:bg-gray-200 border border-gray-200 font-bold text-gray-600 w-16 text-xl transition-colors">-</button>
                <input type="number" id="red-punch-break" value="0" min="0" class="w-24 p-4 bg-white text-gray-800 border-y border-gray-200 text-center text-3xl font-bold focus:outline-none focus:border-blue-500">
                <button onclick="adjustBreakRed(5)" class="p-4 bg-gray-100 rounded-r-lg hover:bg-gray-200 border border-gray-200 font-bold text-gray-600 w-16 text-xl transition-colors">+</button>
            </div>

            <div class="flex space-x-3">
                <button onclick="document.getElementById('break-selection-modal').classList.add('hidden'); document.getElementById('break-selection-modal').classList.remove('flex');" class="flex-1 py-4 border border-gray-300 rounded-lg text-gray-600 font-medium hover:bg-gray-50 transition-colors">Retour</button>
                <button onclick="confirmBreak()" class="flex-1 py-4 bg-blue-600 text-white rounded-lg font-bold shadow-lg hover:bg-blue-700 transition-colors">Valider</button>
            </div>
        </div>
    </div>

    <!-- NEW: Punch Success Modal -->
    <div id="punch-success-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 backdrop-blur-md">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center relative overflow-hidden transform transition-all scale-105">
            <div class="mx-auto flex items-center justify-center h-20 w-20 rounded-full bg-green-100 mb-6">
                <svg class="h-10 w-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-2">Succ√®s !</h3>
            <p id="punch-success-message" class="text-lg text-gray-600 font-medium mb-6">Message de confirmation</p>
            
            <button onclick="undoLastPunch()" class="w-full py-3 mb-4 bg-red-50 text-red-600 border border-red-100 rounded-lg font-bold text-sm hover:bg-red-100 flex items-center justify-center transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
                Oups, je me suis tromp√© (Annuler)
            </button>

            <div class="w-full bg-gray-200 rounded-full h-1.5 mb-1"><div id="punch-progress-bar" class="bg-green-600 h-1.5 rounded-full" style="width: 100%"></div></div>
            <p class="text-xs text-gray-400">Fermeture automatique...</p>
        </div>
    </div>

    <!-- Modals (Admin Login, Manual Correction) remain the same... -->
    <!-- (Included in previous files, kept for functionality but collapsed here) -->
    <div id="manual-correction-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 backdrop-blur-sm"><div class="bg-white p-6 rounded-2xl shadow-2xl max-w-md w-full"><h3 class="text-xl font-bold mb-4 text-gray-800" id="correction-modal-title">Modifier / Ajouter</h3><input type="hidden" id="edit-punch-id"><div class="space-y-4"><div><label class="block text-sm font-medium text-gray-700">Employ√©</label><select id="edit-punch-employee" class="mt-1 block w-full p-2 border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-50"></select></div><div><label class="block text-sm font-medium text-gray-700">Date</label><input type="date" id="edit-punch-date" class="mt-1 block w-full p-2 border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-700">Heure Arriv√©e</label><input type="time" id="edit-punch-in" class="mt-1 block w-full p-2 border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></div><div><label class="block text-sm font-medium text-gray-700">Heure D√©part</label><input type="time" id="edit-punch-out" class="mt-1 block w-full p-2 border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></div></div><div><label class="block text-sm font-medium text-gray-700">Pause (minutes)</label><input type="number" id="edit-punch-break" min="0" class="mt-1 block w-full p-2 border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></div></div><div class="mt-6 flex justify-end space-x-3"><button onclick="document.getElementById('manual-correction-modal').classList.add('hidden')" class="px-4 py-2 text-sm font-medium text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200">Annuler</button><button onclick="saveManualPunch()" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">Enregistrer</button></div></div></div>
    <div id="admin-login-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 backdrop-blur-sm"><div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full transform transition-all scale-100 flex flex-col h-auto max-h-screen overflow-y-auto" id="admin-modal-content"><div class="text-center mb-4"><div class="mx-auto bg-gray-100 w-12 h-12 rounded-full flex items-center justify-center mb-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg></div><h3 class="text-xl font-bold text-gray-800">Acc√®s Admin</h3></div><input id="admin-login-input" type="password" maxlength="8" readonly class="w-full p-3 border-2 border-gray-300 rounded-lg text-2xl text-center focus:border-blue-500 focus:outline-none mb-4 tracking-widest bg-white" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"><div class="numpad-grid select-none mb-4"><div onclick="typeNum('admin-login-input', '1')" class="numpad-btn">1</div><div onclick="typeNum('admin-login-input', '2')" class="numpad-btn">2</div><div onclick="typeNum('admin-login-input', '3')" class="numpad-btn">3</div><div onclick="typeNum('admin-login-input', '4')" class="numpad-btn">4</div><div onclick="typeNum('admin-login-input', '5')" class="numpad-btn">5</div><div onclick="typeNum('admin-login-input', '6')" class="numpad-btn">6</div><div onclick="typeNum('admin-login-input', '7')" class="numpad-btn">7</div><div onclick="typeNum('admin-login-input', '8')" class="numpad-btn">8</div><div onclick="typeNum('admin-login-input', '9')" class="numpad-btn">9</div><div onclick="clearNum('admin-login-input')" class="numpad-btn clear-btn">C</div><div onclick="typeNum('admin-login-input', '0')" class="numpad-btn">0</div><div onclick="verifyAdminCode()" class="numpad-btn action-btn">OK</div></div><button onclick="closeAdminModal()" class="w-full text-gray-500 font-medium py-2 hover:text-gray-700 border rounded-lg">Annuler</button><p id="admin-login-error" class="text-center mt-2 text-sm font-medium text-red-500 h-5"></p></div></div>
    
    <div id="toast-notification">Notification</div>

    <script type="module">
        // ... (Imports and Config remain the same) ...
        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, addDoc, setDoc, updateDoc, onSnapshot, collection, query, where, limit, getDocs, deleteDoc, orderBy, serverTimestamp, getDoc, Timestamp } = window.firebase;

        let config = {};
        try { config = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}'); } catch(e) {}
        if (Object.keys(config).length === 0) { config = { apiKey: "AIzaSyAxG6D6yQWSUR3K2JORaXajA5QaCDp376A", authDomain: "pointage-5b928.firebaseapp.com", projectId: "pointage-5b928", storageBucket: "pointage-5b928.firebasestorage.app", messagingSenderId: "604304798014", appId: "1:604304798014:web:ac29f9638934bfdedbbc6f" }; }
        const firebaseConfig = config;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'pointage-app';

        let app, db, auth, userId = null;
        let employees = []; 
        let punches = []; 
        let isAuthReady = false;
        let currentAdminCode = "1976"; 
        let currentEmployee = null; // Store currently logged in employee for the dashboard
        let lastCreatedPunchId = null; // Store ID for "Undo" feature
        
        const getColRef = (colName) => collection(db, 'artifacts', appId, 'public', 'data', colName);
        const getDocRef = (colName, docId) => doc(db, 'artifacts', appId, 'public', 'data', colName, docId);

        const formatter = new Intl.DateTimeFormat('fr-FR', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit', second: '2-digit',
            hour12: false
        });

        // Helper pour avoir la date format YYYY-MM-DD locale (pour les input date)
        function getLocalDateInputValue(d) {
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        window.showToast = (message) => {
            const toast = document.getElementById("toast-notification");
            toast.textContent = message;
            toast.className = "show";
            setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
        }
        window.typeNum = (inputId, num) => {
            const input = document.getElementById(inputId);
            if (input) {
                if (input.value.length < input.maxLength) {
                    input.value += num;
                    input.dispatchEvent(new Event('input'));
                }
            }
        };
        window.clearNum = (inputId) => { const input = document.getElementById(inputId); if(input) input.value = ''; };

        function formatDuration(ms) {
            if (ms === undefined || ms === null) return 'N/A';
            const sign = ms < 0 ? "-" : "";
            const absMs = Math.abs(ms);
            const totalSeconds = Math.floor(absMs / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return sign + [hours, minutes, seconds].map(val => String(val).padStart(2, '0')).join(':');
        }

        window.showSuccessModal = (message, punchId) => {
            const modal = document.getElementById('punch-success-modal');
            const msgEl = document.getElementById('punch-success-message');
            const bar = document.getElementById('punch-progress-bar');
            msgEl.textContent = message;
            lastCreatedPunchId = punchId; // Store for Undo
            
            bar.classList.remove('progress-bar');
            void bar.offsetWidth; 
            bar.classList.add('progress-bar');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Auto close timer
            if (window.successModalTimer) clearTimeout(window.successModalTimer);
            window.successModalTimer = setTimeout(() => { 
                modal.classList.add('hidden'); 
                modal.classList.remove('flex'); 
            }, 5000);
        }
        
        // FIXED: Undo Function Logic
        window.undoLastPunch = async () => {
            if (!lastCreatedPunchId) {
                console.error("No last punch ID to undo");
                return;
            }
            if (!confirm("Voulez-vous vraiment annuler ce pointage ?")) return;
            
            try {
                const docRef = getDocRef('punches', lastCreatedPunchId);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Logic to distinguish between undoing an IN or OUT punch
                    // If punchOutTime exists, it means we just clocked OUT. We should clear it to stay clocked IN.
                    if (data.punchOutTime) {
                        await updateDoc(docRef, { punchOutTime: null, breakDuration: 0 });
                        showToast("D√©pointage annul√©. Vous √™tes toujours point√©.");
                    } else {
                        // If only punchInTime exists, we just clocked IN. Delete the whole record.
                        await deleteDoc(docRef);
                        showToast("Pointage annul√©.");
                    }
                } else {
                    showToast("Erreur: Pointage introuvable.");
                }
                
                // Force Close modal immediately
                if (window.successModalTimer) clearTimeout(window.successModalTimer);
                document.getElementById('punch-success-modal').classList.add('hidden');
                document.getElementById('punch-success-modal').classList.remove('flex');
                
                // If user is still "logged in", refresh dashboard state
                if (currentEmployee) {
                    verifyCodeAndShowMenu(); 
                } else {
                    resetToCodeEntry();
                }
                
            } catch (e) {
                console.error("Undo error", e);
                alert("Erreur lors de l'annulation: " + e.message);
            }
        };

        // --- INIT ---
        window.onload = async () => {
            // Populate Scroll Wheels
            populateWheels();

            try {
                if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                      document.getElementById('connection-status').textContent = "‚ö†Ô∏è CONFIGURATION MANQUANTE";
                      return;
                }
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                document.getElementById('connection-status').textContent = "Connexion...";
                document.getElementById('connection-status').className = "font-bold text-blue-500";

                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                };
                await initAuth();

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        document.getElementById('connection-status').textContent = "Connect√© (Cloud Public)";
                        document.getElementById('connection-status').className = "font-bold text-green-600";
                        startDataListeners();
                        fetchAdminCode(); 
                    } else {
                         document.getElementById('connection-status').textContent = "D√©connect√©";
                    }
                });
                
                document.getElementById('admin-correction-date').valueAsDate = new Date();
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                document.getElementById('admin-month-picker').value = `${yyyy}-${mm}`;

            } catch (error) {
                console.error("Erreur Firebase:", error);
                document.getElementById('connection-status').textContent = "Erreur de Connexion";
                handleFirebaseError(error);
            }
        };

        // ... (Logo functions remain the same) ...
        function resizeAndCompressImage(file, maxWidth, quality, callback) {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function(event) {
                const img = new Image();
                img.src = event.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    if (width > maxWidth) {
                        height = Math.round((height * maxWidth) / width);
                        width = maxWidth;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    // Use PNG to preserve transparency
                    const dataUrl = canvas.toDataURL('image/png');
                    callback(dataUrl);
                };
            };
        }

        window.handleLogoUpload = (input) => {
            const file = input.files[0];
            if (!file) return;
            document.getElementById('logo-loading').classList.remove('hidden');
            resizeAndCompressImage(file, 400, 0.7, async (compressedBase64) => {
                 try {
                    await setDoc(getDocRef('settings', 'branding'), { logoBase64: compressedBase64, updatedAt: serverTimestamp() });
                    showToast("Nouveau logo partag√© enregistr√© !");
                } catch(e) { console.error("Erreur logo:", e); alert("Erreur: " + e.message); } 
                finally { document.getElementById('logo-loading').classList.add('hidden'); }
            });
        };

        async function fetchAdminCode() {
            try {
                const docRef = getDocRef('settings', 'admin_config');
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) currentAdminCode = docSnap.data().code;
                else await setDoc(docRef, { code: "1976" });
                document.getElementById('setting-admin-code').value = currentAdminCode;
            } catch (e) { console.log("Utilisation du code d√©faut.", e); }
        }

        function updateAppIcons(base64Image) {
            if (!base64Image) return;
            const linkIcon = document.getElementById('dynamic-favicon');
            if (linkIcon) linkIcon.href = base64Image;
            const linkApple = document.getElementById('dynamic-apple-icon');
            if (linkApple) linkApple.href = base64Image;
            
            const manifest = { 
                "name": "Pointage", 
                "short_name": "Pointage", 
                "start_url": window.location.href, // Dynamic URL
                "display": "standalone", 
                "background_color": "#ffffff", 
                "theme_color": "#2563eb", 
                "icons": [ 
                    { "src": base64Image, "sizes": "192x192", "type": "image/png" }, 
                    { "src": base64Image, "sizes": "512x512", "type": "image/png" } 
                ] 
            };
            
            // Encode manifest in Data URI to bypass Blob restrictions on some browsers
            const stringManifest = JSON.stringify(manifest);
            const manifestDataUri = 'data:application/manifest+json;charset=utf-8,' + encodeURIComponent(stringManifest);
            
            const linkManifest = document.getElementById('dynamic-manifest');
            if (linkManifest) linkManifest.setAttribute('href', manifestDataUri);
        }

        function startDataListeners() {
            if (!isAuthReady) return;
            
            // LISTEN TO LOGO UPDATES
            onSnapshot(getDocRef('settings', 'branding'), (doc) => {
                if(doc.exists() && doc.data().logoBase64) {
                    const logoImg = document.getElementById('app-logo');
                    const fallback = document.getElementById('fallback-logo-icon');
                    logoImg.src = doc.data().logoBase64;
                    
                    // FORCE VISIBILITY: In case previous error hid it
                    logoImg.style.display = 'block'; 
                    logoImg.classList.remove('hidden');
                    
                    fallback.classList.add('hidden');
                    updateAppIcons(doc.data().logoBase64);
                }
            });

            onSnapshot(getColRef('employees'), (snapshot) => {
                employees = [];
                const empSelect = document.getElementById('admin-correction-employee');
                const editEmpSelect = document.getElementById('edit-punch-employee');
                const currentVal = empSelect.value;
                const currentEditVal = editEmpSelect.value;
                empSelect.innerHTML = '<option value="">-- Tous les employ√©s --</option>';
                editEmpSelect.innerHTML = '';
                snapshot.forEach(doc => {
                    const data = { id: doc.id, ...doc.data() };
                    employees.push(data);
                    const opt = document.createElement('option'); opt.value = data.code; opt.textContent = data.name; empSelect.appendChild(opt);
                    const opt2 = document.createElement('option'); opt2.value = data.code; opt2.textContent = data.name; editEmpSelect.appendChild(opt2);
                });
                if(currentVal) empSelect.value = currentVal;
                if(currentEditVal) editEmpSelect.value = currentEditVal;
                renderEmployeeTable();
                loadCorrectionData();
                renderMonthPreview(); // Update preview when employees change
            }, (error) => handleFirebaseError(error));

            const q = query(getColRef('punches'), orderBy('punchInTime', 'desc'));
            onSnapshot(q, (snapshot) => {
                punches = [];
                snapshot.forEach(doc => { punches.push({ id: doc.id, ...doc.data() }); });
                // We no longer render simple punch table, we render preview table
                loadCorrectionData();
                renderMonthPreview(); // Update preview when punches change
            }, (error) => handleFirebaseError(error));
        }

        function handleFirebaseError(error) { console.error("Erreur d√©tect√©e:", error); }

        // --- EXCEL EXPORT & PREVIEW LOGIC ---
        const getWeekNumber = (d) => { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7)); var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1)); return Math.ceil((((d - yearStart) / 86400000) + 1)/7); };
        
        // NEW: Shared function to generate table HTML for a list of employees
        // Used by Admin Preview AND Employee Preview
        function renderTableHTML(targetBodyId, employeeList, year, month) {
            const tbody = document.getElementById(targetBodyId);
            tbody.innerHTML = '';

            if (employeeList.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="11" class="text-center py-8 text-gray-500 italic">Aucune donn√©e √† afficher.</td></tr>';
                 return;
            }

            const daysInMonth = new Date(year, month, 0).getDate();

            employeeList.forEach(emp => {
                // Header for Employee (Only if admin view, or if we want to show name)
                if(targetBodyId === 'preview-table-body') {
                     const empHeaderRow = document.createElement('tr');
                     empHeaderRow.innerHTML = `<td colspan="11" class="bg-gray-100 font-bold text-gray-800 p-2 text-left border-b border-t border-gray-300 pl-4 mt-4">${emp.name} (${emp.code})</td>`;
                     tbody.appendChild(empHeaderRow);
                }

                let currentWeekNum = null; 
                let weeklyTotalMs = 0;

                const pushWeekSummary = (weekNum) => {
                     const totalStr = formatDuration(weeklyTotalMs);
                     const row = document.createElement('tr');
                     row.innerHTML = `<td class="preview-week-row">TOT SEM ${weekNum}</td><td colspan="8"></td><td class="preview-week-row">TOT HEBDO</td><td class="preview-week-row">${totalStr}</td>`;
                     tbody.appendChild(row);
                };

                for (let d = 1; d <= daysInMonth; d++) {
                    const dateObj = new Date(year, month - 1, d);
                    const weekNum = getWeekNumber(dateObj);
                    const dateStr = dateObj.toLocaleDateString('fr-FR', {weekday: 'short', day: '2-digit', month: '2-digit'});

                    if (currentWeekNum !== null && weekNum !== currentWeekNum) {
                        pushWeekSummary(currentWeekNum);
                        weeklyTotalMs = 0;
                    }
                    currentWeekNum = weekNum;

                    const dayKey = `${year}-${String(month).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    const dayPunches = punches.filter(p => { 
                        if (p.employeeCode !== emp.code || !p.punchInTime) return false;
                        const pDate = p.punchInTime.toDate();
                        
                        // LOGIC FOR NIGHT SHIFT GROUPING IN TABLE
                        // If hour < 3, count it as previous day for display
                        const displayDate = new Date(pDate);
                        if (displayDate.getHours() < 3) {
                            displayDate.setDate(displayDate.getDate() - 1);
                        }
                        
                        const pKey = `${displayDate.getFullYear()}-${String(displayDate.getMonth()+1).padStart(2,'0')}-${String(displayDate.getDate()).padStart(2,'0')}`;
                        return pKey === dayKey; 
                    });
                    
                    dayPunches.sort((a,b) => a.punchInTime.toMillis() - b.punchInTime.toMillis());

                    let arrM = "", depM = "", pauseM = "", totM = "", arrS = "", depS = "", pauseS = "", totS = "", totalDailyStr = "00:00:00"; 
                    let duration1 = 0, duration2 = 0;

                    if (dayPunches.length > 0) {
                        const p1 = dayPunches[0]; 
                        const p1In = p1.punchInTime.toDate(); 
                        const p1Out = p1.punchOutTime ? p1.punchOutTime.toDate() : null; 
                        const p1Break = p1.breakDuration || 0;
                        arrM = p1In.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); 
                        depM = p1Out ? p1Out.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '<span class="text-red-500 text-xs">...</span>'; 
                        pauseM = p1Break > 0 ? p1Break : "";
                        if(p1Out) { duration1 = Math.max(0, (p1Out.getTime() - p1In.getTime()) - (p1Break * 60000)); totM = formatDuration(duration1); }

                        if (dayPunches.length > 1) {
                            const p2 = dayPunches[1]; 
                            const p2In = p2.punchInTime.toDate(); 
                            const p2Out = p2.punchOutTime ? p2.punchOutTime.toDate() : null; 
                            const p2Break = p2.breakDuration || 0;
                            arrS = p2In.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); 
                            depS = p2Out ? p2Out.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '<span class="text-red-500 text-xs">...</span>'; 
                            pauseS = p2Break > 0 ? p2Break : "";
                            if(p2Out) { duration2 = Math.max(0, (p2Out.getTime() - p2In.getTime()) - (p2Break * 60000)); totS = formatDuration(duration2); }
                        }
                        totalDailyStr = formatDuration(duration1 + duration2); 
                        weeklyTotalMs += (duration1 + duration2);
                    }

                    const tr = document.createElement('tr');
                    tr.className = d % 2 === 0 ? "bg-gray-50 hover:bg-yellow-50" : "bg-white hover:bg-yellow-50";
                    tr.innerHTML = `
                        <td class="preview-cell">${weekNum}</td>
                        <td class="preview-cell font-medium">${dateStr}</td>
                        <td class="preview-cell">${arrM}</td>
                        <td class="preview-cell">${depM}</td>
                        <td class="preview-cell text-xs text-gray-400">${pauseM}</td>
                        <td class="preview-cell font-bold">${totM}</td>
                        <td class="preview-cell">${arrS}</td>
                        <td class="preview-cell">${depS}</td>
                        <td class="preview-cell text-xs text-gray-400">${pauseS}</td>
                        <td class="preview-cell font-bold">${totS}</td>
                        <td class="preview-cell font-bold text-blue-800">${totalDailyStr !== "00:00:00" ? totalDailyStr : ""}</td>
                    `;
                    tbody.appendChild(tr);
                }
                if (currentWeekNum !== null) { pushWeekSummary(currentWeekNum); }
             });
        }

        window.exportToExcel = () => {
            const monthPicker = document.getElementById('admin-month-picker');
            const selectedMonthVal = monthPicker.value;
            if (!selectedMonthVal) { alert("Veuillez s√©lectionner un mois."); return; }
            if (employees.length === 0 && punches.length === 0) { alert('Aucune donn√©e.'); return; }
            const [selYear, selMonth] = selectedMonthVal.split('-').map(Number);
            const daysInMonth = new Date(selYear, selMonth, 0).getDate();
            const wb = XLSX.utils.book_new();
            const headerStyle = { font: { bold: true, color: { rgb: "000000" } }, fill: { fgColor: { rgb: "FFC000" } }, alignment: { horizontal: "center" }, border: { top: {style:'thin'}, bottom: {style:'thin'}, left: {style:'thin'}, right: {style:'thin'} } };
            const cellStyle = { alignment: { horizontal: "center" }, border: { top: {style:'thin'}, bottom: {style:'thin'}, left: {style:'thin'}, right: {style:'thin'} } };
            const totalRowStyle = { font: { bold: true }, fill: { fgColor: { rgb: "FFF2CC" } }, alignment: { horizontal: "center" }, border: { top: {style:'thin'}, bottom: {style:'thin'}, left: {style:'thin'}, right: {style:'thin'} } };
            const weekSummaryStyle = { font: { bold: true, color: { rgb: "FF0000" } }, fill: { fgColor: { rgb: "FFFF00" } }, alignment: { horizontal: "center" }, border: { top: {style:'medium'}, bottom: {style:'medium'}, left: {style:'medium'}, right: {style:'medium'} } };
            
            employees.forEach(emp => {
                const rows = [];
                rows.push([{v: 'N¬∞ Semaine', s: headerStyle},{v: 'Date', s: headerStyle},{v: 'Arriv√©e M', s: headerStyle},{v: 'D√©part M', s: headerStyle},{v: 'Pause M', s: headerStyle},{v: 'Total M', s: headerStyle},{v: 'Arriv√©e S', s: headerStyle},{v: 'D√©part S', s: headerStyle},{v: 'Pause S', s: headerStyle},{v: 'Total S', s: headerStyle},{v: 'Total Jour', s: headerStyle}]);
                let currentWeekNum = null; let weeklyTotalMs = 0;
                
                const pushWeekSummary = (weekNum) => {
                     const totalHours = weeklyTotalMs / (1000 * 60 * 60); let h_norm = 0, h_10 = 0, h_20 = 0, h_50 = 0; let remainder = totalHours;
                     if (remainder <= 35) { h_norm = remainder; remainder = 0; } else { h_norm = 35; remainder -= 35; }
                     if (remainder > 0) { const chunk = Math.min(remainder, 4); h_10 = chunk; remainder -= chunk; }
                     if (remainder > 0) { const chunk = Math.min(remainder, 4); h_20 = chunk; remainder -= chunk; }
                     if (remainder > 0) { h_50 = remainder; }
                     const totalStr = formatDuration(weeklyTotalMs);
                     rows.push([{v: `TOTAL SEMAINE ${weekNum}`, s: weekSummaryStyle},{v: '', s: weekSummaryStyle},{v: '', s: weekSummaryStyle},{v: '', s: weekSummaryStyle},{v: '', s: weekSummaryStyle},{v: '', s: weekSummaryStyle},{v: '', s: weekSummaryStyle},{v: '', s: weekSummaryStyle},{v: '', s: weekSummaryStyle},{v: 'TOTAL HEBDO:', s: weekSummaryStyle},{v: totalStr, s: weekSummaryStyle}]);
                     rows.push([{v: 'D√©tail HS (HCR):', s: totalRowStyle},{v: `Normales: ${Number(h_norm.toFixed(2))}h`, s: totalRowStyle},{v: `HS 10%: ${Number(h_10.toFixed(2))}h`, s: totalRowStyle},{v: '', s: totalRowStyle},{v: `HS 20%: ${Number(h_20.toFixed(2))}h`, s: totalRowStyle},{v: '', s: totalRowStyle},{v: `HS 50%: ${Number(h_50.toFixed(2))}h`, s: totalRowStyle},{v: '', s: totalRowStyle},{v: '', s: totalRowStyle},{v: '', s: totalRowStyle},{v: '', s: totalRowStyle}]);
                     rows.push([null]); 
                };
                
                for (let d = 1; d <= daysInMonth; d++) {
                    const dateObj = new Date(selYear, selMonth - 1, d); const weekNum = getWeekNumber(dateObj); const dateStr = dateObj.toLocaleDateString('fr-FR', {weekday: 'short', day: '2-digit', month: '2-digit'});
                    if (currentWeekNum !== null && weekNum !== currentWeekNum) { pushWeekSummary(currentWeekNum); weeklyTotalMs = 0; }
                    currentWeekNum = weekNum;
                    
                    const dayKey = `${selYear}-${String(selMonth).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    const dayPunches = punches.filter(p => { 
                        if (p.employeeCode !== emp.code || !p.punchInTime) return false;
                        const pDate = p.punchInTime.toDate(); 
                        
                        // LOGIC FOR NIGHT SHIFT GROUPING IN EXCEL
                        const displayDate = new Date(pDate);
                        if (displayDate.getHours() < 3) {
                             displayDate.setDate(displayDate.getDate() - 1);
                        }
                        
                        const pKey = `${displayDate.getFullYear()}-${String(displayDate.getMonth()+1).padStart(2,'0')}-${String(displayDate.getDate()).padStart(2,'0')}`; 
                        return pKey === dayKey; 
                    });
                    dayPunches.sort((a,b) => a.punchInTime.toMillis() - b.punchInTime.toMillis());
                    
                    let arrM = "", depM = "", pauseM = "", totM = "", arrS = "", depS = "", pauseS = "", totS = "", totalDailyStr = "00:00:00"; let duration1 = 0, duration2 = 0;
                    if (dayPunches.length > 0) {
                        const p1 = dayPunches[0]; const p1In = p1.punchInTime.toDate(); const p1Out = p1.punchOutTime ? p1.punchOutTime.toDate() : null; const p1Break = p1.breakDuration || 0;
                        arrM = p1In.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); depM = p1Out ? p1Out.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : "En cours"; pauseM = p1Break > 0 ? p1Break : "";
                        if(p1Out) { duration1 = Math.max(0, (p1Out.getTime() - p1In.getTime()) - (p1Break * 60000)); totM = formatDuration(duration1); }
                        
                        if (dayPunches.length > 1) {
                            const p2 = dayPunches[1]; const p2In = p2.punchInTime.toDate(); const p2Out = p2.punchOutTime ? p2.punchOutTime.toDate() : null; const p2Break = p2.breakDuration || 0;
                            arrS = p2In.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); 
                            depS = p2Out ? p2Out.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : "En cours"; 
                            pauseS = p2Break > 0 ? p2Break : "";
                            if(p2Out) { duration2 = Math.max(0, (p2Out.getTime() - p2In.getTime()) - (p2Break * 60000)); totS = formatDuration(duration2); }
                        }
                        totalDailyStr = formatDuration(duration1 + duration2); weeklyTotalMs += (duration1 + duration2);
                    }
                    rows.push([{v: weekNum, s: cellStyle},{v: dateStr, s: cellStyle},{v: arrM, s: cellStyle},{v: depM, s: cellStyle},{v: pauseM, s: cellStyle},{v: totM, s: { ...cellStyle, font: {bold: true} }},{v: arrS, s: cellStyle},{v: depS, s: cellStyle},{v: pauseS, s: cellStyle},{v: totS, s: { ...cellStyle, font: {bold: true} }},{v: totalDailyStr, s: { ...cellStyle, font: {bold: true} }}]);
                }
                if (currentWeekNum !== null) { pushWeekSummary(currentWeekNum); }
                const ws = XLSX.utils.aoa_to_sheet(rows); ws['!cols'] = [{wch:12}, {wch:22}, {wch:13}, {wch:13}, {wch:10}, {wch:13}, {wch:13}, {wch:13}, {wch:10}, {wch:13}, {wch:15}]; XLSX.utils.book_append_sheet(wb, ws, emp.name.replace(/[*?\/\[\]]/g, '').slice(0, 25));
            });
            XLSX.writeFile(wb, `Pointage_HCR_${selectedMonthVal}.xlsx`);
        };

        // --- PREVIEW RENDER FUNCTION (ADMIN) ---
        window.renderMonthPreview = () => {
             const monthPicker = document.getElementById('admin-month-picker');
             const selectedMonthVal = monthPicker.value;

             if (!selectedMonthVal) return;
             const [selYear, selMonth] = selectedMonthVal.split('-').map(Number);
             
             // Use generic function for Admin preview (all employees)
             renderTableHTML('preview-table-body', employees, selYear, selMonth);
        };

        // --- GENERAL LOGIC ---
        window.loadCorrectionData = () => {
            const empCode = document.getElementById('admin-correction-employee').value; const dateVal = document.getElementById('admin-correction-date').value; const tbody = document.getElementById('correction-table-body'); tbody.innerHTML = '';
            if (!dateVal) return; const targetDateStr = new Date(dateVal).toDateString();
            const filteredPunches = punches.filter(p => { if (!p.punchInTime) return false; const pDate = p.punchInTime.toDate(); return pDate.toDateString() === targetDateStr && (empCode ? p.employeeCode === empCode : true); });
            if (filteredPunches.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-2 text-sm text-gray-500 text-center italic">Aucun pointage ce jour.</td></tr>'; return; }
            filteredPunches.forEach(p => { const tr = document.createElement('tr'); const pi = p.punchInTime.toDate(); const po = p.punchOutTime ? p.punchOutTime.toDate() : null; tr.innerHTML = `<td class="px-4 py-2 text-sm text-gray-900">${p.employeeName}</td><td class="px-4 py-2 text-sm text-gray-500">${pi.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</td><td class="px-4 py-2 text-sm text-gray-500">${po?po.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}):'<span class="text-red-500">En cours</span>'}</td><td class="px-4 py-2 text-sm text-gray-500">${p.breakDuration||0} min</td><td class="px-4 py-2 text-right text-sm font-medium"><button onclick="openManualPunchModal('${p.id}')" class="text-indigo-600 hover:text-indigo-900 mr-2">Modifier</button><button onclick="deletePunch('${p.id}')" class="text-red-600 hover:text-red-900">Supprimer</button></td>`; tbody.appendChild(tr); });
        };

        window.deletePunch = async (id) => { if(!id) return; if(confirm("Supprimer ?")) try{ await deleteDoc(getDocRef('punches', id)); showToast("Supprim√© !"); }catch(e){console.error(e);} };
        window.openManualPunchModal = (punchId) => {
            const modal = document.getElementById('manual-correction-modal'); const title = document.getElementById('correction-modal-title'); const empSelect = document.getElementById('edit-punch-employee'); const dateInput = document.getElementById('edit-punch-date'); const inInput = document.getElementById('edit-punch-in'); const outInput = document.getElementById('edit-punch-out'); const breakInput = document.getElementById('edit-punch-break'); const idInput = document.getElementById('edit-punch-id');
            let punchData = punchId ? punches.find(p => p.id === punchId) : null;
            if (punchData) { title.textContent = "Modifier le pointage"; idInput.value = punchData.id; empSelect.value = punchData.employeeCode; empSelect.disabled = true; const pi = new Date(punchData.punchInTime.seconds * 1000); dateInput.value = getLocalDateInputValue(pi); inInput.value = pi.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false}); if (punchData.punchOutTime) { const po = new Date(punchData.punchOutTime.seconds * 1000); outInput.value = po.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false}); } else outInput.value = ''; breakInput.value = punchData.breakDuration || 0; } 
            else { title.textContent = "Ajouter un pointage manuel"; idInput.value = ""; empSelect.disabled = false; empSelect.value = document.getElementById('admin-correction-employee').value || (employees.length > 0 ? employees[0].code : ""); dateInput.value = document.getElementById('admin-correction-date').value || getLocalDateInputValue(new Date()); inInput.value = "09:00"; outInput.value = "17:00"; breakInput.value = 0; }
            modal.classList.remove('hidden'); modal.classList.add('flex');
        };
        window.saveManualPunch = async () => {
            const id = document.getElementById('edit-punch-id').value; const empCode = document.getElementById('edit-punch-employee').value; const dateStr = document.getElementById('edit-punch-date').value; const inStr = document.getElementById('edit-punch-in').value; const outStr = document.getElementById('edit-punch-out').value; const breakVal = parseInt(document.getElementById('edit-punch-break').value) || 0;
            if (!empCode || !dateStr || !inStr) { alert("Champs requis manquants."); return; }
            const empObj = employees.find(e => e.code === empCode); 
            
            // FIX: Manual Date Construction to avoid UTC offset
            const [y, mo, d] = dateStr.split('-').map(Number);
            const [h, mi] = inStr.split(':').map(Number);
            const punchInDate = new Date(y, mo - 1, d, h, mi);
            
            let punchOutDate = null;
            if (outStr) {
                const [hOut, mOut] = outStr.split(':').map(Number);
                punchOutDate = new Date(y, mo - 1, d, hOut, mOut);
                if (punchOutDate < punchInDate) punchOutDate.setDate(punchOutDate.getDate() + 1);
            }

            const data = { employeeCode: empCode, employeeName: empObj.name, punchInTime: Timestamp.fromDate(punchInDate), punchOutTime: punchOutDate ? Timestamp.fromDate(punchOutDate) : null, breakDuration: breakVal };
            try { if (id) await updateDoc(getDocRef('punches', id), data); else await addDoc(getColRef('punches'), data); showToast("Enregistr√© !"); document.getElementById('manual-correction-modal').classList.add('hidden'); document.getElementById('manual-correction-modal').classList.remove('flex'); } catch (e) { alert("Erreur: " + e.message); }
        };

        window.requestAdminAccess = () => { document.getElementById('admin-login-modal').classList.remove('hidden'); document.getElementById('admin-login-modal').classList.add('flex'); document.getElementById('admin-login-input').value=''; };
        window.closeAdminModal = () => { document.getElementById('admin-login-modal').classList.add('hidden'); document.getElementById('admin-login-modal').classList.remove('flex'); };
        window.verifyAdminCode = () => { if(document.getElementById('admin-login-input').value === currentAdminCode) { closeAdminModal(); showView('admin'); loadCorrectionData(); } else { document.getElementById('admin-login-error').textContent="Erreur!"; }};
        window.saveNewAdminCode = async () => { try { await setDoc(getDocRef('settings', 'admin_config'), {code: document.getElementById('setting-admin-code').value}); currentAdminCode=document.getElementById('setting-admin-code').value; document.getElementById('settings-message').textContent="OK"; } catch(e){} };
        window.resetAllPunches = async () => { if (!confirm("SUPPRIMER TOUT L'HISTORIQUE ?")) return; const c = prompt("Code Admin:"); if (c !== currentAdminCode) return alert("Code faux"); try { const s = await getDocs(query(getColRef('punches'))); await Promise.all(s.docs.map(d=>deleteDoc(d.ref))); showToast("Reset OK"); } catch(e){ alert(e.message); } };

        const views = { punch: document.getElementById('view-punch'), admin: document.getElementById('view-admin') };
        const tabs = { punch: document.getElementById('tab-punch'), admin: document.getElementById('tab-admin') };
        window.showView = (name) => { Object.keys(views).forEach(k => { views[k].classList.toggle('hidden', k!==name); const t = tabs[k]; const a = t.getAttribute('data-active-class').split(' '); const i = t.getAttribute('data-inactive-class').split(' '); t.classList.remove(...(k===name?i:a)); t.classList.add(...(k===name?a:i)); }); };
        showView('punch');

        let currentPunchMode = null; let currentManualEmployee = null; let currentManualPunchDoc = null;
        let selectedHour = "00"; let selectedMinute = "00";
        // TEMP Storage for Date/Time before Break selection
        let tempPunchDate = null;

        // --- NEW: SCROLL WHEEL LOGIC ---
        function populateWheels() {
            const hWheel = document.getElementById('hour-wheel');
            const mWheel = document.getElementById('minute-wheel');
            
            // REMOVED EXTRA PADDING DIVS HERE
            // Padding items are handled by CSS padding-top/bottom 60px on the container
            
            let hHTML = ''; 
            for(let i=0; i<24; i++) {
                hHTML += `<div class="wheel-item" data-val="${String(i).padStart(2,'0')}">${String(i).padStart(2,'0')}</div>`;
            }
            
            let mHTML = '';
            for(let i=0; i<60; i++) {
                mHTML += `<div class="wheel-item" data-val="${String(i).padStart(2,'0')}">${String(i).padStart(2,'0')}</div>`;
            }
            
            hWheel.innerHTML = hHTML;
            mWheel.innerHTML = mHTML;
            
            // Add Scroll Listeners to update state
            hWheel.addEventListener('scroll', () => handleScroll(hWheel, 'h'));
            mWheel.addEventListener('scroll', () => handleScroll(mWheel, 'm'));
        }
        
        function handleScroll(el, type) {
            // Calculate center item
            const itemHeight = 40;
            // The container has 60px padding top, so center is scrollTop
            const index = Math.round(el.scrollTop / itemHeight);
            
            const val = String(index).padStart(2, '0');
            
            // Limit bounds
            if (type === 'h') {
                if(index >= 0 && index < 24) selectedHour = val;
            } else {
                if(index >= 0 && index < 60) selectedMinute = val;
            }
            
            // Highlight styling logic (optional, for opacity change)
            Array.from(el.children).forEach((child, i) => {
                if (child.classList.contains('wheel-item') && child.dataset.val) {
                   // REMOVED -1 offset because pad divs are gone
                   if (i === index) { 
                       child.style.color = '#1d4ed8'; // blue-700
                       child.style.transform = 'scale(1.1)';
                   } else {
                       child.style.color = '#94a3b8'; // gray-400
                       child.style.transform = 'scale(1)';
                   }
                }
            });
        }
        
        function scrollToTime(h, m) {
            const hWheel = document.getElementById('hour-wheel');
            const mWheel = document.getElementById('minute-wheel');
            const itemHeight = 40;
            
            hWheel.scrollTop = parseInt(h) * itemHeight;
            mWheel.scrollTop = parseInt(m) * itemHeight;
            
            selectedHour = h;
            selectedMinute = m;
        }

        // --- NEW LOGIN FLOW ---
        window.verifyCodeAndShowMenu = () => {
            const code = document.getElementById('employee-code').value;
            const messageElement = document.getElementById('punch-message');
            messageElement.textContent = "";
            
            if(code.length !== 4) return;
            
            const emp = employees.find(e => e.code === code);
            
            if(!emp) { 
                messageElement.textContent = "Code inconnu"; 
                messageElement.className = "text-center mt-4 text-sm font-medium h-6 text-red-600"; 
                return; 
            }
            
            // Valid Employee
            currentEmployee = emp;
            
            // Reset UI for Dashboard
            document.getElementById('dashboard-welcome').textContent = `Bonjour ${emp.name}`;
            
            // Check status to update Punch Button Text (In or Out)
            updatePunchButtonStatus(emp.code);
            
            // Switch Step
            document.getElementById('step-login').classList.add('hidden');
            document.getElementById('step-dashboard').classList.remove('hidden');
        };

        // Helper to update button text based on status
        async function updatePunchButtonStatus(code) {
             const btnText = document.getElementById('btn-punch-text');
             const btnSub = document.getElementById('btn-punch-sub');
             const btnIcon = document.getElementById('btn-punch-icon');
             
             try {
                const s = await getDocs(query(getColRef('punches'), where('employeeCode', '==', code)));
                const active = s.docs.filter(d => d.data().punchOutTime === null)[0];
                
                if (active) {
                    btnText.textContent = "D√©pointer (D√©part)";
                    btnSub.textContent = "Vous √™tes actuellement pr√©sent";
                    btnIcon.classList.remove('bg-gray-100', 'text-gray-600');
                    btnIcon.classList.add('bg-orange-100', 'text-orange-600');
                } else {
                    btnText.textContent = "Pointer (Arriv√©e)";
                    btnSub.textContent = "Vous n'√™tes pas encore point√©";
                    btnIcon.classList.remove('bg-orange-100', 'text-orange-600');
                    btnIcon.classList.add('bg-green-100', 'text-green-600');
                }
             } catch(e) {
                 console.error(e);
             }
        }

        window.onMenuPunch = () => {
             // Reuse existing punch logic, but triggered from menu
             if (!currentEmployee) return;
             handlePunchLogic(currentEmployee);
        };

        window.onMenuHistory = () => {
            if (!currentEmployee) return;
            // Switch to History View
            document.getElementById('step-dashboard').classList.add('hidden');
            document.getElementById('step-history').classList.remove('hidden');
            
            // Render Table
            const today = new Date();
            renderTableHTML('employee-history-body', [currentEmployee], today.getFullYear(), today.getMonth() + 1);
        };

        window.resetToCodeEntry = () => {
            currentEmployee = null;
            document.getElementById('employee-code').value = '';
            document.getElementById('step-login').classList.remove('hidden');
            document.getElementById('step-dashboard').classList.add('hidden');
            document.getElementById('step-history').classList.add('hidden');
        };

        // RENAMED old handlePunch to handlePunchLogic to be called by menu
        window.handlePunchLogic = async (emp) => {
            try {
                const s = await getDocs(query(getColRef('punches'), where('employeeCode', '==', emp.code)));
                const active = s.docs.filter(d=>d.data().punchOutTime===null).sort((a,b)=>b.data().punchInTime.toMillis()-a.data().punchInTime.toMillis())[0];
                if(active) openManualTimeModal('OUT', emp, active); else openManualTimeModal('IN', emp, null);
            } catch(e) { console.error(e); }
        };
        
        // Keep generic handlePunch for backward compatibility if button remains, but we changed the button onclick
        window.handlePunch = () => { verifyCodeAndShowMenu(); };

        window.openManualTimeModal = (mode, employee, punchDoc) => {
            currentPunchMode = mode; currentManualEmployee = employee; currentManualPunchDoc = punchDoc;
            const modal = document.getElementById('manual-time-modal');
            const title = document.getElementById('manual-time-title');
            const dateInput = document.getElementById('manual-punch-date');
            const now = new Date();
            
            // --- NIGHT SHIFT LOGIC (Default Date) ---
            // If it is between 00:00 and 03:00, default date is Yesterday
            const effectiveDate = new Date(now);
            if (now.getHours() < 3) {
                effectiveDate.setDate(effectiveDate.getDate() - 1);
            }
            
            // FIX: Use local date string instead of UTC-based toISOString
            dateInput.value = getLocalDateInputValue(effectiveDate);
            
            // Scroll wheels to now (Real time)
            const h = String(now.getHours()).padStart(2, '0');
            const m = String(now.getMinutes()).padStart(2, '0');
            // We need a small timeout to let modal render before scrolling
            setTimeout(() => scrollToTime(h, m), 50);

            if (mode === 'IN') { title.textContent = `Bonjour ${employee.name} (Arriv√©e)`; }
            else { title.textContent = `Au revoir ${employee.name} (D√©part)`; }
            
            modal.classList.remove('hidden'); modal.classList.add('flex');
        };

        window.closeManualTimeModal = () => { document.getElementById('manual-time-modal').classList.add('hidden'); document.getElementById('manual-time-modal').classList.remove('flex'); currentPunchMode = null; };
        
        window.adjustBreakRed = (amount) => { const input = document.getElementById('red-punch-break'); let val = parseInt(input.value) || 0; val = Math.max(0, val + amount); input.value = val; };
        
        window.setManualToNow = () => { 
            const now = new Date(); 
            // NIGHT SHIFT LOGIC (Button)
            const effectiveDate = new Date(now);
            if (now.getHours() < 3) {
                effectiveDate.setDate(effectiveDate.getDate() - 1);
            }
            // FIX: Use local date
            document.getElementById('manual-punch-date').value = getLocalDateInputValue(effectiveDate);
            scrollToTime(String(now.getHours()).padStart(2,'0'), String(now.getMinutes()).padStart(2,'0')); 
        };

        window.confirmManualPunch = async () => {
            if (!currentManualEmployee) return;
            const dateStr = document.getElementById('manual-punch-date').value;
            // Get time from global vars updated by scroll
            const timeStr = `${selectedHour}:${selectedMinute}`;
            if (!dateStr) { alert("Date requise."); return; }
            
            // FIX: Manual construction of Date to avoid UTC shift issues
            const [y, mo, d] = dateStr.split('-').map(Number);
            const [h, mi] = timeStr.split(':').map(Number);
            const dateTime = new Date(y, mo - 1, d, h, mi);
            
            // --- NIGHT SHIFT LOGIC (Timestamp Construction) ---
            // If the user selected "Yesterday" (because h<3), but the Time is < 3am, 
            // we need to add 1 day to the physical timestamp so it matches reality.
            // Example: Today is Tuesday 01:00. DatePicker defaults to Monday. TimePicker is 01:00.
            // dateTime becomes Monday 01:00. This is 24h ago.
            // We want the timestamp to be Tuesday 01:00 (Reality).
            if (h < 3) {
                 dateTime.setDate(dateTime.getDate() + 1);
            }

            // TEMP SAVE for OUT
            tempPunchDate = dateTime;

            try {
                if (currentPunchMode === 'IN') { 
                    // Direct Save for IN
                    const docRef = await addDoc(getColRef('punches'), { employeeCode: currentManualEmployee.code, employeeName: currentManualEmployee.name, punchInTime: Timestamp.fromDate(dateTime), punchOutTime: null, breakDuration: 0 }); 
                    closeManualTimeModal();
                    resetToCodeEntry();
                    showSuccessModal(`Bonjour ${currentManualEmployee.name} ! Pointage enregistr√©.`, docRef.id); 
                }
                else if (currentPunchMode === 'OUT' && currentManualPunchDoc) { 
                    // NEW FLOW: Close time modal, Open break modal
                    closeManualTimeModal();
                    openBreakModal();
                }
                
            } catch (e) { console.error("Erreur pointage manuel:", e); alert("Erreur: " + e.message); }
        };

        // NEW: Open Red Break Modal
        window.openBreakModal = () => {
            const modal = document.getElementById('break-selection-modal');
            // Reset value
            document.getElementById('red-punch-break').value = 0;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        // NEW: Confirm Break and Final Save
        window.confirmBreak = async () => {
            const breakDuration = parseInt(document.getElementById('red-punch-break').value) || 0;
            const modal = document.getElementById('break-selection-modal');
            
            try {
                // Perform the Update
                await updateDoc(currentManualPunchDoc.ref, { punchOutTime: Timestamp.fromDate(tempPunchDate), breakDuration: breakDuration });
                
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                
                resetToCodeEntry();
                showSuccessModal(`Au revoir ${currentManualEmployee.name} ! D√©pointage enregistr√©.`, currentManualPunchDoc.id);

            } catch(e) {
                 console.error("Erreur break save:", e); 
                 alert("Erreur: " + e.message); 
            }
        };

        // DEPRECATED displayEmployeeStatus - Removed logic calling this
        async function displayEmployeeStatus(emp) { /* Empty */ }

        window.addEmployee = async () => { const n=document.getElementById('new-employee-name').value, c=document.getElementById('new-employee-code').value; if(n&&c.length===4) try{ await addDoc(getColRef('employees'), {name:n, code:c}); document.getElementById('new-employee-name').value=''; document.getElementById('new-employee-code').value=''; }catch(e){} };
        window.deleteEmployee = async (id, name) => { if(confirm(`Del ${name}?`)) await deleteDoc(getDocRef('employees', id)); };
        function renderEmployeeTable() { const b = document.getElementById('employee-table-body'); b.innerHTML=''; employees.forEach(e=>{ b.innerHTML+=`<tr class="hover:bg-gray-50"><td class="px-6 py-3">${e.name}</td><td class="px-6 py-3">${e.code}</td><td class="px-6 py-3"><button onclick="deleteEmployee('${e.id}','${e.name}')" class="text-red-600">Supprimer</button></td></tr>`; }); }
        
        // OLD renderPunchTable - not used for main display anymore, logic moved to preview
        function renderPunchTable() { /* kept empty or remove */ }
    </script>
</body>
</html>
